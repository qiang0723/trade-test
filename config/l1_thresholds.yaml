# L1 Advisory Layer - 阈值配置文件
# 所有阈值都是保守起点，需要通过回测优化

# ==================
# PR-010: Symbol Universe（币种宇宙）
# ==================
symbol_universe:
  # 支持的币种列表（合约市场）
  enabled_symbols:
    - BTC    # Bitcoin
    - ETH    # Ethereum
    - SOL    # Solana
    - TA     # TA
    - AT     # AT
    - HANA   # HANA
    - BTR    # BTR
    - GPS    # GPS
    - RIVER  # RIVER
  
  # 默认币种（前端初始化）
  default_symbol: BTC

# ==================
# 定时更新配置（整合自 monitored_symbols.yaml）
# ==================
periodic_update:
  enabled: true          # 是否启用定时更新
  interval_minutes: 1    # 更新间隔（分钟）
  market_type: futures   # 市场类型: futures 或 spot

# ==================
# 数据保留策略（整合自 monitored_symbols.yaml）
# ==================
data_retention:
  keep_hours: 24         # 保留最近24小时的数据
  cleanup_interval_hours: 6  # 每6小时清理一次

# ==================
# 错误处理（整合自 monitored_symbols.yaml）
# ==================
error_handling:
  max_retries: 3         # API调用失败时最大重试次数
  retry_delay_seconds: 5 # 重试延迟（秒）
  continue_on_error: true  # 单个symbol失败时继续处理其他symbol

# ==================
# 数据质量阈值
# ==================
data_quality:
  max_staleness_seconds: 120      # 数据最大过期时间（秒），超过视为过期

# ==================
# 决策频率控制（PR-C）
# ==================
decision_control:
  # 最小决策间隔（秒）- 防止短时间内重复建议
  min_decision_interval_seconds: 300  # 5分钟
  
  # 翻转冷却时间（秒）- 防止LONG<->SHORT频繁切换
  flip_cooldown_seconds: 600  # 10分钟
  
  # 功能开关
  enable_min_interval: true
  enable_flip_cooldown: true

# ==================
# 市场环境识别阈值 - P2优化：降低TREND阈值便于捕捉趋势
# ==================
market_regime:
  extreme_price_change_1h: 0.07   # 1小时价格变化 > 7% → EXTREME（提高，减少EXTREME拒绝）
  trend_price_change_6h: 0.02     # 6小时价格变化 > 2% → TREND（优化前3%，降低33%）
  short_term_trend_1h: 0.015      # 1小时价格变化 > 1.5% → 短期TREND（优化前2%）

# ==================
# 风险准入阈值
# ==================
risk_exposure:
  # 清算阶段检测
  liquidation:
    price_change: 0.05            # 价格变化阈值（小数格式：0.05=5%）
    oi_drop: -0.15                # OI下降阈值（小数格式：-0.15=-15%）
  
  # 拥挤风险检测
  crowding:
    funding_abs: 0.001            # 费率绝对值阈值（小数格式：0.001=0.1%）
    oi_growth: 0.30               # 6h OI增长阈值（小数格式：0.30=30%）
  
  # 极端成交量检测
  extreme_volume:
    multiplier: 10.0              # 1h成交量超过24h均值的倍数

# ==================
# 交易质量阈值
# ==================
trade_quality:
  # 吸纳风险
  absorption:
    imbalance: 0.7                # 买卖失衡阈值
    volume_ratio: 0.5             # 成交量比例（相对于24h均值）
  
  # 噪音市场
  noise:
    funding_volatility: 0.0005    # 费率波动阈值（0.05%）
    funding_abs: 0.0001           # 当前费率阈值（0.01%）
  
  # 轮动风险
  rotation:
    price_threshold: 0.02         # 价格变化阈值（小数格式：0.02=2%）
    oi_threshold: 0.05            # OI变化阈值（小数格式：0.05=5%）
  
  # 震荡市弱信号
  range_weak:
    imbalance: 0.6                # 失衡阈值（-1到1范围）
    oi: 0.10                      # OI变化阈值（小数格式：0.10=10%）

# ==================
# 方向评估阈值 - 折中方案：目标30-50笔交易
# ==================
direction:
  # 趋势市
  trend:
    long:
      imbalance: 0.12             # 买卖失衡阈值
      oi_change: 0.02             # 1h OI增长阈值
      price_change: 0.004         # 1h价格上涨阈值
    short:
      imbalance: 0.12             # 买卖失衡阈值
      oi_change: 0.02             # 1h OI增长阈值
      price_change: 0.004         # 1h价格下跌阈值
  
  # 震荡市
  range:
    long:
      imbalance: 0.15             # 失衡要求
      oi_change: 0.025            # OI增长要求
    short:
      imbalance: 0.15             # 失衡要求
      oi_change: 0.025            # OI增长要求
    
    # 短期机会识别 - 3选1确认
    short_term_opportunity:
      long:
        min_price_change_1h: 0.005      # 1小时涨幅 > 0.5%
        min_oi_change_1h: 0.03          # OI增长 > 3%
        min_taker_imbalance: 0.12       # PATCH-P0-05: 新键名（买压 > 12%）
        min_buy_sell_imbalance: 0.12    # DEPRECATED: 旧键名（兼容）
        required_signals: 1             # 3选1
      short:
        max_price_change_1h: -0.005     # 1小时跌幅 < -0.5%
        min_oi_change_1h: 0.03          # OI增长 > 3%
        max_taker_imbalance: -0.12      # PATCH-P0-05: 新键名（卖压 < -12%）
        max_buy_sell_imbalance: -0.12   # DEPRECATED: 旧键名（兼容）
        required_signals: 1             # 3选1

# ==================
# 置信度配置（PR-D混合模式）
# ==================
confidence_scoring:
  # 基础分（保持现有评分体系）
  decision_score: 30               # 决策类型分（LONG/SHORT=30, NO_TRADE=0）
  regime_trend_score: 30           # TREND环境分
  regime_range_score: 10           # RANGE环境分
  regime_extreme_score: 0          # EXTREME环境分
  quality_good_score: 30           # GOOD质量分
  quality_uncertain_score: 15      # UNCERTAIN质量分（降级）
  quality_poor_score: 0            # POOR质量分
  strong_signal_bonus: 10          # 强信号加分
  
  # 档位映射（保持现有）
  thresholds:
    ultra: 90                      # >=90分 → ULTRA
    high: 65                       # >=65分 → HIGH
    medium: 40                     # >=40分 → MEDIUM
  
  # 硬降级上限（caps）- 方案D修订：调整为HIGH以配合ALLOW_REDUCED
  caps:
    # UNCERTAIN质量的上限（修订：MEDIUM → HIGH，使ALLOW_REDUCED可执行）
    uncertain_quality_max: "HIGH"  # HIGH 允许降级执行
    
    # PR-I: reduce_tags 的默认cap（避免忘配 tag_caps 导致过严）
    # 建议设置为 uncertain_quality_max 以保持一致性
    # 如果未配置，会自动回退到 uncertain_quality_max
    reduce_default_max: "HIGH"     # 默认值（可选，未配置时等于 uncertain_quality_max）
    
    # 特定ReasonTag的上限（修订：MEDIUM → HIGH，使ALLOW_REDUCED可执行）
    # 注意：显式配置的 tag_caps 会覆盖 reduce_default_max
    tag_caps:
      noisy_market: "HIGH"           # HIGH 允许降级执行
      weak_signal_in_range: "HIGH"   # HIGH 允许降级执行
  
  # 强信号突破
  strong_signal_boost:
    enabled: true                  # 是否启用
    boost_levels: 1                # 提升档数
    
    # 触发突破的标签
    required_tags:
      - strong_buy_pressure
      - strong_sell_pressure

# ==================
# ReasonTag分类规则（PR-D）
# ==================
reason_tag_rules:
  # 降级标签（触发cap）
  reduce_tags:
    - noisy_market
    - weak_signal_in_range
    - extreme_volume  # PR-007: 单独时降级（联立时仍DENY）
  
  # 否决标签（强制LOW）
  deny_tags:
    - liquidation_phase
    - crowding_risk
    # extreme_volume已移至reduce_tags（PR-007）
    - data_stale
    - extreme_regime
    - absorption_risk
    - rotation_risk

# ==================
# 执行控制（方案D：双门槛机制）
# ==================
executable_control:
  # ALLOW 的最低置信度要求（正常执行）
  min_confidence_normal: "HIGH"     # HIGH 或 ULTRA
  
  # ALLOW_REDUCED 的最低置信度要求（降级执行）
  min_confidence_reduced: "MEDIUM"  # MEDIUM/HIGH/ULTRA
  
  # 说明：
  # - ALLOW: 无降级标签，要求 HIGH/ULTRA
  # - ALLOW_REDUCED: 有DEGRADE标签（如NOISY_MARKET），要求 MEDIUM及以上
  # - DENY: 有BLOCK标签（如EXTREME_VOLUME），永远不可执行
  #
  # 配合 caps 上限：
  # - noisy_market → cap to HIGH → ALLOW_REDUCED + MEDIUM门槛 → executable=True ✓

# ==================
# 辅助标签阈值
# ==================
auxiliary_tags:
  # OI 变化阈值（辅助信息标签）- P0-3修复：使用DECIMAL格式
  oi_growing_threshold: 0.05     # 1h OI 增长 > 5% → OI_GROWING（小数格式：0.05=5%）
  oi_declining_threshold: -0.05  # 1h OI 下降 < -5% → OI_DECLINING（小数格式：-0.05=-5%）
  
  # 资金费率阈值（辅助信息标签）
  funding_rate_threshold: 0.0005  # 费率绝对值 > 0.05% → HIGH/LOW_FUNDING_RATE

# ==================
# PR-005: 多周期三层触发（1h/15m/5m）
# ==================
multi_tf:
  # 功能开关
  enabled: true
  
  # Layer 1: Context（1小时方向偏置）- P1优化：降低25%
  context_1h:
    # LONG方向Context
    long:
      min_price_change: 0.007     # 1h涨幅 > 0.7%（优化前1%）
      min_taker_imbalance: 0.30   # taker失衡 > 30%（优化前40%）
      min_oi_change: 0.035        # OI增长 > 3.5%（优化前5%）
      required_signals: 2         # 3选2
    
    # SHORT方向Context
    short:
      max_price_change: -0.007    # 1h跌幅 < -0.7%（优化前-1%）
      max_taker_imbalance: -0.30  # taker失衡 < -30%（优化前-40%）
      min_oi_change: 0.035        # OI增长 > 3.5%（优化前5%）
      required_signals: 2         # 3选2
  
  # Layer 2: Confirm（15分钟确认，4选2）- P1优化：降低25%
  confirm_15m:
    # LONG方向Confirm
    long:
      min_price_change: 0.003     # 15m涨幅 > 0.3%（优化前0.5%）
      min_taker_imbalance: 0.40   # taker失衡 > 40%（优化前50%）
      min_volume_ratio: 1.2       # 放量比率 > 1.2x（优化前1.5x）
      min_oi_change: 0.02         # OI增长 > 2%（优化前3%）
      required_confirmed: 2       # 4选2确认
      required_partial: 1         # 至少1个为部分
    
    # SHORT方向Confirm
    short:
      max_price_change: -0.003    # 15m跌幅 < -0.3%（优化前-0.5%）
      max_taker_imbalance: -0.40  # taker失衡 < -40%（优化前-50%）
      min_volume_ratio: 1.2       # 放量比率 > 1.2x（优化前1.5x）
      min_oi_change: 0.02         # OI增长 > 2%（优化前3%）
      required_confirmed: 2       # 4选2确认
      required_partial: 1         # 至少1个为部分
  
  # Layer 3: Trigger（5分钟触发，3选2）- P1优化：降低25%
  trigger_5m:
    # LONG方向Trigger
    long:
      min_price_change: 0.0015    # 5m涨幅 > 0.15%（优化前0.2%）
      min_taker_imbalance: 0.50   # taker失衡 > 50%（优化前60%）
      min_volume_ratio: 1.5       # 放量比率 > 1.5x（优化前2.0x）
      required_signals: 2         # 3选2触发
    
    # SHORT方向Trigger
    short:
      max_price_change: -0.0015   # 5m跌幅 < -0.15%（优化前-0.2%）
      max_taker_imbalance: -0.50  # taker失衡 < -50%（优化前-60%）
      min_volume_ratio: 1.5       # 放量比率 > 1.5x（优化前2.0x）
      required_signals: 2         # 3选2触发
  
  # 绑定策略
  binding_policy:
    # 短期机会是否要求CONFIRMED
    short_term_opportunity_requires_confirmed: true
    
    # PARTIAL的处理
    partial_action: "degrade"     # degrade/allow/deny
    
    # FAILED的处理
    failed_short_term_action: "cancel"    # 短期机会取消
    failed_long_term_action: "degrade"    # 长期信号降级保留

# ==================
# PR-DUAL: 双周期独立结论配置
# ==================
dual_timeframe:
  # 是否启用双周期输出
  enabled: true
  
  # 短期评估（5m/15m）阈值
  short_term:
    # 15分钟价格变化阈值（动态阈值，根据市场环境自动调整）
    # 平衡优化：适度提高阈值
    min_price_change_15m:
      dynamic: true                 # 启用动态阈值
      trend: 0.003                  # TREND环境: 0.3%
      range: 0.006                  # RANGE环境: 0.6%
      extreme: 0.012                # EXTREME环境: 1.2%
      default: 0.004                # 默认/降级: 0.4%
    
    # taker失衡阈值（买卖压力）
    min_taker_imbalance: 0.30      # 30%（中等水平）
    
    # 放量比率阈值
    min_volume_ratio: 1.3          # 1.3倍（中等水平）
    
    # OI变化阈值
    min_oi_change_15m: 0.02        # 2%（中等水平）
    
    # 满足信号数要求 - 5选3
    required_signals: 3            # 5维信号中至少3维满足
  
  # 中长期评估（1h/6h）复用 direction 配置
  # medium_term 使用现有的 direction.trend/range 配置
  
  # 冲突处理策略
  conflict_resolution:
    # 默认策略：no_trade / follow_medium_term / follow_short_term / follow_higher_confidence
    default_strategy: "no_trade"
    
    # 说明：
    # - no_trade: 冲突时保守不交易（默认，最安全）
    # - follow_medium_term: 跟随中长期趋势（适合趋势交易者）
    # - follow_short_term: 跟随短期信号（适合日内交易者）
    # - follow_higher_confidence: 跟随置信度更高的一方
  
  # 一致性加成
  alignment_bonus:
    # 双周期一致时，置信度提升
    confidence_boost: 1            # 提升1档（如 MEDIUM → HIGH）
    
    # 双周期一致时，是否放宽执行门槛
    relax_executable_threshold: false

# ==================
# 双周期决策频率控制（PR-DUAL）
# ==================
dual_decision_control:
  # 短期决策控制（5m/15m）
  short_term_interval_seconds: 300        # 最小决策间隔：5分钟
  short_term_flip_cooldown_seconds: 450   # 方向翻转冷却：7.5分钟（LONG ↔ SHORT）
  
  # 中长期决策控制（1h/6h）
  medium_term_interval_seconds: 1800      # 最小决策间隔：30分钟
  medium_term_flip_cooldown_seconds: 900  # 方向翻转冷却：15分钟（LONG ↔ SHORT）
  
  # 对齐类型翻转冷却
  alignment_flip_cooldown_seconds: 900    # 重大翻转冷却：15分钟（BOTH_LONG ↔ BOTH_SHORT）
  
  # 说明：
  # - NO_TRADE决策不受频率控制（允许随时输出）
  # - 翻转冷却时间应 >= 决策间隔时间
  # - 对齐类型仅阻断重大翻转（双向一致态互换）
