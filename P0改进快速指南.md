# P0改进快速指南 🚀

**日期**: 2026-01-23  
**状态**: ✅ 实施完成  
**目的**: 快速了解和验证P0改进  

---

## ⚡ 30秒了解P0改进

### 核心思想：数据诚实 + 独立评估

```
旧系统：缺数据 → 伪装成0 → 导致"无方向"假象
新系统：缺数据 → 显性标记 → 明确告知"数据不足"

旧系统：short缺数据 → medium也被短路
新系统：short和medium独立评估，互不影响
```

---

## 🎯 7个P0改进

| P0编号 | 名称 | 一句话说明 |
|--------|------|-----------|
| **P0-07** | 契约文档 | 定义输入格式和缺口策略 |
| **P0-01** | MTF None-safe | 中期缺数据不伪装成0 |
| **P0-02** | 兼容注入 | 旧字段自动转新字段 |
| **P0-05** | LTF None-safe | 短期缺数据不伪装成0 |
| **P0-03** | Dual独立 | short缺数据不掐medium |
| **P0-04** | pytest迁移 | 禁止print/exit，用assert |
| **P0-06** | 频率测试 | 密度sanity check |

---

## 🚀 快速验证（3步）

### Step 1: 安装pytest

```bash
pip install pytest
```

### Step 2: 运行P0验收测试

```bash
cd /Users/wangqiang/learning/trade-info

# 运行P0综合验收测试
pytest tests/test_p0_none_safe_validation.py -v

# 预期输出
# test_medium_term_missing_fields_explicit PASSED
# test_short_term_missing_fields_explicit PASSED
# test_buy_sell_imbalance_injection PASSED
# ... 12个测试全部PASSED
```

### Step 3: 查看决策密度

```bash
# 运行density测试，查看输出
pytest tests/test_p0_none_safe_validation.py::TestP0DecisionDensity -v -s

# 应该看到类似输出：
# [Decision Density] N=100
#   LONG: 15 (15.0%)
#   SHORT: 12 (12.0%)
#   NO_TRADE: 73 (73.0%)
#   Directional: 27.0%
#   Executable: 8.0%
```

---

## 📖 关键文档

### 必读
- **[输入口径契约](doc/输入口径契约与缺口策略.md)** - ⭐⭐⭐⭐⭐ 核心规范
- **[P0改进实施报告](doc/P0改进实施报告.md)** - ⭐⭐⭐⭐ 详细说明

### 参考
- **[Pytest迁移指南](doc/Pytest迁移指南.md)** - 测试迁移
- **[新架构开发指南](新架构开发指南.md)** - 开发规范

---

## 💡 常见场景示例

### 场景1: 冷启动（数据不足）

**旧行为**（问题）:
```
输入：price_change_1h缺失
处理：当作0处理
输出：decision=NO_TRADE（原因不明）
问题：用户不知道是缺数据还是真的无方向
```

**新行为**（P0-01修复）:
```
输入：price_change_1h缺失
处理：检测到缺失
输出：decision=NO_TRADE, reason_tags=[DATA_INCOMPLETE_MTF]
优势：明确告知"中期数据不足，等待数据积累"
```

### 场景2: 旧数据源（只有buy_sell_imbalance）

**旧行为**（问题）:
```
输入：只有buy_sell_imbalance=0.7
处理：新逻辑读taker_imbalance_1h（缺失）→ None→0
输出：无法触发LONG（0.0不满足阈值0.6）
问题：明明有强买压，但因字段迁移导致失效
```

**新行为**（P0-02修复）:
```
输入：只有buy_sell_imbalance=0.7
处理：兼容注入 → taker_imbalance_1h=0.7
输出：正常触发LONG
优势：向后兼容，旧数据源仍可工作
```

### 场景3: Dual短期缺数据

**旧行为**（问题）:
```
输入：short缺5m字段，medium完整（LONG信号强）
处理：检测short缺数据 → 立即返回双NO_TRADE
输出：short=NO_TRADE, medium=NO_TRADE
问题：medium本可输出LONG，被short短路了
```

**新行为**（P0-03修复）:
```
输入：short缺5m字段，medium完整
处理：short=NO_TRADE+DATA_INCOMPLETE_LTF
       medium=LONG（照常评估）
输出：short=NO_TRADE, medium=LONG
       alignment=PARTIAL_LONG
优势：不错过medium的有效信号
```

---

## ⚠️ 重要提醒

### 测试数据必须包含metadata

```python
# ❌ 错误（P0-04后不允许）
data = {
    'price_change_1h': 0.03,
}

# ✅ 正确
data = {
    'price_change_1h': 0.03,
    '_metadata': {
        'percentage_format': 'decimal'
    }
}
```

### 禁止使用默认值伪装缺失

```python
# ❌ 错误
price_change = data.get('price_change_1h', 0)

# ✅ 正确
price_change = self._num(data, 'price_change_1h')
if price_change is None:
    tags.append(ReasonTag.DATA_INCOMPLETE_MTF)
    return NO_TRADE
```

---

## 🎯 验证清单

运行测试前确认：

- [ ] ✅ pytest已安装: `pip install pytest`
- [ ] ✅ 在项目根目录: `cd /path/to/trade-info`
- [ ] ✅ 配置文件存在: `config/l1_thresholds.yaml`

运行测试：

- [ ] ✅ P0验收测试通过: `pytest tests/test_p0_none_safe_validation.py -v`
- [ ] ✅ 12个测试全部PASSED
- [ ] ✅ Decision density在合理区间（5%-80%）
- [ ] ✅ Executable density < Directional density

---

## 📞 问题排查

### 问题1: pytest未安装

```bash
# 错误信息
python3: No module named pytest

# 解决方案
pip install pytest
# 或
pip3 install pytest
```

### 问题2: 测试失败（import错误）

```bash
# 错误信息
ModuleNotFoundError: No module named 'market_state_machine_l1'

# 解决方案
# 确保在项目根目录运行
cd /Users/wangqiang/learning/trade-info
pytest tests/test_p0_none_safe_validation.py -v
```

### 问题3: density测试失败

```bash
# 可能原因
# 1. 配置文件阈值过严（导致全NO_TRADE）
# 2. 配置文件阈值过松（导致全LONG/SHORT）

# 解决方案
# 检查配置
cat config/l1_thresholds.yaml | grep -A 5 short_term

# 调整required_signals（如果需要）
dual_timeframe:
  short_term:
    required_signals: 4  # 调低会增加信号频率
```

---

## 🎊 完成标志

当看到以下输出，表示P0改进验证成功：

```
==================== test session starts ====================
tests/test_p0_none_safe_validation.py::TestP0NullSafeValidation::test_medium_term_missing_fields_explicit PASSED
tests/test_p0_none_safe_validation.py::TestP0NullSafeValidation::test_short_term_missing_fields_explicit PASSED
tests/test_p0_none_safe_validation.py::TestP0CompatibilityInjection::test_buy_sell_imbalance_injection PASSED
tests/test_p0_none_safe_validation.py::TestP0CompatibilityInjection::test_new_field_priority_over_legacy PASSED
tests/test_p0_none_safe_validation.py::TestP0DualIndependence::test_short_missing_medium_still_evaluates PASSED
tests/test_p0_none_safe_validation.py::TestP0DualIndependence::test_medium_missing_short_still_evaluates PASSED
tests/test_p0_none_safe_validation.py::TestP0DecisionDensity::test_short_term_decision_density PASSED
tests/test_p0_none_safe_validation.py::TestP0DecisionDensity::test_medium_term_decision_density PASSED
tests/test_p0_none_safe_validation.py::TestP0MetadataContract::test_decimal_format_with_metadata PASSED
tests/test_p0_none_safe_validation.py::TestP0MetadataContract::test_percent_point_format_with_metadata PASSED
tests/test_p0_none_safe_validation.py::TestP0MetadataContract::test_missing_metadata_warns PASSED

=============== 12 passed in X.XXs ===============
```

**恭喜！P0改进全部验证通过！** 🎉

---

**快速指南版本**: 1.0  
**创建日期**: 2026-01-23  
**适用版本**: v3.2+ (含P0改进)  
