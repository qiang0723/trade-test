#!/bin/bash

# L1 Advisory Layer - 完整测试套件运行脚本
# 用途：一键运行所有固化测试用例，确保代码质量

echo "================================================================================"
echo "L1 Advisory Layer - 完整测试套件"
echo "================================================================================"
echo ""

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 切换到项目根目录
cd "$(dirname "$0")/.."

# 统计变量
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# 测试函数
run_test() {
    local test_file=$1
    local test_name=$2
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    echo "--------------------------------------------------------------------------------"
    echo "测试 $TOTAL_TESTS: $test_name"
    echo "文件: $test_file"
    echo "--------------------------------------------------------------------------------"
    
    if python "$test_file" 2>&1; then
        PASSED_TESTS=$((PASSED_TESTS + 1))
        echo -e "${GREEN}✅ PASS${NC}: $test_name"
    else
        FAILED_TESTS=$((FAILED_TESTS + 1))
        echo -e "${RED}❌ FAIL${NC}: $test_name"
    fi
    
    echo ""
}

# 开始时间
START_TIME=$(date +%s)

echo "开始运行测试套件..."
echo ""

# ============================================================================
# 分类1: P0级别Bug修复测试
# ============================================================================
echo "================================================================================"
echo "分类1: P0级别Bug修复测试（4个）"
echo "================================================================================"
echo ""

run_test "tests/test_p0_percentage_scale_bugfix.py" "P0-BugFix-1: 百分比口径统一"
run_test "tests/test_p0_volume_scale_bugfix.py" "P0-BugFix-2: 成交量计算修正"
run_test "tests/test_p0_volume_unit_bugfix.py" "P0-BugFix-3: 单位一致性"
run_test "tests/test_p0_required_fields_bugfix.py" "P0-BugFix-4: 字段完整性"

# ============================================================================
# 分类2: 数据验证测试
# ============================================================================
echo "================================================================================"
echo "分类2: 数据验证测试（2个）"
echo "================================================================================"
echo ""

run_test "tests/test_data_validation_completeness.py" "数据验证: 字段完整性"
run_test "tests/test_data_validation_ranges.py" "数据验证: 数值合理性范围"

# ============================================================================
# 分类3: 配置和启动测试（如果存在）
# ============================================================================
if [ -f "tests/test_calibration_validation.py" ]; then
    echo "================================================================================"
    echo "分类3: 配置和启动测试"
    echo "================================================================================"
    echo ""
    
    run_test "tests/test_calibration_validation.py" "配置: 校准验证"
fi

# ============================================================================
# 结束统计
# ============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "================================================================================"
echo "测试完成"
echo "================================================================================"
echo ""
echo "总计: $TOTAL_TESTS 个测试"
echo -e "${GREEN}通过: $PASSED_TESTS${NC}"
if [ $FAILED_TESTS -gt 0 ]; then
    echo -e "${RED}失败: $FAILED_TESTS${NC}"
else
    echo "失败: 0"
fi
echo "耗时: ${DURATION}秒"
echo ""

# 返回状态
if [ $FAILED_TESTS -eq 0 ]; then
    echo -e "${GREEN}✅ 所有测试通过！${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}❌ 有测试失败，请检查！${NC}"
    echo ""
    exit 1
fi
