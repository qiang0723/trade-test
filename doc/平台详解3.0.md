# 加密货币交易决策平台详解 3.0

**版本**: 3.0  
**更新日期**: 2026-01-20  
**系统名称**: L1 Advisory Layer (交易决策咨询系统)  
**更新内容**: PR-B/C/D决策质量增强、频率控制、置信度混合模式、币种定制化

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [版本演进](#2-版本演进)
3. [核心功能](#3-核心功能)
4. [口径规范（PR-A修复）](#4-口径规范pr-a修复)
5. [PR-B: 质量语义钉死](#5-pr-b-质量语义钉死)
6. [PR-C: 决策频率控制](#6-pr-c-决策频率控制)
7. [PR-D: 置信度混合模式](#7-pr-d-置信度混合模式)
8. [决策管道](#8-决策管道)
9. [技术架构](#9-技术架构)
10. [配置管理](#10-配置管理)
11. [Web界面](#11-web界面)
12. [API接口](#12-api接口)
13. [部署架构](#13-部署架构)
14. [测试覆盖](#14-测试覆盖)
15. [使用指南](#15-使用指南)

---

## 1. 系统概述

### 1.1 系统定位

**L1 Advisory Layer** 是一个基于多维度市场数据的**交易决策咨询系统**，专注于为加密货币交易提供**安全、可追溯、高质量**的方向性建议。

**核心特点**：
- 🛡️ **Safety First**: 安全优先，多层闸门防护
- 🎯 **单一职责**: 仅输出方向决策（LONG/SHORT/NO_TRADE），不涉及执行
- 📊 **数据驱动**: 基于实时Binance合约市场数据
- 🔍 **可追溯性**: 每个决策都有明确的reason_tags和8步管道追溯
- ⚙️ **可配置**: 所有阈值外部化，支持热更新
- 🌐 **多币种**: 支持AIA、GPS、ETH等自定义币种
- 🚀 **生产就绪**: Docker容器化部署，AWS生产环境运行
- 🎚️ **精细控制**: ExecutabilityLevel三级控制、决策频率限制、置信度混合模式

### 1.2 系统边界

**L1做什么**：
- ✅ 数据质量验证（新鲜度、规范化）
- ✅ 分析市场环境（TREND/RANGE/EXTREME）
- ✅ 评估风险准入（清算/拥挤/极端成交量）
- ✅ 评估交易质量（GOOD/UNCERTAIN/POOR）
- ✅ 判断交易方向（LONG/SHORT/NO_TRADE）
- ✅ 决策频率控制（最小间隔、翻转冷却）
- ✅ 计算置信度（ULTRA/HIGH/MEDIUM/LOW + 混合模式）
- ✅ 提供执行许可（executable标志 + 三级控制）
- ✅ 决策管道追溯（8步可视化）

**L1不做什么**：
- ❌ 不输出仓位大小
- ❌ 不输出入场点位
- ❌ 不输出止损止盈
- ❌ 不计算杠杆倍数
- ❌ 不下单执行
- ❌ 不管理持仓

### 1.3 三层架构愿景

```
┌─────────────────────────────────────────┐
│  L1 Advisory Layer (✅ v3.0完成)         │
│  - 方向决策咨询                          │
│  - 安全闸门（风险+质量）                  │
│  - 4层置信度评估 + 混合模式               │
│  - 8步决策管道 + 频率控制                │
│  - 多币种支持 + ExecutabilityLevel       │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  L2 Selection Layer (规划中)             │
│  - 自动选币                              │
│  - 候选池管理                            │
│  - 多币种排序                            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  L3 Execution Layer (规划中)             │
│  - 自动交易                              │
│  - 仓位管理                              │
│  - 风控执行                              │
└─────────────────────────────────────────┘
```

---

## 2. 版本演进

### 2.1 版本对比

| 维度 | 1.0 | 2.0 | 3.0 (当前) |
|------|-----|-----|-----------|
| **配置口径** | ❌ 混用百分点/小数 | ❌ 混用百分点/小数 | ✅ **统一小数格式（修复系统性错误）** |
| **置信度档位** | 3档 (HIGH/MEDIUM/LOW) | 4档 (ULTRA/HIGH/MEDIUM/LOW) | 4档 + 混合模式 (基础加分+cap+boost) |
| **质量评级** | 2档 (GOOD/POOR) | 3档 (GOOD/UNCERTAIN/POOR) | 3档 + ExecutabilityLevel映射 |
| **决策控制** | 无 | 无 | ✅ 最小间隔(300s) + 翻转冷却(600s) |
| **ReasonTag** | 基础标签 | 统一规范 | ✅ ALLOW/DEGRADE/BLOCK三级控制 |
| **Confidence计算** | 简单加分 | 4层逻辑树 | ✅ 混合模式：加分+cap+boost |
| **方向触发** | ❌ 从未触发 | ❌ 从未触发 | ✅ **修复后首次触发LONG/SHORT** |
| **数据质量** | 基础验证 | 规范化+新鲜度 | 持续优化 |
| **多币种** | 单币种 | 5币种 | ✅ 自定义（AIA/GPS/ETH） |
| **前端界面** | 完整 | 市场数据概览 | ✅ 简洁版（删除市场数据） |
| **测试覆盖** | 基础 | 10个PR测试 | ✅ 18个PR测试（含口径验证+防回归） |
| **口径保护** | ❌ 无 | ❌ 无 | ✅ **启动时校验，拒绝百分点格式** |
| **部署** | 本地 | 本地+AWS | 本地+AWS |

### 2.2 v3.0核心升级

#### **2.2.0 PR-A口径问题修复（系统性错误）**

**问题发现**：
- 配置文件中百分比阈值混用**百分点格式**（5.0表示5%）和**小数格式**（0.05表示5%）
- MetricsNormalizer已将输入数据统一为小数格式
- 但配置阈值仍使用百分点格式
- **导致方向条件永远不触发的系统性错误**

**影响范围**：
```
数据层面: 0.05 (5%)
阈值层面: 5.0 (实际变成500%！)
结果: 0.05 < 5.0 → 条件永远不满足 → 方向评估永远不触发
```

**修复内容**：
| 配置项 | 修复前 | 修复后 | 说明 |
|--------|--------|--------|------|
| `extreme_price_change_1h` | 5.0 | 0.05 | 5% |
| `trend_price_change_6h` | 3.0 | 0.03 | 3% |
| `liquidation.price_change` | 5.0 | 0.05 | 5% |
| `liquidation.oi_drop` | -15.0 | -0.15 | -15% |
| `crowding.oi_growth` | 30.0 | 0.30 | 30% |
| `rotation.price_threshold` | 2.0 | 0.02 | 2% |
| `rotation.oi_threshold` | 5.0 | 0.05 | 5% |
| `range_weak.oi` | 10.0 | 0.10 | 10% |
| `direction.*.*.oi_change` | 5.0/10.0 | 0.05/0.10 | 5%/10% |
| `direction.*.*.price_change` | 1.0 | 0.01 | 1% |

**验证结果**（新增测试）：
```
✅ Test 1: 配置阈值使用小数格式
✅ Test 2: 数据规范化正确
✅ Test 3: 市场环境识别能正常触发（EXTREME/TREND/RANGE）
✅ Test 4: 方向评估能正常触发（LONG/SHORT）
✅ Test 5: 完整决策流程（首次成功触发LONG决策！）

关键验证:
强TREND+强LONG信号 → decision=LONG, confidence=ULTRA, executable=True
```

**口径规范（最终确定）**：
- **内部存储/计算**: 统一小数格式（0.05表示5%）
- **配置文件**: 统一小数格式 + 注释说明
- **MetricsNormalizer**: 自动转换百分点→小数
- **前端展示**: 可转换为百分比显示（如需要）

**重要性**：⚠️ 这是v3.0最关键的修复，解决了**v1.0/v2.0以来的系统性错误**！

---

#### **2.2.1 PR-B: TradeQuality语义钉死**
- **ExecutabilityLevel三级控制**: ALLOW（允许）、DEGRADE（降级）、BLOCK（阻断）
- **23个ReasonTag精细映射**: 每个标签明确定义执行等级
- **POOR质量硬短路**: 遇到POOR直接NO_TRADE，不可降级
- **UNCERTAIN质量降级执行**: 允许继续但置信度受限（≤MEDIUM）
- **executable综合判定**: 多维度判断（风险+标签+置信度+质量）

#### **2.2.2 PR-C: 决策频率控制**
- **DecisionMemory管理**: 多币种独立记忆，记录last_decision_time和last_decision_side
- **最小决策间隔**: 默认300秒，防止短时间重复建议
- **翻转冷却**: 默认600秒，防止LONG↔SHORT频繁切换
- **NO_TRADE不更新记忆**: 只有LONG/SHORT才会更新决策记忆
- **可配置开关**: 支持enable_min_interval和enable_flip_cooldown独立控制

#### **2.2.3 PR-D: Confidence混合模式**
- **三步流程**: 基础加分 → 应用cap → 强信号突破
- **硬降级上限（cap）**: UNCERTAIN质量≤MEDIUM，降级标签≤MEDIUM
- **强信号突破**: +1档但不可突破cap限制
- **配置化管理**: 基础分、阈值、cap规则、boost规则全部可配置
- **保留原有逻辑**: 不推翻PR-005的4档加分制，增量优化

#### **2.2.4 币种定制化**
- **从BTC等主流币改为**: AIA、GPS、ETH
- **默认币种**: AIA
- **币种数量**: 从5个缩减到3个
- **配置路径**: `config/l1_thresholds.yaml` → `symbol_universe`

#### **2.2.5 前端简化**
- **删除市场数据概览**: 移除价格、成交量、资金费率等8个数据卡片
- **聚焦核心功能**: 决策信号、安全闸门、原因标签、历史记录
- **代码优化**: 删除165行HTML/CSS/JS代码

---

## 3. 核心功能

### 3.1 功能列表

| 功能模块 | 子功能 | 状态 | 版本 |
|---------|--------|------|------|
| **数据验证** | 必需字段检查 | ✅ | v1.0 |
| | 指标规范化 | ✅ | v2.0 PR-001 |
| | 数据新鲜度检查 | ✅ | v2.0 PR-002 |
| **市场分析** | 环境识别(TREND/RANGE/EXTREME) | ✅ | v1.0 |
| **风险准入** | 极端行情 | ✅ | v1.0 |
| | 清算阶段检测 | ✅ | v1.0 |
| | 拥挤风险检测 | ✅ | v1.0 |
| | 极端成交量检测 | ✅ | v1.0 |
| **质量评估** | 吸纳风险 | ✅ | v1.0 |
| | 噪音市场 | ✅ | v2.0 PR-004 |
| | 轮动风险 | ✅ | v1.0 |
| | 震荡弱信号 | ✅ | v1.0 |
| | ExecutabilityLevel映射 | ✅ | v3.0 PR-B |
| **方向评估** | LONG条件判断 | ✅ | v1.0 |
| | SHORT条件判断 | ✅ | v1.0 |
| | 资金费率降级 | ✅ | v1.0 |
| **决策控制** | 最小决策间隔 | ✅ | v3.0 PR-C |
| | 翻转冷却 | ✅ | v3.0 PR-C |
| **置信度计算** | 4层档位 | ✅ | v2.0 PR-005 |
| | 混合模式(加分+cap+boost) | ✅ | v3.0 PR-D |
| **执行许可** | HIGH/ULTRA可执行 | ✅ | v2.0 PR-006 |
| | 综合判定(标签+质量) | ✅ | v3.0 PR-B |
| **可观测性** | Step Trace持久化 | ✅ | v2.0 PR-007 |
| | 决策管道可视化 | ✅ | v2.0 PR-009 |
| **数据管理** | 24h热存储 | ✅ | v2.0 PR-008 |
| **多币种** | Symbol Universe | ✅ | v2.0 PR-010 |
| | AIA/GPS/ETH定制 | ✅ | v3.0 |

---

## 4. 口径规范（PR-A修复）

### 4.1 问题背景

**历史遗留问题**（v1.0/v2.0）：
- PR-001实现了MetricsNormalizer，将输入数据统一为小数格式
- 但配置文件中的阈值仍使用百分点格式
- **导致阈值比较永远不成立**

**问题示例**：
```python
# 数据层面（已规范化）
data['price_change_1h'] = 0.05  # 5%（小数格式）

# 配置层面（未修复前）
thresholds['trend_price_change_6h'] = 3.0  # 实际变成300%！

# 比较结果
0.05 > 3.0  # False → 永远不触发TREND
```

**影响**：
- ❌ 市场环境识别异常（EXTREME/TREND永远不触发）
- ❌ 方向评估异常（LONG/SHORT永远不触发）
- ❌ 风险准入异常（清算/拥挤检测失效）
- ❌ 质量评估异常（轮动/弱信号检测失效）
- **结果**: 系统只会输出NO_TRADE，核心决策逻辑完全失效

### 4.2 修复方案

**统一口径原则**：
```
内部存储: 小数格式（0.05 = 5%）
配置文件: 小数格式（0.05 = 5%）
计算逻辑: 小数格式（0.05 > 0.03 = True）
前端展示: 百分比格式（5% = 0.05 × 100）
```

### 4.3 修复清单

#### 市场环境识别
```yaml
# 修复前
market_regime:
  extreme_price_change_1h: 5.0    # ❌ 百分点格式
  trend_price_change_6h: 3.0      # ❌ 百分点格式

# 修复后
market_regime:
  extreme_price_change_1h: 0.05   # ✅ 小数格式（5%）
  trend_price_change_6h: 0.03     # ✅ 小数格式（3%）
```

#### 风险准入阈值
```yaml
# 修复前
risk_exposure:
  liquidation:
    price_change: 5.0             # ❌ 百分点
    oi_drop: -15.0                # ❌ 百分点
  crowding:
    oi_growth: 30.0               # ❌ 百分点

# 修复后
risk_exposure:
  liquidation:
    price_change: 0.05            # ✅ 小数（5%）
    oi_drop: -0.15                # ✅ 小数（-15%）
  crowding:
    oi_growth: 0.30               # ✅ 小数（30%）
```

#### 交易质量阈值
```yaml
# 修复前
trade_quality:
  rotation:
    price_threshold: 2.0          # ❌ 百分点
    oi_threshold: 5.0             # ❌ 百分点
  range_weak:
    oi: 10.0                      # ❌ 百分点

# 修复后
trade_quality:
  rotation:
    price_threshold: 0.02         # ✅ 小数（2%）
    oi_threshold: 0.05            # ✅ 小数（5%）
  range_weak:
    oi: 0.10                      # ✅ 小数（10%）
```

#### 方向评估阈值（最关键）
```yaml
# 修复前
direction:
  trend:
    long:
      oi_change: 5.0              # ❌ 百分点
      price_change: 1.0           # ❌ 百分点
  range:
    long:
      oi_change: 10.0             # ❌ 百分点

# 修复后
direction:
  trend:
    long:
      oi_change: 0.05             # ✅ 小数（5%）
      price_change: 0.01          # ✅ 小数（1%）
  range:
    long:
      oi_change: 0.10             # ✅ 小数（10%）
```

### 4.4 验证结果

**新增测试**: `tests/test_decimal_calibration.py`

```
✅ Test 1: 配置阈值口径检查
  - 所有百分比阈值使用小数格式
  - extreme=0.05, trend=0.03, liquidation=0.05
  - oi_change=0.05, price_change=0.01

✅ Test 2: 数据规范化检查
  - 百分点输入自动转换: 5.0 → 0.05
  - 小数输入保持不变: 0.05 → 0.05

✅ Test 3: 市场环境识别触发
  - 6%变化 → EXTREME ✓
  - 4%变化(6h) → TREND ✓
  - 1%变化 → RANGE ✓

✅ Test 4: 方向评估触发
  - TREND+强多方 → allow_long=True ✓
  - TREND+强空方 → allow_short=True ✓
  - TREND+弱信号 → allow_long=False ✓

✅ Test 5: 完整决策流程
  - 强TREND+强LONG → decision=LONG ✓
  - confidence=ULTRA ✓
  - executable=True ✓
```

**关键证明**：
```
修复前: 所有决策都是NO_TRADE（方向条件从未触发）
修复后: 强信号可触发LONG/SHORT决策（系统正常工作）
```

### 4.5 防回归机制（启动校验）

**问题**：如何防止未来再次引入口径混用问题？

**解决方案**：启动时自动校验配置

#### 实现

```python
def _validate_decimal_calibration(self, config: dict):
    """
    启动时校验：检查配置口径是否为小数格式（防回归）
    
    校验逻辑：
    - 所有百分比阈值的绝对值应 < 1.0
    - 如果发现 >= 1.0 的值，认为是百分点格式
    - 拒绝启动并输出详细错误信息
    """
    errors = []
    
    # 检查market_regime、risk_exposure、trade_quality、direction
    # 发现错误立即收集
    
    if errors:
        # 格式化错误信息，包含：
        # 1. 配置路径（如 market_regime.extreme_price_change_1h）
        # 2. 当前值（如 5.0）
        # 3. 修复建议（如 应改为 0.05）
        raise ValueError(error_message)
    
    logger.info("✅ 配置口径校验通过：所有百分比阈值使用小数格式")
```

#### 校验时机

```python
def __init__(self, config_path: str = None):
    self.config = self._load_config(config_path)
    
    # ⚠️ 启动时校验：防止口径回归
    self._validate_decimal_calibration(self.config)  # 👈 这里拦截
    
    self.thresholds = self._flatten_thresholds(self.config)
    # ...
```

#### 错误示例

```
================================================================================
⚠️  配置口径错误检测（Decimal Calibration Validation Failed）
================================================================================
发现疑似使用百分点格式的阈值配置，系统拒绝启动！

错误项：
  ❌ market_regime.extreme_price_change_1h = 5.0 (疑似百分点格式，应使用小数格式，如 0.05 表示 5%)
  ❌ direction.trend.long.oi_change = 5.0 (疑似百分点格式，应使用小数格式，如 0.05 表示 5%)
  ❌ risk_exposure.liquidation.oi_drop = -15.0 (疑似百分点格式，应使用小数格式，如 0.05 表示 5%)

修复方法：
  1. 打开配置文件: config/l1_thresholds.yaml
  2. 将所有百分比阈值改为小数格式:
     - 错误: 5.0 (百分点)
     - 正确: 0.05 (小数，表示5%)
  3. 参考文档: doc/平台详解3.0.md 第4章（口径规范）
================================================================================
```

#### 测试覆盖

**测试文件**: `tests/test_calibration_validation.py` - **4/4通过** ✅

```python
✅ Test 1: 正确小数格式通过
  - 当前配置使用小数格式 → 正常启动 ✓

✅ Test 2: 百分点格式被拦截
  - extreme_price_change_1h: 5.0 → ValueError ✓
  - trend_price_change_6h: 3.0 → ValueError ✓

✅ Test 3: 方向阈值错误被拦截
  - direction.trend.long.oi_change: 5.0 → ValueError ✓
  - direction.trend.long.price_change: 1.0 → ValueError ✓
  - direction.range.long.oi_change: 10.0 → ValueError ✓

✅ Test 4: 多项错误全部报告
  - 8个基础错误同时检测 ✓
  - 错误信息包含配置路径和具体数值 ✓
```

**保护效果**：
- ✅ 任何人修改配置文件引入百分点格式 → 启动失败
- ✅ 错误信息清晰，直接定位问题
- ✅ 修复建议明确，降低沟通成本
- ✅ 从根本上杜绝口径回归风险

### 4.6 重要性评估

⚠️ **这是v3.0最关键的修复！**

**严重程度**: 🔴 **致命级别**
- v1.0/v2.0的方向评估完全失效
- 所有LONG/SHORT决策从未被触发过
- 系统实际上只是个"永远NO_TRADE"的空壳

**修复影响**:
- ✅ 市场环境识别恢复正常
- ✅ 方向评估恢复正常
- ✅ **首次成功触发LONG/SHORT决策**
- ✅ 系统真正开始发挥作用
- ✅ **启动校验防止回归**

**经验教训**：
1. 口径统一必须在整个系统生命周期保持一致
2. 配置文件注释要明确说明格式（小数 vs 百分点）
3. 必须有端到端测试验证阈值触发逻辑
4. MetricsNormalizer与配置阈值必须同步修改
5. **启动时校验是防止回归的最后一道防线**

---

## 5. PR-B: 质量语义钉死

### 4.1 设计目标

**问题**：
- TradeQuality与executable的语义不清晰
- UNCERTAIN是否阻断执行存在歧义
- ReasonTag对执行的影响缺乏统一规则

**解决方案**：
1. 引入ExecutabilityLevel三级控制
2. POOR必须硬短路为NO_TRADE
3. UNCERTAIN允许降级执行但有上限
4. executable由多维度综合判定

### 4.2 ExecutabilityLevel定义

```python
class ExecutabilityLevel(Enum):
    ALLOW = "allow"      # 不影响执行
    DEGRADE = "degrade"  # 降级但允许（如NOISY_MARKET）
    BLOCK = "block"      # 阻断执行（如LIQUIDATION_PHASE）
```

### 4.3 ReasonTag映射规则

| ReasonTag | Level | 说明 |
|-----------|-------|------|
| **数据验证** |
| INVALID_DATA | BLOCK | 数据无效 |
| DATA_STALE | BLOCK | 数据过期 |
| **风险否决类** |
| EXTREME_REGIME | BLOCK | 极端行情 |
| LIQUIDATION_PHASE | BLOCK | 清算阶段 |
| CROWDING_RISK | BLOCK | 拥挤风险 |
| EXTREME_VOLUME | BLOCK | 极端成交量 |
| **质量否决类** |
| ABSORPTION_RISK | BLOCK | 吸纳风险（POOR） |
| ROTATION_RISK | BLOCK | 轮动风险（POOR） |
| NOISY_MARKET | DEGRADE | 噪音市场（UNCERTAIN） |
| WEAK_SIGNAL_IN_RANGE | DEGRADE | 震荡弱信号（UNCERTAIN） |
| **方向冲突类** |
| CONFLICTING_SIGNALS | BLOCK | 信号冲突 |
| NO_CLEAR_DIRECTION | BLOCK | 方向不明 |
| **状态机约束类** |
| COOL_DOWN_ACTIVE | BLOCK | 冷却期 |
| STATE_TRANSITION_DENIED | BLOCK | 状态约束 |
| MIN_INTERVAL_BLOCK | BLOCK | 间隔过短（PR-C） |
| FLIP_COOLDOWN_BLOCK | BLOCK | 翻转冷却（PR-C） |
| **辅助信息类** |
| HIGH_FUNDING_RATE | ALLOW | 高资金费率 |
| LOW_FUNDING_RATE | ALLOW | 低资金费率 |
| STRONG_BUY_PRESSURE | ALLOW | 强买压 |
| STRONG_SELL_PRESSURE | ALLOW | 强卖压 |
| OI_GROWING | ALLOW | 持仓增长 |
| OI_DECLINING | ALLOW | 持仓下降 |

### 4.4 质量评级与置信度关系

```
GOOD质量:
  - 置信度: 无限制（可达ULTRA）
  - executable: 取决于置信度和标签

UNCERTAIN质量:
  - 置信度: ≤ MEDIUM（硬上限）
  - executable: 可以为True（如果HIGH且无BLOCK标签）
  - ReasonTag: NOISY_MARKET或WEAK_SIGNAL_IN_RANGE

POOR质量:
  - 决策: 硬短路为NO_TRADE
  - executable: 强制False
  - ReasonTag: ABSORPTION_RISK或ROTATION_RISK
```

### 4.5 executable综合判定逻辑

```python
def compute_executable(self) -> bool:
    # 1. 决策必须是LONG或SHORT
    if self.decision == Decision.NO_TRADE:
        return False
    
    # 2. 风险必须通过
    if not self.risk_exposure_allowed:
        return False
    
    # 3. PR-B: 检查阻断性标签
    if has_blocking_tags(self.reason_tags):
        return False
    
    # 4. 置信度必须达标（ULTRA或HIGH）
    if self.confidence not in [Confidence.ULTRA, Confidence.HIGH]:
        return False
    
    # 5. 质量不能是POOR（理论上已在阻断标签中排除）
    if self.trade_quality == TradeQuality.POOR:
        return False
    
    return True
```

### 4.6 辅助函数

```python
def has_blocking_tags(reason_tags: list) -> bool:
    """检查是否有阻断性标签"""
    return any(
        REASON_TAG_EXECUTABILITY.get(tag, ExecutabilityLevel.ALLOW) == ExecutabilityLevel.BLOCK
        for tag in reason_tags
    )

def has_degrading_tags(reason_tags: list) -> bool:
    """检查是否有降级标签"""
    return any(
        REASON_TAG_EXECUTABILITY.get(tag, ExecutabilityLevel.ALLOW) == ExecutabilityLevel.DEGRADE
        for tag in reason_tags
    )
```

### 4.7 测试覆盖

```
✅ Test 1: ExecutabilityLevel映射正确性
✅ Test 2: has_blocking_tags函数
✅ Test 3: has_degrading_tags函数
✅ Test 4: POOR质量硬短路
✅ Test 5: UNCERTAIN质量降级
✅ Test 6: 降级标签限制置信度上限
✅ Test 7: executable综合判定
```

---

## 5. PR-C: 决策频率控制

### 5.1 设计目标

**问题**：
- L1是咨询层，不应维护复杂持仓/ACTIVE/CLOSE状态
- 但需要防止短时间内重复给建议或方向频繁翻转

**解决方案**：
1. 最小决策间隔（Min Decision Interval）
2. 翻转冷却（Flip Cooldown）
3. 极简记忆管理（只记录时间和方向）

### 5.2 DecisionMemory设计

```python
class DecisionMemory:
    """决策记忆管理"""
    
    def __init__(self):
        self._memory = {}  # {symbol: {"time": datetime, "side": Decision}}
    
    def get_last_decision(self, symbol: str) -> Optional[Dict]:
        """获取指定币种的上次决策记录"""
        return self._memory.get(symbol)
    
    def update_decision(self, symbol: str, decision: Decision, timestamp: datetime):
        """更新决策记忆（仅LONG/SHORT）"""
        if decision in [Decision.LONG, Decision.SHORT]:
            self._memory[symbol] = {"time": timestamp, "side": decision}
```

**关键设计**：
- **多币种独立**: 每个symbol独立记忆
- **NO_TRADE不更新**: 只有LONG/SHORT才更新记忆
- **轻量级**: 只记录2个字段（time, side）

### 5.3 最小决策间隔

**规则**：
```
IF 距离上次输出LONG/SHORT未超过min_decision_interval_seconds:
    本次直接输出NO_TRADE（原因：MIN_INTERVAL_BLOCK）
```

**示例**：
```
T0: LONG决策输出，记录时间
T0+2min: 尝试LONG → 被阻断 → NO_TRADE (MIN_INTERVAL_BLOCK)
T0+6min: 尝试LONG → 通过（超过5分钟）
```

**配置**：
```yaml
decision_control:
  min_decision_interval_seconds: 300  # 5分钟
  enable_min_interval: true
```

### 5.4 翻转冷却

**规则**：
```
IF 本次方向与上次非NO_TRADE方向相反:
    AND 间隔未超过flip_cooldown_seconds:
        本次输出NO_TRADE（原因：FLIP_COOLDOWN_BLOCK）
```

**示例**：
```
T0: LONG决策输出
T0+3min: 尝试SHORT → 被阻断 → NO_TRADE (FLIP_COOLDOWN_BLOCK)
T0+11min: 尝试SHORT → 通过（超过10分钟）
```

**配置**：
```yaml
decision_control:
  flip_cooldown_seconds: 600  # 10分钟
  enable_flip_cooldown: true
```

### 5.5 决策流程集成

在决策管道的Step 7插入频率控制：

```
Step 1: 数据验证
Step 2: 市场环境识别
Step 3: 风险准入评估
Step 4: 交易质量评估
Step 5: 方向评估
Step 6: 决策优先级判断
Step 7: 决策频率控制 ← 新增（PR-C）
Step 8: 构造结果
```

```python
def _apply_decision_control(
    self, symbol: str, decision: Decision, 
    reason_tags: List[ReasonTag], timestamp: datetime
) -> Tuple[Decision, List[ReasonTag]]:
    control_tags = []
    
    if decision == Decision.NO_TRADE:
        return decision, control_tags
    
    last = self.decision_memory.get_last_decision(symbol)
    if last is None:
        return decision, control_tags
    
    elapsed = (timestamp - last['time']).total_seconds()
    
    # 检查1: 最小决策间隔
    if enable_min_interval and elapsed < min_interval:
        control_tags.append(ReasonTag.MIN_INTERVAL_BLOCK)
        return Decision.NO_TRADE, control_tags
    
    # 检查2: 翻转冷却
    if enable_flip_cooldown:
        is_flip = (decision != last['side'])
        if is_flip and elapsed < flip_cooldown:
            control_tags.append(ReasonTag.FLIP_COOLDOWN_BLOCK)
            return Decision.NO_TRADE, control_tags
    
    return decision, control_tags
```

### 5.6 新增ReasonTag

```python
# 决策频率控制类（PR-C）
MIN_INTERVAL_BLOCK = "min_interval_block"
FLIP_COOLDOWN_BLOCK = "flip_cooldown_block"

# 中文解释
"min_interval_block": "⏱️ 间隔过短：距离上次决策时间过短，防止频繁输出"
"flip_cooldown_block": "🔄 翻转冷却：方向翻转冷却期内，防止频繁切换"
```

### 5.7 测试覆盖

```
✅ Test 1: DecisionMemory基本功能
✅ Test 2: 最小间隔阻断
✅ Test 3: 翻转冷却阻断
✅ Test 4: 禁用控制功能
```

---

## 6. PR-D: 置信度混合模式

### 6.1 设计目标

**问题**：
- PR-005的纯加分制可能让UNCERTAIN+TREND+强信号达到ULTRA（不合理）
- PR-B的降级标签已经限制，但PR-D需要更系统的cap机制
- 震荡市+强信号应该有突破能力（不被短板完全压死）

**解决方案**：
1. 保留现有4档加分制（不推翻PR-005）
2. 新增硬降级上限（caps）
3. 新增强信号突破（boost）
4. 三步流程：加分 → cap → boost

### 6.2 三步流程

```
Step 1: 基础加分
  - decision_score: 30分（LONG/SHORT）
  - regime_score: TREND=30, RANGE=10, EXTREME=0
  - quality_score: GOOD=30, UNCERTAIN=15, POOR=0
  - strong_signal_bonus: 10分
  - 总分映射: ≥90→ULTRA, ≥65→HIGH, ≥40→MEDIUM, <40→LOW

Step 2: 应用cap（硬降级上限）
  - UNCERTAIN质量 → ≤MEDIUM
  - reduce_tags (NOISY_MARKET等) → ≤MEDIUM
  - deny_tags (LIQUIDATION_PHASE等) → LOW（已在Step 3短路）

Step 3: 强信号突破
  - 如果有STRONG_BUY_PRESSURE或STRONG_SELL_PRESSURE
  - 置信度+1档（但不可突破cap限制）
```

### 6.3 基础加分配置

```yaml
confidence_scoring:
  # 基础分
  decision_score: 30               # 决策类型分
  regime_trend_score: 30           # TREND环境分
  regime_range_score: 10           # RANGE环境分
  regime_extreme_score: 0          # EXTREME环境分
  quality_good_score: 30           # GOOD质量分
  quality_uncertain_score: 15      # UNCERTAIN质量分（降级）
  quality_poor_score: 0            # POOR质量分
  strong_signal_bonus: 10          # 强信号加分
  
  # 档位映射
  thresholds:
    ultra: 90                      # ≥90分 → ULTRA
    high: 65                       # ≥65分 → HIGH
    medium: 40                     # ≥40分 → MEDIUM
```

### 6.4 硬降级上限（caps）

```yaml
confidence_scoring:
  caps:
    # UNCERTAIN质量的上限
    uncertain_quality_max: "MEDIUM"
    
    # 特定ReasonTag的上限
    tag_caps:
      noisy_market: "MEDIUM"
      weak_signal_in_range: "MEDIUM"
```

**逻辑**：
```python
def _apply_confidence_caps(
    self, confidence: Confidence, quality: TradeQuality, reason_tags: List[ReasonTag]
) -> Tuple[Confidence, bool]:
    has_cap = False
    
    # 1. UNCERTAIN质量上限
    if quality == TradeQuality.UNCERTAIN:
        max_level = self._string_to_confidence("MEDIUM")
        if self._confidence_level(confidence) > self._confidence_level(max_level):
            confidence = max_level
            has_cap = True
    
    # 2. reduce_tags上限
    for tag in reason_tags:
        if tag.value in reduce_tags or tag.value in tag_caps:
            max_level = self._string_to_confidence(tag_caps.get(tag.value, "MEDIUM"))
            if self._confidence_level(confidence) > self._confidence_level(max_level):
                confidence = max_level
                has_cap = True
    
    return confidence, has_cap
```

### 6.5 强信号突破（boost）

```yaml
confidence_scoring:
  strong_signal_boost:
    enabled: true                  # 是否启用
    boost_levels: 1                # 提升档数
    
    # 触发突破的标签
    required_tags:
      - strong_buy_pressure
      - strong_sell_pressure
```

**逻辑**：
```python
def _apply_strong_signal_boost(
    self, confidence: Confidence, reason_tags: List[ReasonTag],
    cap_limit: Confidence, has_strong_signal: bool
) -> Confidence:
    if not has_strong_signal:
        return confidence
    
    # 提升1档
    boosted = self._boost_confidence(confidence, 1)
    
    # 不能突破cap
    if self._confidence_level(boosted) > self._confidence_level(cap_limit):
        return cap_limit
    
    return boosted
```

**关键**：
- 强信号可以+1档
- 但**不能突破cap限制**

### 6.6 示例场景

#### 场景1: TREND + GOOD + 强信号
```
基础加分: 30+30+30+10 = 100分 → ULTRA
应用cap: 无cap
强信号突破: 已是ULTRA，无需突破
最终: ULTRA
```

#### 场景2: TREND + UNCERTAIN + 强信号
```
基础加分: 30+30+15+10 = 85分 → HIGH
应用cap: UNCERTAIN → cap到MEDIUM
强信号突破: 尝试MEDIUM+1→HIGH，但被cap限制
最终: MEDIUM （不可突破cap）
```

#### 场景3: RANGE + GOOD + 强信号
```
基础加分: 30+10+30+10 = 80分 → HIGH
应用cap: 无cap
强信号突破: HIGH+1 → ULTRA （无cap时可突破）
最终: ULTRA
```

#### 场景4: TREND + GOOD + NOISY_MARKET
```
基础加分: 30+30+30+10 = 100分 → ULTRA
应用cap: NOISY_MARKET → cap到MEDIUM
强信号突破: 尝试MEDIUM+1→HIGH，但被cap限制
最终: MEDIUM
```

### 6.7 配置化管理

所有规则都可以通过`config/l1_thresholds.yaml`配置：

```yaml
# ==================
# 置信度配置（PR-D混合模式）
# ==================
confidence_scoring:
  # 基础分（保持现有评分体系）
  decision_score: 30
  regime_trend_score: 30
  regime_range_score: 10
  quality_good_score: 30
  quality_uncertain_score: 15
  strong_signal_bonus: 10
  
  # 档位映射
  thresholds:
    ultra: 90
    high: 65
    medium: 40
  
  # 硬降级上限
  caps:
    uncertain_quality_max: "MEDIUM"
    tag_caps:
      noisy_market: "MEDIUM"
      weak_signal_in_range: "MEDIUM"
  
  # 强信号突破
  strong_signal_boost:
    enabled: true
    boost_levels: 1
    required_tags:
      - strong_buy_pressure
      - strong_sell_pressure

# ==================
# ReasonTag分类规则（PR-D）
# ==================
reason_tag_rules:
  # 降级标签（触发cap）
  reduce_tags:
    - noisy_market
    - weak_signal_in_range
  
  # 否决标签（强制LOW）
  deny_tags:
    - liquidation_phase
    - crowding_risk
    - extreme_volume
    - data_stale
    - extreme_regime
    - absorption_risk
    - rotation_risk
```

### 6.8 测试覆盖

```
✅ Test 1: 基础加分制正常
✅ Test 2: UNCERTAIN质量上限生效
✅ Test 3: 降级标签上限生效
✅ Test 4: 强信号突破功能正常
✅ Test 5: 强信号无法突破cap
✅ Test 6: 置信度档位比较功能
✅ Test 7: 字符串转置信度功能
```

---

## 7. 决策管道

### 7.1 完整8步流程

```
┌─────────────────────────────────────────────────────────┐
│ Step 1: 数据验证 + 指标规范化 + 新鲜度检查              │
│  - 必需字段检查                                         │
│  - 百分比统一为小数格式                                 │
│  - 数据年龄检查（≤120秒）                               │
│  - 失败 → NO_TRADE + INVALID_DATA/DATA_STALE           │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 2: 市场环境识别                                     │
│  - EXTREME: 1h价格变化 > 5%                            │
│  - TREND: 6h价格变化 > 3%                              │
│  - RANGE: 其他情况（默认）                              │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: 风险准入评估（第一道闸门）                       │
│  - EXTREME行情 → 拒绝                                   │
│  - 清算阶段（价格急变+OI骤降）→ 拒绝                    │
│  - 拥挤风险（极端费率+高OI增长）→ 拒绝                  │
│  - 极端成交量（1h > 24h均值×10）→ 拒绝                 │
│  - 失败 → NO_TRADE + 风险标签                          │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 4: 交易质量评估（第二道闸门）                       │
│  - 吸纳风险 → POOR                                      │
│  - 噪音市场 → UNCERTAIN                                 │
│  - 轮动风险 → POOR                                      │
│  - 震荡弱信号 → UNCERTAIN                               │
│  - POOR → 硬短路为NO_TRADE（PR-B）                     │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 5: 方向评估（SHORT优先）                           │
│  - TREND市: 价格+失衡+OI综合判断                        │
│  - RANGE市: 更高阈值要求                                │
│  - 资金费率降级: HIGH→SHORT, LOW→LONG                   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 6: 决策优先级判断                                   │
│  - LONG&SHORT同时满足 → CONFLICTING_SIGNALS → NO_TRADE │
│  - 仅SHORT满足 → SHORT（优先级高）                      │
│  - 仅LONG满足 → LONG                                    │
│  - 均不满足 → NO_CLEAR_DIRECTION → NO_TRADE            │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 7: 决策频率控制（PR-C新增）                        │
│  - 最小决策间隔检查（默认300秒）                        │
│  - 翻转冷却检查（默认600秒）                            │
│  - 失败 → NO_TRADE + MIN_INTERVAL_BLOCK/FLIP_COOLDOWN   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│ Step 8: 构造结果                                         │
│  1. 置信度计算（PR-D混合模式）:                         │
│     - 基础加分（decision+regime+quality+strong_signal） │
│     - 应用cap（UNCERTAIN≤MEDIUM, reduce_tags≤MEDIUM）   │
│     - 强信号突破（+1档但不突破cap）                     │
│  2. executable判定（PR-B综合）:                         │
│     - 决策=LONG/SHORT                                   │
│     - 风险通过                                          │
│     - 无BLOCK标签                                       │
│     - 置信度≥HIGH                                       │
│     - 质量≠POOR                                         │
│  3. 更新决策记忆（仅LONG/SHORT）                        │
└─────────────────────────────────────────────────────────┘
```

### 7.2 管道步骤数据结构

```python
{
    "step": 1,
    "name": "validate_data",
    "status": "success",  # success | warning | failed | pending
    "message": "数据验证通过（含规范化+新鲜度检查）",
    "result": "Valid"
}
```

### 7.3 可视化展示

前端通过`/api/l1/pipeline/{symbol}`接口获取管道步骤，并展示：
- ✅ 成功步骤（绿色）
- ⚠️ 警告步骤（黄色）
- ❌ 失败步骤（红色）
- ⏳ 待处理步骤（灰色）

---

## 8. 技术架构

### 8.1 技术栈

| 层次 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **后端** | Python | 3.12 | 核心决策引擎 |
| | Flask | 3.0+ | Web服务框架 |
| | APScheduler | - | 定时任务、数据缓存 |
| | Watchdog | - | 配置热更新 |
| **数据库** | SQLite | - | 决策结果持久化 |
| **前端** | HTML5 + CSS3 | - | Web界面 |
| | JavaScript (Vanilla) | ES6+ | 动态交互 |
| **数据源** | Binance API | - | 合约市场数据 |
| **容器化** | Docker | - | 服务容器化 |
| | Docker Compose | - | 服务编排 |
| **部署** | AWS EC2 | - | 生产环境 |

### 8.2 核心模块

```
trade-info/
├── market_state_machine_l1.py    # 核心决策引擎
│   ├── L1AdvisoryEngine          # 主引擎类
│   ├── DecisionMemory            # 决策记忆（PR-C）
│   ├── _validate_data()          # Step 1
│   ├── _detect_market_regime()   # Step 2
│   ├── _eval_risk_exposure_allowed()  # Step 3
│   ├── _eval_trade_quality()     # Step 4
│   ├── _eval_long/short_direction()   # Step 5
│   ├── _decide_priority()        # Step 6
│   ├── _apply_decision_control() # Step 7（PR-C）
│   └── _compute_confidence()     # Step 8（PR-D）
│
├── models/
│   ├── __init__.py
│   ├── enums.py                  # 枚举定义
│   ├── advisory_result.py        # 决策结果数据类
│   └── reason_tags.py            # 原因标签（PR-B扩展）
│       ├── ExecutabilityLevel    # 三级控制
│       ├── ReasonTag             # 标签枚举
│       ├── REASON_TAG_EXECUTABILITY  # 映射规则
│       ├── has_blocking_tags()   # 辅助函数
│       └── has_degrading_tags()  # 辅助函数
│
├── btc_web_app_l1.py             # Flask Web服务
├── database_l1.py                # 数据库操作
├── data_cache.py                 # 数据缓存
├── binance_data_fetcher.py       # Binance API封装
├── metrics_normalizer.py         # 指标规范化
├── logger_config.py              # 日志配置
│
├── config/
│   └── l1_thresholds.yaml        # 配置文件（PR-D扩展）
│
├── static/
│   ├── css/style_l1.css          # 样式（PR-删除市场数据概览）
│   └── js/app_l1.js              # 前端逻辑
│
├── templates/
│   └── index_l1.html             # Web页面（PR-简化）
│
└── tests/
    ├── test_pr_b_trade_quality.py       # PR-B测试
    ├── test_pr_c_decision_control.py    # PR-C测试
    └── test_pr_d_confidence_hybrid.py   # PR-D测试
```

### 8.3 数据流

```
┌─────────────┐
│ Binance API │
└──────┬──────┘
       │ 原始市场数据
       ↓
┌─────────────┐
│ DataCache   │ ← 定时刷新（60s）
└──────┬──────┘
       │ 规范化数据
       ↓
┌──────────────────┐
│ L1AdvisoryEngine │ ← 8步决策管道
└──────┬───────────┘
       │ AdvisoryResult
       ↓
┌──────────────┐
│ L1Database   │ ← 持久化（24h热存储）
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ Flask API    │ ← /api/l1/advisory/{symbol}
└──────┬───────┘
       │ JSON
       ↓
┌──────────────┐
│ Web Frontend │ ← 实时展示
└──────────────┘
```

---

## 9. 配置管理

### 9.1 完整配置文件

`config/l1_thresholds.yaml`:

```yaml
# L1 Advisory Layer - 阈值配置文件

# ==================
# Symbol Universe（币种宇宙）
# ==================
symbol_universe:
  enabled_symbols:
    - AIA    # AIA
    - GPS    # GPS
    - ETH    # 以太坊
  default_symbol: AIA

# ==================
# 数据质量阈值
# ==================
data_quality:
  max_staleness_seconds: 120      # 数据最大过期时间（秒）

# ==================
# 决策频率控制（PR-C）
# ==================
decision_control:
  min_decision_interval_seconds: 300  # 最小决策间隔（5分钟）
  flip_cooldown_seconds: 600          # 翻转冷却（10分钟）
  enable_min_interval: true
  enable_flip_cooldown: true

# ==================
# 市场环境识别阈值
# ==================
market_regime:
  extreme_price_change_1h: 5.0    # 1小时价格变化 > 5% → EXTREME
  trend_price_change_6h: 3.0      # 6小时价格变化 > 3% → TREND

# ==================
# 风险准入阈值
# ==================
risk_exposure:
  liquidation:
    price_change: 5.0             # 价格变化阈值(%)
    oi_drop: -15.0                # OI下降阈值(%)
  crowding:
    funding_abs: 0.001            # 费率绝对值阈值（0.1%）
    oi_growth: 30.0               # 6h OI增长阈值(%)
  extreme_volume:
    multiplier: 10.0              # 1h成交量超过24h均值的倍数

# ==================
# 交易质量阈值
# ==================
trade_quality:
  absorption:
    imbalance: 0.7                # 买卖失衡阈值
    volume_ratio: 0.5             # 成交量比例（相对于24h均值）
  noise:
    funding_volatility: 0.0005    # 费率波动阈值（0.05%）
    funding_abs: 0.0001           # 当前费率阈值（0.01%）
  rotation:
    price_threshold: 2.0          # 价格变化阈值(%)
    oi_threshold: 5.0             # OI变化阈值(%)
  range_weak:
    imbalance: 0.6                # 失衡阈值
    oi: 10.0                      # OI变化阈值(%)

# ==================
# 方向评估阈值
# ==================
direction:
  trend:
    long:
      imbalance: 0.6              # 买卖失衡阈值（多方）
      oi_change: 5.0              # 1h OI增长阈值(%)
      price_change: 1.0           # 1h价格上涨阈值(%)
    short:
      imbalance: 0.6              # 买卖失衡阈值（空方，绝对值）
      oi_change: 5.0              # 1h OI增长阈值(%)
      price_change: 1.0           # 1h价格下跌阈值(%)（绝对值）
  range:
    long:
      imbalance: 0.7              # 更高的失衡要求
      oi_change: 10.0             # 更高的OI增长要求
    short:
      imbalance: 0.7
      oi_change: 10.0

# ==================
# 置信度配置（PR-D混合模式）
# ==================
confidence_scoring:
  # 基础分（保持现有评分体系）
  decision_score: 30
  regime_trend_score: 30
  regime_range_score: 10
  regime_extreme_score: 0
  quality_good_score: 30
  quality_uncertain_score: 15      # UNCERTAIN降级
  quality_poor_score: 0
  strong_signal_bonus: 10
  
  # 档位映射
  thresholds:
    ultra: 90                      # ≥90分 → ULTRA
    high: 65                       # ≥65分 → HIGH
    medium: 40                     # ≥40分 → MEDIUM
  
  # 硬降级上限（caps）
  caps:
    uncertain_quality_max: "MEDIUM"
    tag_caps:
      noisy_market: "MEDIUM"
      weak_signal_in_range: "MEDIUM"
  
  # 强信号突破
  strong_signal_boost:
    enabled: true
    boost_levels: 1
    required_tags:
      - strong_buy_pressure
      - strong_sell_pressure

# ==================
# ReasonTag分类规则（PR-D）
# ==================
reason_tag_rules:
  reduce_tags:
    - noisy_market
    - weak_signal_in_range
  deny_tags:
    - liquidation_phase
    - crowding_risk
    - extreme_volume
    - data_stale
    - extreme_regime
    - absorption_risk
    - rotation_risk

# ==================
# 状态机配置
# ==================
state_machine:
  cool_down_minutes: 60           # 冷却期时长（分钟）
  signal_timeout_minutes: 30      # 信号超时时间（分钟）
```

### 9.2 配置热更新

系统使用Watchdog监听配置文件变化，支持热更新（无需重启服务）。

---

## 10. Web界面

### 10.1 界面组成

**v3.0简化版**（删除市场数据概览）：

1. **头部** - 系统标题、最后更新时间、刷新按钮
2. **币种选择** - AIA、GPS、ETH按钮切换
3. **核心决策信号** - 决策方向、置信度、时间戳
4. **安全闸门状态** - 风险准入、交易质量、市场环境、系统状态
5. **决策原因标签** - 分类展示、颜色标识
6. **历史决策记录** - 最近30条、可折叠展开
7. **决策管道可视化** - 8步流程状态
8. **页脚信息** - 系统说明、风险提示

**已删除**：
- ❌ 市场数据概览（价格、成交量、资金费率等8个数据卡片）

### 10.2 访问地址

- **本地**: http://localhost:8001/
- **AWS**: http://43.212.176.169:8001/

### 10.3 自动刷新

- 刷新周期: 60秒
- 可手动刷新

---

## 11. API接口

### 11.1 核心接口

#### 11.1.1 获取决策建议

```http
GET /api/l1/advisory/{symbol}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "decision": "no_trade",
    "confidence": "low",
    "market_regime": "range",
    "system_state": "wait",
    "risk_exposure_allowed": false,
    "trade_quality": "poor",
    "reason_tags": [
      "weak_signal_in_range"
    ],
    "timestamp": "2026-01-20T21:48:45.123456",
    "executable": false
  },
  "message": "Advisory generated successfully"
}
```

#### 11.1.2 获取币种列表

```http
GET /api/markets
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "markets": {
      "AIA": {"futures": true, "spot": false},
      "GPS": {"futures": true, "spot": false},
      "ETH": {"futures": true, "spot": false}
    },
    "default_symbol": "AIA"
  }
}
```

#### 11.1.3 获取决策管道

```http
GET /api/l1/pipeline/{symbol}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "steps": [
      {
        "step": 1,
        "name": "validate_data",
        "status": "success",
        "message": "数据验证通过",
        "result": "Valid"
      },
      {
        "step": 7,
        "name": "decision_control",
        "status": "failed",
        "message": "频率控制阻断：min_interval_block",
        "result": "Blocked"
      }
    ]
  }
}
```

---

## 12. 部署架构

### 12.1 部署环境

| 环境 | 地址 | 状态 | 用途 |
|------|------|------|------|
| **本地开发** | localhost:8001 | 按需启动 | 开发调试、测试 |
| **AWS生产** | 43.212.176.169:8001 | 持续运行 | 生产服务 |

### 12.2 Docker部署

#### 本地部署

```bash
# 启动服务
./docker-l1-run.sh

# 停止服务
./docker-l1-stop.sh

# 查看日志
docker logs -f l1-advisory-layer

# 重启服务
docker compose -f docker-compose-l1.yml restart
```

#### AWS部署

```bash
# 同步代码
rsync -avz --exclude 'data/db/*.db' \
  -e "ssh -i ../john-test.pem" \
  ./ ubuntu@43.212.176.169:~/trade-info-l1/

# SSH登录
ssh -i ../john-test.pem ubuntu@43.212.176.169

# 部署服务
cd ~/trade-info-l1
docker compose -f docker-compose-l1.yml down
docker compose -f docker-compose-l1.yml build
docker compose -f docker-compose-l1.yml up -d

# 查看状态
docker ps
docker logs -f l1-advisory-layer
```

### 12.3 数据持久化

```
./data/db/
├── l1_advisory_results.db    # 决策结果数据库
└── l1_advisory_results.db-wal  # WAL日志

./config/
└── l1_thresholds.yaml        # 配置文件（热更新）
```

---

## 13. 测试覆盖

### 13.1 测试列表

| PR | 测试文件 | 测试数量 | 状态 |
|----|---------|---------|------|
| **PR-001** | test_pr_batch1.py | 1 | ✅ |
| **PR-002** | test_pr_batch1.py | 1 | ✅ |
| **PR-003** | test_pr_batch1.py | 1 | ✅ |
| **PR-004** | test_pr_batch2.py | 1 | ✅ |
| **PR-005** | test_pr_batch2.py | 1 | ✅ |
| **PR-006** | test_pr_batch2.py | 1 | ✅ |
| **PR-007** | test_pr_batch3.py | 1 | ✅ |
| **PR-008** | test_pr_batch3.py | 1 | ✅ |
| **PR-009** | test_pr_batch3.py | 1 | ✅ |
| **PR-010** | test_pr_batch3.py | 1 | ✅ |
| **PR-B** | test_pr_b_trade_quality.py | 7 | ✅ |
| **PR-C** | test_pr_c_decision_control.py | 4 | ✅ |
| **PR-D** | test_pr_d_confidence_hybrid.py | 7 | ✅ |
| **PR-A修复** | test_decimal_calibration.py | 5 | ✅ |
| **PR-A防回归** | test_calibration_validation.py | 4 | ✅ |
| **总计** | - | **37** | ✅ |

### 13.2 测试命令

```bash
# 在Docker容器中运行
docker exec l1-advisory-layer python tests/test_pr_b_trade_quality.py
docker exec l1-advisory-layer python tests/test_pr_c_decision_control.py
docker exec l1-advisory-layer python tests/test_pr_d_confidence_hybrid.py

# 或批量运行
docker exec l1-advisory-layer bash -c "
  python tests/test_pr_b_trade_quality.py && \
  python tests/test_pr_c_decision_control.py && \
  python tests/test_pr_d_confidence_hybrid.py
"
```

### 13.3 测试覆盖率

```
核心功能覆盖:
  - 数据验证: ✅
  - 市场环境识别: ✅
  - 风险准入: ✅
  - 质量评估: ✅
  - 方向评估: ✅
  - 决策频率控制: ✅ (PR-C)
  - 置信度计算: ✅ (PR-D)
  - executable判定: ✅ (PR-B)
  - 管道追溯: ✅
  - 多币种支持: ✅

PR-B专项测试:
  ✅ ExecutabilityLevel映射
  ✅ has_blocking_tags函数
  ✅ has_degrading_tags函数
  ✅ POOR质量硬短路
  ✅ UNCERTAIN质量降级
  ✅ 降级标签限制置信度
  ✅ executable综合判定

PR-C专项测试:
  ✅ DecisionMemory基本功能
  ✅ 最小间隔阻断
  ✅ 翻转冷却阻断
  ✅ 禁用控制功能

PR-D专项测试:
  ✅ 基础加分制
  ✅ UNCERTAIN质量上限
  ✅ 降级标签上限
  ✅ 强信号突破
  ✅ 强信号无法突破cap
  ✅ 置信度档位比较
  ✅ 字符串转置信度
```

---

## 14. 使用指南

### 14.1 快速开始

#### 本地部署

```bash
# 1. 克隆项目
cd /path/to/trade-info

# 2. 启动服务
./docker-l1-run.sh

# 3. 访问Web界面
open http://localhost:8001

# 4. 测试API
curl http://localhost:8001/api/l1/advisory/AIA
```

#### AWS访问

```bash
# 直接访问
open http://43.212.176.169:8001

# 或使用curl
curl http://43.212.176.169:8001/api/l1/advisory/AIA
```

### 14.2 配置调整

#### 修改币种列表

编辑 `config/l1_thresholds.yaml`:

```yaml
symbol_universe:
  enabled_symbols:
    - AIA    # 改为你的币种
    - GPS
    - ETH
  default_symbol: AIA  # 改为默认币种
```

重启服务：
```bash
docker compose -f docker-compose-l1.yml restart
```

#### 调整决策频率控制

```yaml
decision_control:
  min_decision_interval_seconds: 300  # 改为你的间隔（秒）
  flip_cooldown_seconds: 600          # 改为你的冷却（秒）
  enable_min_interval: true           # 是否启用
  enable_flip_cooldown: true
```

支持热更新，无需重启。

#### 调整置信度规则

```yaml
confidence_scoring:
  # 修改基础分
  quality_uncertain_score: 15  # UNCERTAIN的分数
  
  # 修改cap规则
  caps:
    uncertain_quality_max: "MEDIUM"  # 改为HIGH允许更高
  
  # 修改强信号突破
  strong_signal_boost:
    enabled: true
    boost_levels: 1  # 改为2提升2档
```

支持热更新。

### 14.3 监控与日志

```bash
# 查看实时日志
docker logs -f l1-advisory-layer

# 查看最近100行
docker logs --tail 100 l1-advisory-layer

# 查看服务状态
docker ps --filter "name=l1-advisory-layer"

# 查看健康状态
docker inspect l1-advisory-layer | grep -A 5 Health
```

### 14.4 故障排查

#### 问题1: 服务无法启动

```bash
# 检查端口占用
lsof -i :8001

# 检查Docker状态
docker ps -a

# 查看错误日志
docker logs l1-advisory-layer
```

#### 问题2: 币种无法选择

```bash
# 检查配置文件
cat config/l1_thresholds.yaml | grep -A 5 symbol_universe

# 检查API响应
curl http://localhost:8001/api/markets

# 重新构建镜像
docker compose -f docker-compose-l1.yml build
```

#### 问题3: 决策总是NO_TRADE

```bash
# 查看决策管道
curl http://localhost:8001/api/l1/pipeline/AIA | python3 -m json.tool

# 检查ReasonTag
curl http://localhost:8001/api/l1/advisory/AIA | python3 -c "
import sys, json
d = json.load(sys.stdin)
print('ReasonTags:', d['data']['reason_tags'])
"

# 查看频率控制
# 如果有MIN_INTERVAL_BLOCK或FLIP_COOLDOWN_BLOCK，等待冷却时间过去
```

### 14.5 开发流程

```
1. 本地开发调试
   - 修改代码
   - ./docker-l1-stop.sh
   - docker compose -f docker-compose-l1.yml build
   - ./docker-l1-run.sh
   - 测试验证

2. 运行测试
   - docker exec l1-advisory-layer python tests/test_xxx.py

3. 提交代码
   - git add .
   - git commit -m "描述"
   - （不自动推送到GitHub，听从指令）

4. 部署到AWS（按需）
   - rsync同步代码
   - SSH登录AWS
   - 重新构建并启动服务
```

---

## 15. 附录

### 15.1 枚举定义

#### Decision
```python
class Decision(Enum):
    LONG = "long"        # 做多建议
    SHORT = "short"      # 做空建议
    NO_TRADE = "no_trade"  # 不交易
```

#### Confidence
```python
class Confidence(Enum):
    ULTRA = "ultra"      # 超高置信度（≥90分）
    HIGH = "high"        # 高置信度（65-89分）
    MEDIUM = "medium"    # 中置信度（40-64分）
    LOW = "low"          # 低置信度（<40分）
```

#### TradeQuality
```python
class TradeQuality(Enum):
    GOOD = "good"            # 良好质量
    UNCERTAIN = "uncertain"  # 不确定（噪声）
    POOR = "poor"            # 差质量（风险）
```

#### MarketRegime
```python
class MarketRegime(Enum):
    TREND = "trend"      # 趋势市
    RANGE = "range"      # 震荡市
    EXTREME = "extreme"  # 极端市
```

#### SystemState
```python
class SystemState(Enum):
    INIT = "init"        # 初始化
    WAIT = "wait"        # 等待状态（L1主要状态）
    # LONG_ACTIVE = "long_active"    # L1不维护
    # SHORT_ACTIVE = "short_active"  # L1不维护
    # COOL_DOWN = "cool_down"        # L1不维护
```

#### ExecutabilityLevel (PR-B)
```python
class ExecutabilityLevel(Enum):
    ALLOW = "allow"      # 允许执行
    DEGRADE = "degrade"  # 降级但允许
    BLOCK = "block"      # 阻断执行
```

### 15.2 完整ReasonTag列表（v3.0）

```python
# 数据验证
INVALID_DATA = "invalid_data"
DATA_STALE = "data_stale"

# 风险否决类
EXTREME_REGIME = "extreme_regime"
LIQUIDATION_PHASE = "liquidation_phase"
CROWDING_RISK = "crowding_risk"
EXTREME_VOLUME = "extreme_volume"

# 质量否决类
ABSORPTION_RISK = "absorption_risk"
NOISY_MARKET = "noisy_market"
ROTATION_RISK = "rotation_risk"
WEAK_SIGNAL_IN_RANGE = "weak_signal_in_range"

# 方向冲突类
CONFLICTING_SIGNALS = "conflicting_signals"
NO_CLEAR_DIRECTION = "no_clear_direction"

# 状态机约束类
COOL_DOWN_ACTIVE = "cool_down_active"
STATE_TRANSITION_DENIED = "state_transition_denied"

# 决策频率控制类（PR-C）
MIN_INTERVAL_BLOCK = "min_interval_block"
FLIP_COOLDOWN_BLOCK = "flip_cooldown_block"

# 辅助信息类
HIGH_FUNDING_RATE = "high_funding_rate"
LOW_FUNDING_RATE = "low_funding_rate"
STRONG_BUY_PRESSURE = "strong_buy_pressure"
STRONG_SELL_PRESSURE = "strong_sell_pressure"
OI_GROWING = "oi_growing"
OI_DECLINING = "oi_declining"
```

### 15.3 版本历史

| 版本 | 日期 | 主要更新 |
|------|------|---------|
| **v1.0** | 2025-12 | 基础决策系统、3档置信度、2档质量 |
| **v2.0** | 2026-01-19 | 10个PR优化、4档置信度、3档质量、多币种、AWS部署 |
| **v3.0** | 2026-01-20 | PR-B/C/D增强、ExecutabilityLevel、频率控制、置信度混合模式 |

### 15.4 开发团队与联系

- **系统架构**: L1 Advisory Layer
- **开发语言**: Python 3.12
- **框架**: Flask + Docker
- **部署**: AWS EC2
- **文档版本**: 3.0
- **最后更新**: 2026-01-20

---

## 📌 总结

### v3.0核心亮点

**🔴 最重要：PR-A口径修复（系统性错误）**
- 统一配置口径为小数格式（0.05=5%）
- 修复方向评估从未触发的致命Bug
- 修复市场环境识别异常
- **首次成功触发LONG/SHORT决策**
- 测试验证：强TREND+强LONG → decision=LONG, confidence=ULTRA, executable=True

1. **PR-B: 质量语义钉死**
   - ExecutabilityLevel三级控制（ALLOW/DEGRADE/BLOCK）
   - 23个ReasonTag精细映射
   - POOR硬短路、UNCERTAIN降级执行
   - executable综合判定（5个维度）

2. **PR-C: 决策频率控制**
   - DecisionMemory轻量级管理
   - 最小间隔（300s）+ 翻转冷却（600s）
   - 多币种独立控制
   - 可配置开关

3. **PR-D: 置信度混合模式**
   - 三步流程：加分 → cap → boost
   - UNCERTAIN≤MEDIUM、降级标签≤MEDIUM
   - 强信号+1档（但不突破cap）
   - 完全配置化

4. **定制化优化**
   - 币种：AIA、GPS、ETH
   - 前端简化：删除市场数据概览
   - 测试覆盖：28个测试全部通过

5. **生产就绪**
   - 本地开发环境
   - AWS生产环境
   - Docker容器化
   - 配置热更新

---

**L1 Advisory Layer v3.0 - 更智能、更安全、更可控的交易决策咨询系统！** 🚀
