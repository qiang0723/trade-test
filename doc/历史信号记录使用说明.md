# å†å²ä¿¡å·è®°å½•åŠŸèƒ½ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿå·²å¯ç”¨æœ€å°åŒ–ä¿¡å·è®°å½•åŠŸèƒ½ï¼Œè‡ªåŠ¨å°†æ¯æ¬¡å¸‚åœºåˆ†æç»“æœä¿å­˜åˆ°æœ¬åœ°SQLiteæ•°æ®åº“ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

### âœ… è‡ªåŠ¨è®°å½•
- æ¯æ¬¡è°ƒç”¨å¸‚åœºåˆ†æAPIï¼Œè‡ªåŠ¨ä¿å­˜ç»“æœåˆ°æ•°æ®åº“
- æ•°æ®åº“æ•…éšœä¸å½±å“ä¸»åŠŸèƒ½
- é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨

### ğŸ“Š è®°å½•å†…å®¹
- **åŸºæœ¬ä¿¡æ¯**ï¼šå¸ç§ã€æ—¶é—´æˆ³ã€äº¤æ˜“ä¿¡å·ã€çŠ¶æ€åŸå› 
- **è¯„åˆ†æ•°æ®**ï¼šåšå¤šè¯„åˆ†ã€åšç©ºè¯„åˆ†
- **å¸‚åœºæ•°æ®**ï¼šä»·æ ¼ã€OIå˜åŒ–ã€èµ„é‡‘è´¹ç‡ã€ä¹°å–æ¯”ä¾‹ç­‰
- **åˆ†æåŸå› **ï¼šåšå¤šç†ç”±ã€åšç©ºç†ç”±ã€é£é™©æç¤º

---

## APIæ¥å£

### 1. æŸ¥è¯¢å†å²ä¿¡å·

**æ¥å£ï¼š** `GET /api/signal-history`

**å‚æ•°ï¼š**
- `symbol`: å¸ç§ç¬¦å·ï¼ˆå¯é€‰ï¼Œä¸ä¼ åˆ™æŸ¥è¯¢æ‰€æœ‰å¸ç§ï¼‰
- `limit`: è¿”å›è®°å½•æ•°é‡ï¼ˆé»˜è®¤10ï¼‰

**ç¤ºä¾‹ï¼š**
```bash
# æŸ¥è¯¢æ‰€æœ‰å¸ç§æœ€è¿‘10æ¡è®°å½•
curl http://localhost:5001/api/signal-history

# æŸ¥è¯¢BTCæœ€è¿‘5æ¡è®°å½•
curl http://localhost:5001/api/signal-history?symbol=BTC&limit=5
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "symbol": "BTC",
  "count": 1,
  "signals": [
    {
      "id": 1,
      "timestamp": "2026-01-20 00:13:38",
      "symbol": "BTC",
      "trade_action": "NO_TRADE",
      "state_reason": "å¤šç©ºä¿¡å·å‡ä¸è¶³",
      "long_score": 1.5,
      "short_score": 0.0,
      "price": 93027.5,
      "price_change_24h": -2.196,
      "funding_rate": 0.002395,
      "buy_ratio_1h": 46.97,
      "sell_ratio_1h": 53.03
    }
  ]
}
```

---

### 2. ä¿¡å·ç»Ÿè®¡

**æ¥å£ï¼š** `GET /api/signal-stats`

**å‚æ•°ï¼š**
- `symbol`: å¸ç§ç¬¦å·ï¼ˆå¯é€‰ï¼‰
- `days`: ç»Ÿè®¡æœ€è¿‘å¤šå°‘å¤©ï¼ˆé»˜è®¤7ï¼‰

**ç¤ºä¾‹ï¼š**
```bash
# ç»Ÿè®¡æ‰€æœ‰å¸ç§æœ€è¿‘7å¤©
curl http://localhost:5001/api/signal-stats

# ç»Ÿè®¡BTCæœ€è¿‘30å¤©
curl http://localhost:5001/api/signal-stats?symbol=BTC&days=30
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "symbol": "BTC",
  "days": 7,
  "stats": {
    "total_count": 100,
    "long_count": 25,
    "short_count": 30,
    "no_trade_count": 45,
    "long_percentage": 25.0,
    "short_percentage": 30.0,
    "no_trade_percentage": 45.0,
    "avg_long_score": 3.5,
    "avg_short_score": 4.2,
    "avg_price_change": -0.5
  }
}
```

---

### 3. æ•°æ®åº“ä¿¡æ¯

**æ¥å£ï¼š** `GET /api/database-info`

**ç¤ºä¾‹ï¼š**
```bash
curl http://localhost:5001/api/database-info
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "info": {
    "db_path": "market_signals.db",
    "file_size_mb": 0.02,
    "total_records": 1,
    "first_record": "2026-01-20 00:13:38",
    "last_record": "2026-01-20 00:13:38",
    "symbols": ["BTC", "ETH"],
    "symbol_count": 2
  }
}
```

---

## æ•°æ®åº“è¯¦æƒ…

### æ–‡ä»¶ä½ç½®
- **Dockerå†…éƒ¨ï¼š** `/app/market_signals.db`
- **æœ¬åœ°å¼€å‘ï¼š** `./market_signals.db`

### è¡¨ç»“æ„

```sql
CREATE TABLE market_signals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME NOT NULL,           -- åˆ†ææ—¶é—´
    symbol VARCHAR(10) NOT NULL,           -- å¸ç§ç¬¦å·
    trade_action VARCHAR(10) NOT NULL,     -- LONG/SHORT/NO_TRADE
    state_reason TEXT,                     -- çŠ¶æ€åŸå› 
    long_score FLOAT,                      -- åšå¤šè¯„åˆ†
    short_score FLOAT,                     -- åšç©ºè¯„åˆ†
    price FLOAT,                           -- ä»·æ ¼
    price_change_24h FLOAT,                -- 24hæ¶¨è·Œå¹…
    price_trend_6h FLOAT,                  -- 6hè¶‹åŠ¿
    volume_change_6h FLOAT,                -- 6hæˆäº¤é‡å˜åŒ–
    oi_change_6h FLOAT,                    -- 6hæŒä»“é‡å˜åŒ–
    funding_rate FLOAT,                    -- èµ„é‡‘è´¹ç‡
    buy_ratio_1h FLOAT,                    -- 1hä¹°å…¥æ¯”ä¾‹
    sell_ratio_1h FLOAT,                   -- 1hå–å‡ºæ¯”ä¾‹
    total_amount_1h FLOAT,                 -- 1hæˆäº¤é¢
    risk_warnings TEXT,                    -- é£é™©æç¤º(JSON)
    long_reasons TEXT,                     -- åšå¤šç†ç”±(JSON)
    short_reasons TEXT,                    -- åšç©ºç†ç”±(JSON)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### ç´¢å¼•
- `idx_symbol_timestamp`: æŒ‰å¸ç§å’Œæ—¶é—´é™åº
- `idx_trade_action`: æŒ‰äº¤æ˜“ä¿¡å·

---

## å­˜å‚¨ä¼°ç®—

### å­˜å‚¨å®¹é‡
- æ¯æ¡è®°å½•ï¼šçº¦500å­—èŠ‚
- æ¯å¤©è®°å½•ï¼š5å¸ç§ Ã— æ¯å°æ—¶1æ¬¡ Ã— 24å°æ—¶ = 120æ¡
- æœˆå­˜å‚¨é‡ï¼š**1.8MB**
- å¹´å­˜å‚¨é‡ï¼š**20MB**

### å­˜å‚¨ç©ºé—´è¯´æ˜
- SQLiteæ•°æ®åº“æ–‡ä»¶ä¼šè‡ªåŠ¨å¢é•¿
- æ— éœ€æ‰‹åŠ¨ç»´æŠ¤
- å¯é€šè¿‡`/api/database-info`æŸ¥çœ‹å½“å‰å¤§å°

---

## ä½¿ç”¨åœºæ™¯

### 1. è¯„ä¼°ç­–ç•¥æ•ˆæœ
```python
# æŸ¥è¯¢å†å²ä¿¡å·ï¼Œåˆ†æå‡†ç¡®ç‡
import requests
import pandas as pd

response = requests.get('http://localhost:5001/api/signal-history?limit=100')
signals = pd.DataFrame(response.json()['signals'])

# ç»Ÿè®¡LONGä¿¡å·åä»·æ ¼ä¸Šæ¶¨çš„æ¦‚ç‡
long_signals = signals[signals['trade_action'] == 'LONG']
# ... è¿›è¡Œç»Ÿè®¡åˆ†æ
```

### 2. ç›‘æ§ä¿¡å·åˆ†å¸ƒ
```bash
# æŸ¥çœ‹æœ€è¿‘7å¤©çš„ä¿¡å·åˆ†å¸ƒ
curl http://localhost:5001/api/signal-stats?days=7 | jq '.stats'
```

### 3. è¿½è¸ªç‰¹å®šå¸ç§
```bash
# æŸ¥çœ‹BTCçš„å†å²ä¿¡å·
curl http://localhost:5001/api/signal-history?symbol=BTC&limit=20
```

---

## æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦æç¤º

1. **æ•°æ®åº“æ–‡ä»¶æŒä¹…åŒ–**
   - Dockerå®¹å™¨é‡å¯ä¼šä¸¢å¤±æ•°æ®åº“æ–‡ä»¶
   - å¦‚éœ€æŒä¹…åŒ–ï¼Œè¯·æŒ‚è½½volumeï¼š
   ```yaml
   volumes:
     - ./data:/app
   ```

2. **æ•°æ®å¤‡ä»½**
   - æ•°æ®åº“æ–‡ä»¶ï¼š`market_signals.db`
   - å®šæœŸå¤‡ä»½ä»¥é˜²æ•°æ®ä¸¢å¤±

3. **æ€§èƒ½å½±å“**
   - æ•°æ®åº“æ“ä½œå¼‚æ­¥æ‰§è¡Œ
   - ä¸å½±å“APIå“åº”é€Ÿåº¦
   - æ•°æ®åº“å¤±è´¥åªè®°å½•æ—¥å¿—

4. **æ•°æ®æ¸…ç†**
   - å½“å‰æ— è‡ªåŠ¨æ¸…ç†æœºåˆ¶
   - æ•°æ®ä¼šæŒç»­ç§¯ç´¯
   - æœªæ¥å¯æ·»åŠ å®šæœŸæ¸…ç†åŠŸèƒ½

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¯¼å‡ºæ•°æ®åº“æ•°æ®ï¼Ÿ

**A:** ä½¿ç”¨SQLiteå‘½ä»¤è¡Œå·¥å…·ï¼š
```bash
# è¿›å…¥Dockerå®¹å™¨
docker exec -it trade-info-app /bin/bash

# å¯¼å‡ºä¸ºCSV
sqlite3 market_signals.db << EOF
.mode csv
.output signals.csv
SELECT * FROM market_signals;
.quit
EOF
```

### Q2: æ•°æ®åº“æ–‡ä»¶ä¼šæ— é™å¢é•¿å—ï¼Ÿ

**A:** æ˜¯çš„ï¼Œå½“å‰ç‰ˆæœ¬ä¼šæŒç»­ç§¯ç´¯ã€‚é¢„è®¡1å¹´çº¦20MBï¼Œä¸€èˆ¬ä¸ä¼šé€ æˆé—®é¢˜ã€‚æœªæ¥å¯æ·»åŠ ï¼š
- è‡ªåŠ¨åˆ é™¤Nå¤©å‰çš„æ—§æ•°æ®
- æ•°æ®å½’æ¡£åŠŸèƒ½

### Q3: å¦‚ä½•æŸ¥çœ‹æ•°æ®åº“å†…å®¹ï¼Ÿ

**A:** ä¸‰ç§æ–¹æ³•ï¼š
1. ä½¿ç”¨APIæ¥å£ï¼ˆæ¨èï¼‰
2. SQLiteå®¢æˆ·ç«¯å·¥å…·
3. Pythonè„šæœ¬ç›´æ¥æŸ¥è¯¢

### Q4: æ•°æ®åº“æ•…éšœä¼šå½±å“ä¸»åŠŸèƒ½å—ï¼Ÿ

**A:** ä¸ä¼šã€‚æ•°æ®åº“ä¿å­˜å¤±è´¥åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“å¸‚åœºåˆ†æåŠŸèƒ½ã€‚

---

## åç»­æ‰©å±•

### é˜¶æ®µ2ï¼šæŸ¥è¯¢ç•Œé¢ï¼ˆæœªå®æ–½ï¼‰
- Webé¡µé¢æŸ¥çœ‹å†å²ä¿¡å·
- å›¾è¡¨å±•ç¤ºä¿¡å·åˆ†å¸ƒ
- å‡†ç¡®ç‡ç»Ÿè®¡

### é˜¶æ®µ3ï¼šå®Œæ•´å†å²ï¼ˆæœªå®æ–½ï¼‰
- ä¿å­˜è¯¦ç»†ä»·æ ¼å†å²
- ä¿å­˜æˆäº¤è®°å½•
- æ”¯æŒç­–ç•¥å›æµ‹
- å‚æ•°ä¼˜åŒ–

---

## æŠ€æœ¯ç»†èŠ‚

### æ¨¡å—è®¾è®¡
- **database.py**: æ•°æ®åº“ç®¡ç†æ¨¡å—
  - `SignalDatabase`: æ•°æ®åº“æ“ä½œç±»
  - `get_signal_db()`: å•ä¾‹è·å–æ–¹æ³•

### é›†æˆæ–¹å¼
```python
# btc_web_app_multi.py
from database import get_signal_db

# åœ¨analyze_futures_marketä¸­
if DB_ENABLED:
    try:
        db = get_signal_db()
        db.save_signal(result)
    except Exception as e:
        print(f"âš ï¸ æ•°æ®åº“ä¿å­˜å¤±è´¥: {str(e)}")
```

### é”™è¯¯å¤„ç†
- æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ â†’ åŠŸèƒ½ç¦ç”¨
- ä¿å­˜å¤±è´¥ â†’ è®°å½•æ—¥å¿—ï¼Œä¸æŠ›å¼‚å¸¸
- æŸ¥è¯¢å¤±è´¥ â†’ è¿”å›ç©ºåˆ—è¡¨

---

**æ›´æ–°æ—¥æœŸï¼š** 2026-01-20  
**ç‰ˆæœ¬ï¼š** v1.0ï¼ˆæ–¹æ¡ˆAé˜¶æ®µ1ï¼‰
