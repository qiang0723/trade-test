# 📊 历史信号记录使用说明

> 最后更新：2026-01-20  
> 版本：v3.0+

---

## 📋 目录

1. [功能概述](#功能概述)
2. [核心特性](#核心特性)
3. [使用方法](#使用方法)
4. [数据管理](#数据管理)
5. [界面说明](#界面说明)
6. [API接口](#api接口)
7. [数据保留策略](#数据保留策略)
8. [技术实现](#技术实现)

---

## 📖 功能概述

### 为什么需要历史记录？

**业务需求：**
- ✅ 回溯市场分析的准确性
- ✅ 评估信号质量
- ✅ 优化决策模型
- ✅ 追踪市场状态变化

**实现目标：**
- 📦 记录48小时内的所有交易信号
- 📊 提供统计和分析功能
- 🔍 支持筛选和查询
- 🗑️ 自动清理旧数据

---

## ✨ 核心特性

### 1. 数据记录

**自动记录：**
- 每次市场分析时自动保存信号
- 记录完整的市场数据快照
- 包含价格、OI、资金费率等

**记录内容：**
```
- 时间戳
- 币种符号
- 交易决策（LONG/SHORT/NO_TRADE）
- 决策原因
- 价格数据（当前价、24h涨跌、6h趋势）
- OI变化
- 资金费率
- 1h买卖比例
```

### 2. 数据保留

**保留策略：**
- ⏰ **保留时长**：48小时
- 🔄 **清理频率**：每6小时自动清理
- 🗑️ **手动清理**：支持手动触发

**存储优化：**
- 只保留最近48小时的数据
- 自动清理过期数据
- 控制数据库大小

### 3. 统计分析

**准确性分析：**
- 📊 总信号数量
- 📈 做多信号占比
- 📉 做空信号占比
- ⏸️ 观望信号占比

**时间范围：**
- 最早记录时间
- 最新记录时间
- 覆盖时长

### 4. 筛选查询

**支持筛选：**
- 🪙 按币种筛选（TA / BTR / AT）
- 📊 按信号类型筛选（做多 / 做空 / 观望）
- 🔍 实时筛选，无需刷新

---

## 🚀 使用方法

### 方式1：通过Web界面（推荐）

#### **1. 访问历史记录页面**

```
http://localhost:5001/history
```

#### **2. 查看统计概览**

页面顶部显示4个统计卡片：
- **总信号数**：48小时内的总信号数
- **做多信号**：做多信号数量和占比
- **做空信号**：做空信号数量和占比
- **观望信号**：观望信号数量和占比

#### **3. 使用筛选器**

```
选择币种: [全部币种 ▼] [TA ▼] [BTR ▼] [AT ▼]
信号类型: [全部类型 ▼] [做多 ▼] [做空 ▼] [观望 ▼]
时间范围: 2026-01-20 10:00:00 ~ 2026-01-22 10:00:00
```

#### **4. 查看信号详情**

- 点击任意信号卡片展开详细信息
- 再次点击收起

#### **5. 刷新数据**

点击右上角"刷新数据"按钮，或等待60秒自动刷新

#### **6. 清理旧数据**

点击右上角"清理旧数据"按钮，手动触发清理

---

### 方式2：通过API接口

#### **1. 获取48小时历史记录**

```bash
# 获取所有币种的48小时记录
curl http://localhost:5001/api/signals-48h

# 获取指定币种的48小时记录
curl http://localhost:5001/api/signals-48h?symbol=BTR
```

**响应示例：**
```json
{
  "success": true,
  "symbol": "BTR",
  "count": 45,
  "signals": [
    {
      "id": 123,
      "timestamp": "2026-01-20 10:30:00",
      "symbol": "BTR",
      "trade_action": "LONG",
      "state_reason": "满足做多条件，进入做多活跃状态",
      "price": 0.1234,
      "price_change_24h": 5.67,
      "price_trend_6h": 2.34,
      "volume_change_6h": 15.5,
      "oi_change_6h": 3.2,
      "funding_rate": 0.0001,
      "buy_ratio_1h": 65.5,
      "sell_ratio_1h": 34.5
    }
  ]
}
```

#### **2. 获取准确性分析**

```bash
# 分析所有币种
curl http://localhost:5001/api/signal-accuracy

# 分析指定币种
curl http://localhost:5001/api/signal-accuracy?symbol=BTR

# 指定时间范围（小时）
curl http://localhost:5001/api/signal-accuracy?hours=24
```

**响应示例：**
```json
{
  "success": true,
  "symbol": "BTR",
  "analysis": {
    "total_signals": 45,
    "long_count": 15,
    "short_count": 10,
    "no_trade_count": 20,
    "long_percentage": 33.33,
    "short_percentage": 22.22,
    "no_trade_percentage": 44.44,
    "time_range_hours": 48,
    "oldest_signal": "2026-01-20 10:00:00",
    "newest_signal": "2026-01-22 10:00:00"
  }
}
```

#### **3. 手动清理旧数据**

```bash
# 清理48小时前的数据
curl http://localhost:5001/api/cleanup-old-signals

# 自定义清理时间（如清理72小时前的）
curl http://localhost:5001/api/cleanup-old-signals?hours=72
```

**响应示例：**
```json
{
  "success": true,
  "deleted_count": 125,
  "message": "清理了125条超过48小时的旧信号"
}
```

---

## 📊 界面说明

### 1. 页面布局

```
┌──────────────────────────────────────────────────────────┐
│  📊 交易信号历史记录                                      │
│  [返回首页] [刷新数据] [清理旧数据]                       │
├──────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│  │总信号数 │ │做多信号 │ │做空信号 │ │观望信号 │        │
│  │   45    │ │   15    │ │   10    │ │   20    │        │
│  │48小时内 │ │ 33.33%  │ │ 22.22%  │ │ 44.44%  │        │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘        │
├──────────────────────────────────────────────────────────┤
│  选择币种: [全部 ▼]  信号类型: [全部 ▼]                  │
│  时间范围: 2026-01-20 ~ 2026-01-22                       │
├──────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────┐      │
│  │ BTR/USDT                              [做多]   │      │
│  │ ⏰ 2026-01-22 10:30:00                         │      │
│  │ 价格: $0.1234  24h涨跌: +5.67%                │      │
│  │ [点击展开/收起详情]                            │      │
│  └────────────────────────────────────────────────┘      │
│  ...更多信号...                                          │
│                                                           │
│  [上一页]  第 1 / 5 页  [下一页]                         │
└──────────────────────────────────────────────────────────┘
```

### 2. 信号卡片

**基本信息：**
- 币种符号（如 BTR/USDT）
- 交易决策标签（做多/做空/观望）
- 时间戳

**核心数据：**
- 价格
- 24h涨跌幅
- 6h价格趋势
- 资金费率

**详细信息（点击展开）：**
- 成交量变化
- 持仓量变化
- 1h买单占比
- 1h卖单占比
- 决策原因

### 3. 交互功能

**筛选：**
- 下拉选择器实时筛选
- 无需点击查询按钮

**分页：**
- 每页显示10条
- 支持上一页/下一页

**展开/收起：**
- 点击卡片展开详情
- 再次点击收起

**刷新：**
- 手动刷新按钮
- 60秒自动刷新

---

## 💾 数据管理

### 1. 自动记录

**触发时机：**
- 每次执行市场分析时自动保存
- 包括手动刷新和定时刷新

**记录位置：**
```
data/db/market_signals.db
```

**表结构：**
```sql
CREATE TABLE market_signals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME NOT NULL,
    symbol VARCHAR(10) NOT NULL,
    trade_action VARCHAR(10) NOT NULL,
    state_reason TEXT,
    price FLOAT,
    price_change_24h FLOAT,
    price_trend_6h FLOAT,
    volume_change_6h FLOAT,
    oi_change_6h FLOAT,
    funding_rate FLOAT,
    buy_ratio_1h FLOAT,
    sell_ratio_1h FLOAT,
    ...
);
```

### 2. 自动清理

**清理策略：**
- ⏰ **执行频率**：每6小时
- 🗓️ **保留时长**：48小时
- 🗑️ **清理对象**：超过48小时的旧数据

**清理逻辑：**
```python
# 每6小时执行一次
DELETE FROM market_signals 
WHERE timestamp < datetime('now', '-48 hours');
```

**清理日志：**
```
INFO: 自动清理了125条旧信号记录
```

### 3. 手动清理

**触发方式：**
- Web界面点击"清理旧数据"按钮
- 调用 `/api/cleanup-old-signals` API

**确认提示：**
```
确定要清理48小时前的旧数据吗？
[确定] [取消]
```

**清理结果：**
```
✅ 清理了125条超过48小时的旧信号
```

---

## 🔌 API接口

### 1. 获取48小时历史记录

**接口：** `GET /api/signals-48h`

**参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | string | 否 | 币种符号（如BTR），不传则返回所有币种 |

**响应：**
```json
{
  "success": true,
  "symbol": "BTR" | null,
  "count": 45,
  "signals": [...]
}
```

### 2. 获取准确性分析

**接口：** `GET /api/signal-accuracy`

**参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| symbol | string | 否 | 币种符号 |
| hours | int | 否 | 分析时间范围（小时），默认48 |

**响应：**
```json
{
  "success": true,
  "symbol": "BTR" | null,
  "analysis": {
    "total_signals": 45,
    "long_count": 15,
    "short_count": 10,
    "no_trade_count": 20,
    "long_percentage": 33.33,
    "short_percentage": 22.22,
    "no_trade_percentage": 44.44,
    "time_range_hours": 48,
    "oldest_signal": "2026-01-20 10:00:00",
    "newest_signal": "2026-01-22 10:00:00"
  }
}
```

### 3. 手动清理旧数据

**接口：** `GET /api/cleanup-old-signals`

**参数：**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| hours | int | 否 | 清理阈值（小时），默认48 |

**响应：**
```json
{
  "success": true,
  "deleted_count": 125,
  "message": "清理了125条超过48小时的旧信号"
}
```

---

## 📦 数据保留策略

### 1. 为什么是48小时？

**合理性分析：**
- ✅ **足够回溯**：覆盖2个完整的交易日
- ✅ **数据量可控**：避免数据库膨胀
- ✅ **性能保证**：查询速度快
- ✅ **存储成本**：控制磁盘占用

**数据量估算：**
```
假设：
- 3个币种
- 每60秒刷新一次
- 每次产生1条记录

48小时记录数：
3 × (48 × 60) = 8,640 条

数据库大小：
约 1-2 MB
```

### 2. 如何修改保留时长？

**方法1：修改自动清理配置**

编辑 `btc_web_app_multi.py`:
```python
# 原配置：48小时
time.sleep(6 * 3600)  # 每6小时
db.cleanup_old_signals(hours=48)

# 修改为72小时
time.sleep(6 * 3600)  # 每6小时
db.cleanup_old_signals(hours=72)
```

**方法2：手动清理时指定**
```bash
# 清理72小时前的数据
curl http://localhost:5001/api/cleanup-old-signals?hours=72
```

**建议配置：**
| 场景 | 保留时长 | 清理频率 | 数据量 |
|------|---------|---------|--------|
| **默认** | 48小时 | 6小时 | ~9K条 |
| **短期** | 24小时 | 6小时 | ~4K条 |
| **长期** | 72小时 | 12小时 | ~13K条 |
| **测试** | 6小时 | 1小时 | ~1K条 |

---

## 🛠️ 技术实现

### 1. 数据库层（database.py）

#### **新增方法1：获取48小时记录**

```python
def get_signals_last_48h(self, symbol=None):
    """获取最近48小时的信号记录"""
    time_48h_ago = (datetime.now() - timedelta(hours=48)).strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute("""
        SELECT * FROM market_signals 
        WHERE timestamp >= ? 
        ORDER BY timestamp DESC
    """, (time_48h_ago,))
```

#### **新增方法2：清理旧数据**

```python
def cleanup_old_signals(self, hours=48):
    """清理超过指定小时数的旧信号"""
    time_threshold = (datetime.now() - timedelta(hours=hours)).strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute("""
        DELETE FROM market_signals 
        WHERE timestamp < ?
    """, (time_threshold,))
```

#### **新增方法3：准确性分析**

```python
def get_signal_accuracy_analysis(self, symbol=None, hours=48):
    """分析信号准确性"""
    signals = self.get_signals_last_48h(symbol)
    
    # 统计各类型信号
    long_count = sum(1 for s in signals if s['trade_action'] == 'LONG')
    short_count = sum(1 for s in signals if s['trade_action'] == 'SHORT')
    no_trade_count = sum(1 for s in signals if s['trade_action'] == 'NO_TRADE')
    
    return {
        'total_signals': len(signals),
        'long_count': long_count,
        'short_count': short_count,
        'no_trade_count': no_trade_count,
        ...
    }
```

### 2. API层（btc_web_app_multi.py）

#### **API端点1：获取历史记录**

```python
@app.route('/api/signals-48h')
def api_signals_48h():
    symbol = request.args.get('symbol', None)
    db = get_signal_db()
    signals = db.get_signals_last_48h(symbol)
    
    return jsonify({
        'success': True,
        'symbol': symbol,
        'count': len(signals),
        'signals': signals
    })
```

#### **API端点2：准确性分析**

```python
@app.route('/api/signal-accuracy')
def api_signal_accuracy():
    symbol = request.args.get('symbol', None)
    hours = int(request.args.get('hours', 48))
    
    db = get_signal_db()
    analysis = db.get_signal_accuracy_analysis(symbol, hours)
    
    return jsonify({
        'success': True,
        'symbol': symbol,
        'analysis': analysis
    })
```

#### **API端点3：手动清理**

```python
@app.route('/api/cleanup-old-signals')
def api_cleanup_old_signals():
    hours = int(request.args.get('hours', 48))
    db = get_signal_db()
    deleted_count = db.cleanup_old_signals(hours)
    
    return jsonify({
        'success': True,
        'deleted_count': deleted_count,
        'message': f'清理了{deleted_count}条超过{hours}小时的旧信号'
    })
```

#### **自动清理调度器**

```python
class SignalCleanupScheduler:
    """每6小时清理一次旧信号"""
    
    def _cleanup_loop(self):
        while self.running:
            time.sleep(6 * 3600)  # 6小时
            if self.running:
                db = get_signal_db()
                deleted = db.cleanup_old_signals(hours=48)
                if deleted > 0:
                    logger.info(f"自动清理了{deleted}条旧信号记录")
```

### 3. 前端层（history.html + JS + CSS）

#### **数据加载**

```javascript
async function loadSignals() {
    const [signalsRes, accuracyRes] = await Promise.all([
        fetch('/api/signals-48h'),
        fetch('/api/signal-accuracy')
    ]);
    
    const signalsData = await signalsRes.json();
    const accuracyData = await accuracyRes.json();
    
    // 更新界面
    updateStatistics(accuracyData.analysis);
    renderSignals(signalsData.signals);
}
```

#### **筛选功能**

```javascript
function applyFilters() {
    const symbolFilter = document.getElementById('symbolFilter').value;
    const actionFilter = document.getElementById('actionFilter').value;
    
    filteredSignals = allSignals.filter(signal => {
        let match = true;
        if (symbolFilter && signal.symbol !== symbolFilter) match = false;
        if (actionFilter && signal.trade_action !== actionFilter) match = false;
        return match;
    });
    
    renderSignals();
}
```

#### **分页功能**

```javascript
function renderSignals() {
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageSignals = filteredSignals.slice(start, end);
    
    // 渲染当前页的信号
    pageSignals.forEach(signal => {
        html += renderSignalCard(signal);
    });
}
```

---

## 📚 使用场景

### 场景1：评估信号质量

**需求：**
查看最近48小时的信号分布，评估做多/做空/观望的比例是否合理。

**操作：**
1. 访问 http://localhost:5001/history
2. 查看统计概览卡片
3. 分析各类型信号占比

**判断标准：**
- **保守策略**：NO_TRADE > 60%
- **激进策略**：LONG + SHORT > 60%
- **平衡策略**：NO_TRADE ≈ 40-50%

### 场景2：回溯特定币种

**需求：**
查看BTR在过去48小时的所有交易信号，分析其市场状态变化。

**操作：**
1. 选择币种筛选器：BTR
2. 查看时间线上的信号变化
3. 分析状态转换逻辑

**关注点：**
- 做多/做空切换频率
- 观望期持续时长
- 价格与信号的关联

### 场景3：性能优化

**需求：**
数据库文件过大，需要清理旧数据。

**操作：**
1. 点击"清理旧数据"按钮
2. 确认清理
3. 查看清理结果

**效果：**
- 减少数据库文件大小
- 提升查询速度
- 释放磁盘空间

---

## ✅ 总结

### 功能清单

- [x] 48小时历史记录
- [x] 统计概览
- [x] 准确性分析
- [x] 币种筛选
- [x] 类型筛选
- [x] 分页展示
- [x] 自动刷新
- [x] 手动刷新
- [x] 自动清理
- [x] 手动清理
- [x] 详情展开/收起

### 访问入口

| 入口 | URL | 说明 |
|------|-----|------|
| **主页** | http://localhost:5001/ | 实时行情 |
| **历史记录** | http://localhost:5001/history | 48小时历史 |

### 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **后端** | Flask + Python | API服务 |
| **数据库** | SQLite | 数据存储 |
| **前端** | HTML5 + CSS3 + JavaScript | 界面展示 |
| **调度** | Threading | 定时清理 |

---

**最后更新：2026-01-20**  
**版本：v3.0+**  
**状态：✅ 已生产验证**
