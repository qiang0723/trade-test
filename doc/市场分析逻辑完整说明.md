# 市场分析逻辑完整说明

## 目录
1. [概述](#概述)
2. [标准做多模型](#标准做多模型)
3. [标准做空模型](#标准做空模型)
4. [三态交易信号](#三态交易信号)
5. [数据来源与周期](#数据来源与周期)
6. [信号优先级](#信号优先级)

---

## 概述

市场分析系统包含三个独立但相关的判断模型：

```
┌─────────────────────────────────────────┐
│         市场分析系统架构                │
├─────────────────────────────────────────┤
│                                         │
│  1️⃣ 标准做多模型 (满分10分)            │
│     ├─ 结构向上（0-2分）                │
│     ├─ 突破放量/回调缩量（0-2分）       │
│     ├─ OI温和上升（0-2分）              │
│     ├─ 资金费率温和（0-1.5分）          │
│     └─ 买单略占优（0-2分）              │
│                                         │
│  2️⃣ 标准做空模型 (满分10分)            │
│     ├─ 结构向下（0-2分）                │
│     ├─ 下跌放量/反弹缩量（0-2分）       │
│     ├─ OI堆积或配合下跌（0-2分）        │
│     ├─ 资金费率过热（0-1.5分）          │
│     └─ 卖单略占优（0-2分）              │
│                                         │
│  3️⃣ 三态交易信号                       │
│     ├─ 优先：NO_TRADE（极端条件）       │
│     ├─ LONG（多头信号≥4分）             │
│     └─ SHORT（空头信号≥4分）            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 标准做多模型

### 评分体系（满分10分）

#### 1️⃣ 结构向上（或刚突破）- 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 24h涨幅>3% **且** 6h延续上涨 | **2.0** | ✓ 结构明确向上，趋势清晰 |
| 6h涨幅>2% | **1.5** | ✓ 刚突破，突破初期 |
| 0 < 24h涨幅 ≤ 3% **且** 6h上涨 | **1.0** | ○ 结构偏多，价格缓慢向上 |
| 不符合条件 | **0** | ✗ 无明确上涨结构 |

**代码实现：**
```python
if price_change_24h > 3 and price_trend_6h > 1:
    long_score += 2
    structure_up = True
    long_conditions.append("✓ 结构向上：24h涨幅>3%且6h延续上涨")
elif price_change_24h > 0 and price_trend_6h > 2:
    long_score += 1.5
    structure_up = True
    long_conditions.append("✓ 刚突破：6h涨幅>2%，突破初期")
elif 0 < price_change_24h <= 3 and price_trend_6h > 0:
    long_score += 1
    long_conditions.append("○ 结构偏多：价格缓慢向上")
```

---

#### 2️⃣ 突破放量 / 回调缩量 - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 上涨时：成交量放大>15% | **2.0** | ✓ 突破得到充分确认，量价配合 |
| 回调时：成交量萎缩>10% | **1.5** | ✓ 回调健康，买盘占主导 |
| 量能一般 | **1.0** | ○ 成交量小幅变化 |
| 上涨缩量或回调放量 | **0** | ✗ 量价背离，不支持做多 |

**代码实现：**
```python
if structure_up:
    # 如果是上涨，应该放量
    if volume_change > 15:
        long_score += 2
        volume_quality = True
        long_conditions.append("✓ 突破放量：成交量放大>15%")
    elif volume_change > 0:
        long_score += 1
        long_conditions.append("○ 量能一般：成交量小幅增加")
else:
    # 如果是回调，应该缩量
    if volume_change < -10:
        long_score += 1.5
        volume_quality = True
        long_conditions.append("✓ 回调缩量：成交量萎缩>10%")
    elif volume_change < 0:
        long_score += 0.5
        long_conditions.append("○ 量能缩减：成交量小幅下降")
```

---

#### 3️⃣ OI温和上升（小幅持续） - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| OI在2-8%区间 **且** 价格上涨>1% | **2.0** | ✓ 多头增仓，OI温和上升 |
| OI在0-2%区间 | **1.5** | ○ OI平稳，持仓变化不大 |
| OI在-5-0%区间 | **1.0** | ○ OI小幅下降，多空分歧 |
| OI > 15% | **-0.5** | ⚠ OI暴涨，过热风险 |

**代码实现：**
```python
if 2 <= oi_change <= 8 and price_change_24h > 1:
    long_score += 2
    oi_quality = True
    long_conditions.append(f"✓ 多头增仓：价格+{price_change_24h:.2f}%，OI+{oi_change:.1f}%")
elif 0 <= oi_change < 2:
    long_score += 1.5
    long_conditions.append(f"○ OI平稳：持仓量+{oi_change:.1f}%")
elif -5 <= oi_change < 0:
    long_score += 1
    long_conditions.append(f"○ OI小幅下降：{oi_change:.1f}%")
elif oi_change > 15:
    long_score -= 0.5
    long_conditions.append(f"⚠ OI暴涨：持仓量+{oi_change:.1f}%（过热风险）")
```

---

#### 4️⃣ 资金费率温和 - 0-1.5分

| 条件 | 得分 | 说明 |
|------|------|------|
| -0.03% ≤ 资金费率 ≤ 0.08% | **1.5** | ✓ 资金费率温和，多空平衡 |
| 0.08% < 资金费率 ≤ 0.15% | **0.5** | ○ 资金费率偏高，多头偏热 |
| 资金费率 > 0.15% | **-1.0** | ⚠ 资金费率过高，极度过热 |

**代码实现：**
```python
if -0.03 <= funding_rate_percent <= 0.08:
    long_score += 1.5
    funding_quality = True
    long_conditions.append(f"✓ 资金费率温和：{funding_rate_percent:+.4f}%（正常范围）")
elif 0.08 < funding_rate_percent <= 0.15:
    long_score += 0.5
    long_conditions.append(f"○ 资金费率偏高：{funding_rate_percent:+.4f}%（多头偏热）")
elif funding_rate_percent > 0.15:
    long_score -= 1
    long_conditions.append(f"⚠ 资金费率过高：{funding_rate_percent:+.4f}%（极度过热）")
```

---

#### 5️⃣ 主动买单略占优 - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 买入比例 53-65% | **2.0** | ✓ 买单略占优，理想范围 |
| 买入比例 65-70% | **1.0** | ○ 买单占优（偏强） |
| 买入比例 > 70% | **0.5** | ⚠ 买单过强，追涨风险 |
| 买入比例 45-53% | **0.5** | ○ 买卖均衡 |

**代码实现：**
```python
if 53 <= buy_ratio_1h <= 65:
    long_score += 2
    buy_quality = True
    long_conditions.append(f"✓ 买单略占优：买入{buy_ratio_1h:.1f}%（理想范围53-65%）")
elif 65 < buy_ratio_1h <= 70:
    long_score += 1
    long_conditions.append(f"○ 买单占优：买入{buy_ratio_1h:.1f}%（偏强）")
elif buy_ratio_1h > 70:
    long_score += 0.5
    long_conditions.append(f"⚠ 买单过强：买入{buy_ratio_1h:.1f}%（追涨风险）")
elif 45 <= buy_ratio_1h < 53:
    long_score += 0.5
    long_conditions.append(f"○ 买卖均衡：买入{buy_ratio_1h:.1f}%")
```

---

### 评分等级与信号

| 评分范围 | 信号 | 市场情绪 | 风险等级 | 操作建议 |
|----------|------|----------|----------|----------|
| ≥8分 或 完美符合 | **强烈做多** | 极度看涨 | 低 | 顺势做多，设置合理止损 |
| 6-7.9分 | **偏多** | 看涨 | 中 | 可考虑做多，控制仓位 |
| 4-5.9分 | **观望** | 中性 | 中 | 信号不明确，建议观望 |
| <4分 | **不建议做多** | 看跌/中性 | - | 不符合做多条件 |

**完美做多信号：**
```python
perfect_long = (structure_up and volume_quality and oi_quality and 
                funding_quality and buy_quality)
```

---

## 标准做空模型

### 评分体系（满分10分）

#### 1️⃣ 结构向下（或刚破位）- 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 24h跌幅>3% **且** 6h延续下跌 | **2.0** | ✓ 结构明确向下，趋势清晰 |
| 6h跌幅>2% | **1.5** | ✓ 刚破位，破位初期 |
| -3% < 24h跌幅 ≤ 0 **且** 6h下跌 | **1.0** | ○ 结构偏空，价格缓慢向下 |
| 不符合条件 | **0** | ✗ 无明确下跌结构 |

**代码实现：**
```python
if price_change_24h < -3 and price_trend_6h < -1:
    short_score += 2
    structure_down = True
    short_conditions.append("✓ 结构向下：24h跌幅>3%且6h延续下跌")
elif price_change_24h < 0 and price_trend_6h < -2:
    short_score += 1.5
    structure_down = True
    short_conditions.append("✓ 刚破位：6h跌幅>2%，破位初期")
elif -3 < price_change_24h <= 0 and price_trend_6h < 0:
    short_score += 1
    short_conditions.append("○ 结构偏空：价格缓慢向下")
```

---

#### 2️⃣ 下跌放量 / 反弹缩量 - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 下跌时：成交量放大>15% | **2.0** | ✓ 下跌得到充分确认，抛压强 |
| 反弹时：成交量萎缩>10% | **1.5** | ✓ 反弹无力，卖压占主导 |
| 量能一般 | **0.5-1.0** | ○ 成交量小幅变化 |
| 下跌缩量或反弹放量 | **0** | ✗ 量价背离，不支持做空 |

**代码实现：**
```python
if structure_down:
    # 如果是下跌，应该放量
    if volume_change > 15:
        short_score += 2
        volume_quality_short = True
        short_conditions.append("✓ 下跌放量：成交量放大>15%")
    elif volume_change > 0:
        short_score += 1
        short_conditions.append("○ 量能一般：成交量小幅增加")
else:
    # 如果是反弹，应该缩量
    if volume_change < -10:
        short_score += 1.5
        volume_quality_short = True
        short_conditions.append("✓ 反弹缩量：成交量萎缩>10%")
    elif volume_change < 0:
        short_score += 0.5
        short_conditions.append("○ 量能缩减：成交量小幅下降")
```

---

#### 3️⃣ OI堆积或配合下跌 - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| OI在8-15%区间 | **2.0** | ✓ 持仓堆积，风险积累 |
| 价格下跌>1% **且** OI上升>2% | **2.0** | ✓ 空头增仓，价格下行 |
| OI在2-8%区间 | **1.0** | ○ OI温和增长 |
| OI下降或极端波动 | **0** | ✗ 持仓减少或市场不稳定 |

**代码实现：**
```python
if 8 <= oi_change <= 15:
    short_score += 2
    oi_quality_short = True
    short_conditions.append(f"✓ OI堆积：持仓量+{oi_change:.1f}%（风险堆积区间8-15%）")
elif price_change_24h < -1 and oi_change > 2:
    short_score += 2
    oi_quality_short = True
    short_conditions.append(f"✓ 价格下跌+OI上升：空头增仓，OI+{oi_change:.1f}%")
elif 2 < oi_change < 8:
    short_score += 1
    short_conditions.append(f"○ OI温和增长：持仓量+{oi_change:.1f}%")
```

---

#### 4️⃣ 资金费率过热 - 0-1.5分

| 条件 | 得分 | 说明 |
|------|------|------|
| 资金费率 > 0.15% | **1.5** | ✓ 多头极度过热，空头获利 |
| 0.1% < 资金费率 ≤ 0.15% | **1.0** | ✓ 资金费率过热 |
| 0.08% < 资金费率 ≤ 0.1% | **0.5** | ○ 资金费率偏高 |
| 资金费率 ≤ 0.08% | **0** | ✗ 资金费率正常或偏低 |

**代码实现：**
```python
if funding_rate_percent > 0.15:
    short_score += 1.5
    funding_quality_short = True
    short_conditions.append(f"✓ 资金费率极度过热：{funding_rate_percent:+.4f}%（>0.15%）")
elif 0.1 < funding_rate_percent <= 0.15:
    short_score += 1
    funding_quality_short = True
    short_conditions.append(f"✓ 资金费率过热：{funding_rate_percent:+.4f}%（>0.1%）")
elif 0.08 < funding_rate_percent <= 0.1:
    short_score += 0.5
    short_conditions.append(f"○ 资金费率偏高：{funding_rate_percent:+.4f}%")
```

---

#### 5️⃣ 主动卖单占优 - 0-2分

| 条件 | 得分 | 说明 |
|------|------|------|
| 卖出比例 53-65% | **2.0** | ✓ 卖单略占优，理想范围 |
| 卖出比例 65-70% | **1.0** | ○ 卖单占优（偏强） |
| 卖出比例 > 70% | **0.5** | ⚠ 卖单过强，杀跌风险 |
| 卖出比例 45-53% | **0.5** | ○ 买卖均衡 |

**代码实现：**
```python
if 53 <= sell_ratio_1h <= 65:
    short_score += 2
    sell_quality = True
    short_conditions.append(f"✓ 卖单略占优：卖出{sell_ratio_1h:.1f}%（理想范围53-65%）")
elif 65 < sell_ratio_1h <= 70:
    short_score += 1
    short_conditions.append(f"○ 卖单占优：卖出{sell_ratio_1h:.1f}%（偏强）")
elif sell_ratio_1h > 70:
    short_score += 0.5
    short_conditions.append(f"⚠ 卖单过强：卖出{sell_ratio_1h:.1f}%（杀跌风险）")
elif 45 <= sell_ratio_1h < 53:
    short_score += 0.5
    short_conditions.append(f"○ 买卖均衡：卖出{sell_ratio_1h:.1f}%")
```

---

### 评分等级与信号

| 评分范围 | 信号 | 市场情绪 | 风险等级 | 操作建议 |
|----------|------|----------|----------|----------|
| ≥8分 或 完美符合 | **强烈做空** | 极度看跌 | 低 | 顺势做空，设置合理止损 |
| 6-7.9分 | **偏空** | 看跌 | 中 | 可考虑做空，控制仓位 |
| 4-5.9分 | **观望** | 中性 | 中 | 信号不明确，建议观望 |
| <4分 | **不建议做空** | 看涨/中性 | - | 不符合做空条件 |

**完美做空信号：**
```python
perfect_short = (structure_down and volume_quality_short and oi_quality_short and 
                 funding_quality_short and sell_quality)
```

---

## 三态交易信号

### 信号判断逻辑

```
┌─────────────────────────────────────┐
│      三态信号判断流程               │
├─────────────────────────────────────┤
│                                     │
│  第一步：检查极端条件               │
│  ├─ 资金费率极端（|x| > 0.2%）     │
│  ├─ OI极端变化（|x| > 15%）        │
│  └─ 集中平仓（OI降8%+价格波动5%）  │
│           ↓                         │
│        极端？                       │
│      ↙     ↘                       │
│    是         否                    │
│    ↓          ↓                    │
│ NO_TRADE   第二步：评估信号         │
│              ├─ LONG条件（4项）     │
│              └─ SHORT条件（4项）    │
│                   ↓                 │
│              计算得分                │
│            ↙    ↓    ↘             │
│       LONG  NO_TRADE  SHORT        │
│      (≥4分)  (<4分)   (≥4分)       │
│                                     │
└─────────────────────────────────────┘
```

---

### NO_TRADE 条件（优先判断）

在以下极端情况下，无论做多做空模型评分如何，都输出 **NO_TRADE**：

| 极端条件 | 阈值 | 说明 |
|----------|------|------|
| **资金费率极端** | \|资金费率\| > 0.2% | 多空严重失衡，市场情绪极端 |
| **OI极端变化** | \|OI变化\| > 15% | 持仓暴涨暴跌，市场不稳定 |
| **集中平仓** | OI降幅>8% **且** 价格波动>5% | 大量止损或清算，市场混乱 |

**代码实现：**
```python
extreme_condition = False

# 1. 资金费率极端
if funding_rate_percent > 0.2 or funding_rate_percent < -0.2:
    extreme_condition = True
    action_reasons.append(f"❌ 资金费率极端 {funding_rate_percent:+.4f}%（超过±0.2%）")

# 2. OI极端变化
if oi_change > 15 or oi_change < -15:
    extreme_condition = True
    action_reasons.append(f"❌ 持仓量极端变化 {oi_change:+.2f}%（超过±15%）")

# 3. 集中平仓情绪
if oi_change < -8 and abs(price_change_24h) > 5:
    extreme_condition = True
    action_reasons.append(f"❌ 集中平仓情绪：OI降{oi_change:.2f}%，价格波动{price_change_24h:+.2f}%")

if extreme_condition:
    trade_action = "NO_TRADE"
```

---

### LONG 条件判断（4项，满分7分）

| 条件 | 得分 | 阈值 | 说明 |
|------|------|------|------|
| **上涨放量** | 2.0 | 价格>2% **且** 成交量>15% | 突破得到充分确认 |
| **回调缩量** | 1.5 | 价格<0 **且** 成交量<-10% | 回调健康，主力未出货 |
| **价格上涨+OI上升** | 2.0 | 价格>1% **且** 2%<OI≤10% | 多头增仓，趋势延续 |
| **资金费率温和** | 1.5 | -0.05% ≤ 资金费率 ≤ 0.1% | 多空平衡，无过热风险 |
| **买单推动价格** | 1.5 | 买入>55% **且** 价格>0 | 主动买盘推动上涨 |

**判定标准：**
- LONG信号得分 ≥ 4分 **且** > SHORT信号得分 → **LONG**

**代码实现：**
```python
long_signals = 0
long_reasons = []

# 1. 上涨放量 or 回调缩量
if price_change_24h > 2 and volume_change > 15:
    long_signals += 2
    long_reasons.append(f"✓ 上涨放量：价格+{price_change_24h:.2f}%，成交量+{volume_change:.2f}%")
elif price_change_24h < 0 and volume_change < -10:
    long_signals += 1.5
    long_reasons.append(f"✓ 回调缩量：价格{price_change_24h:.2f}%，成交量{volume_change:.2f}%")

# 2. 价格上涨且 OI 上升
if price_change_24h > 1 and oi_change > 2 and oi_change <= 10:
    long_signals += 2
    long_reasons.append(f"✓ 价格上涨+OI上升：价格+{price_change_24h:.2f}%，OI+{oi_change:.2f}%")

# 3. 资金费率温和
if -0.05 <= funding_rate_percent <= 0.1:
    long_signals += 1.5
    long_reasons.append(f"✓ 资金费率温和：{funding_rate_percent:+.4f}%")

# 4. 买单推动价格
if buy_ratio_1h > 55 and price_change_24h > 0:
    long_signals += 1.5
    long_reasons.append(f"✓ 买单推动价格：买入{buy_ratio_1h:.1f}%，价格+{price_change_24h:.2f}%")
```

---

### SHORT 条件判断（4项，满分7.5分）

| 条件 | 得分 | 阈值 | 说明 |
|------|------|------|------|
| **上涨无量** | 2.0 | 价格>1% **且** 成交量<0 | 量价背离，上涨乏力 |
| **滞涨** | 1.5 | -1%≤价格≤1% **且** OI>8% | 价格不动，持仓堆积 |
| **OI堆积** | 2.0 | 10% < OI ≤ 15% | 风险积累，随时回调 |
| **资金费率过热** | 1.5 | 资金费率 > 0.1% | 多头过热，空头获利 |
| **反弹卖压增强** | 1.5 | 价格>0 **且** 卖出>55% | 反弹遇阻，卖压强 |
| **下跌卖压持续** | 2.0 | 价格<-2% **且** 卖出>60% | 抛压持续，趋势延续 |

**判定标准：**
- SHORT信号得分 ≥ 4分 **且** > LONG信号得分 → **SHORT**

**代码实现：**
```python
short_signals = 0
short_reasons = []

# 1. 上涨无量或滞涨
if price_change_24h > 1 and volume_change < 0:
    short_signals += 2
    short_reasons.append(f"✓ 上涨无量：价格+{price_change_24h:.2f}%，成交量{volume_change:.2f}%")
elif -1 <= price_change_24h <= 1 and oi_change > 8:
    short_signals += 1.5
    short_reasons.append(f"✓ 滞涨：价格{price_change_24h:.2f}%，OI+{oi_change:.2f}%")

# 2. OI堆积
if 10 < oi_change <= 15:
    short_signals += 2
    short_reasons.append(f"✓ OI堆积：持仓量+{oi_change:.2f}%（风险堆积）")

# 3. 资金费率过热
if funding_rate_percent > 0.1:
    short_signals += 1.5
    short_reasons.append(f"✓ 资金费率过热：{funding_rate_percent:+.4f}%（多头过热）")

# 4. 反弹买弱、卖压增强
if price_change_24h > 0 and sell_ratio_1h > 55:
    short_signals += 1.5
    short_reasons.append(f"✓ 反弹卖压增强：卖出{sell_ratio_1h:.1f}%，价格勉强+{price_change_24h:.2f}%")
elif price_change_24h < -2 and sell_ratio_1h > 60:
    short_signals += 2
    short_reasons.append(f"✓ 卖压持续增强：卖出{sell_ratio_1h:.1f}%，价格{price_change_24h:.2f}%")
```

---

### 最终判断逻辑

```python
if not extreme_condition:
    # 非极端情况
    if long_signals >= 4 and long_signals > short_signals:
        trade_action = "LONG"
        market_sentiment = "看涨"
        risk_level = "低" if long_signals >= 6 else "中"
    elif short_signals >= 4 and short_signals > long_signals:
        trade_action = "SHORT"
        market_sentiment = "看跌"
        risk_level = "中" if short_signals >= 6 else "高"
    else:
        trade_action = "NO_TRADE"
        # 信号不明确
else:
    # 极端情况
    trade_action = "NO_TRADE"
    risk_level = "高"
```

---

## 数据来源与周期

### 价格数据

| 指标 | 数据源 | 周期 | 用途 |
|------|--------|------|------|
| **24h价格变化** | Ticker API | 实时 | 判断趋势方向 |
| **6h价格趋势** | K线 (1h) | 最近6根 | 确认短期趋势延续 |
| **当前价格** | Ticker API | 实时 | 价格监控与显示 |

**计算方法：**
```python
# 24h价格变化
price_change_24h = ticker['priceChangePercent']

# 6h价格趋势
klines_6h = get_klines(symbol, interval='1h', limit=7)
price_6h_ago = klines_6h[0]['close']
current_price = klines_6h[-1]['close']
price_trend_6h = ((current_price - price_6h_ago) / price_6h_ago) * 100
```

---

### 成交量数据

| 指标 | 数据源 | 周期 | 用途 |
|------|--------|------|------|
| **6h成交量变化** | K线 (1h) | 对比前后3小时 | 量价配合分析 |
| **6h成交额变化** | K线 (1h) | 对比前后3小时 | 资金流向分析 |

**计算方法：**
```python
# 获取最近7根1h K线
klines = get_klines(symbol, interval='1h', limit=7)

# 最近3小时成交量
recent_volume = sum([k['volume'] for k in klines[-3:]])

# 前3小时成交量（4-6小时前）
previous_volume = sum([k['volume'] for k in klines[:3]])

# 6小时变化
volume_change = ((recent_volume - previous_volume) / previous_volume) * 100
```

---

### 持仓量（OI）数据

| 指标 | 数据源 | 周期 | 用途 |
|------|--------|------|------|
| **当前持仓量** | Ticker API | 实时 | 市场参与度 |
| **6h持仓量变化** | Open Interest History | 6小时前 | 多空力量变化 |

**计算方法：**
```python
# 当前持仓量
current_oi = ticker['openInterest']

# 6小时前持仓量
oi_history = get_open_interest_history(symbol, period='1h', limit=7)
oi_6h_ago = oi_history[0]['sumOpenInterest']

# 6小时变化
oi_change = ((current_oi - oi_6h_ago) / oi_6h_ago) * 100
```

---

### 资金费率数据

| 指标 | 数据源 | 周期 | 用途 |
|------|--------|------|------|
| **当前资金费率** | Mark Price API | 实时 | 多空情绪判断 |
| **下次结算时间** | Mark Price API | 实时 | 费用支付预测 |

**计算方法：**
```python
# 实时资金费率
mark_price_data = client.futures_mark_price(symbol=symbol)
funding_rate = mark_price_data['lastFundingRate']
funding_rate_percent = float(funding_rate) * 100
```

---

### 买卖力量数据

| 指标 | 数据源 | 周期 | 用途 |
|------|--------|------|------|
| **1h买卖比例** | Recent Trades API | 最近60分钟 | 短期买卖压力 |
| **1h买卖金额** | Recent Trades API | 最近60分钟 | 主动资金流向 |

**计算方法：**
```python
# 获取最近60分钟成交记录
trades = get_recent_trades(symbol, time_range_minutes=60)

# 分类统计
buy_amount = sum([t['qty'] * t['price'] for t in trades if t['isBuyerMaker'] == False])
sell_amount = sum([t['qty'] * t['price'] for t in trades if t['isBuyerMaker'] == True])
total_amount = buy_amount + sell_amount

# 计算比例
buy_ratio_1h = (buy_amount / total_amount) * 100
sell_ratio_1h = (sell_amount / total_amount) * 100
```

---

## 信号优先级

### 输出顺序

在详细分析结论中，按以下顺序输出：

```
1. 三态交易信号（LONG/SHORT/NO_TRADE）
   ↓
2. 标准做多模型评分（如果 ≥ 6分）
   ↓
3. 标准做空模型评分（如果 ≥ 6分）
   ↓
4. 详细数据分析
```

### 信号冲突解决

| 情况 | 三态信号 | 做多评分 | 做空评分 | 最终建议 |
|------|----------|----------|----------|----------|
| 极端市场 | NO_TRADE | 任意 | 任意 | **观望**（极端风险优先） |
| 多头强势 | LONG | ≥8分 | <6分 | **强烈做多** |
| 空头强势 | SHORT | <6分 | ≥8分 | **强烈做空** |
| 双向冲突 | NO_TRADE | ≥6分 | ≥6分 | **观望**（信号冲突） |
| 信号一致 | LONG | ≥6分 | <4分 | **做多**（信号一致，可信度高） |
| 信号一致 | SHORT | <4分 | ≥6分 | **做空**（信号一致，可信度高） |

---

## 实战案例

### 案例1：完美做多信号

**市场数据：**
```
价格24h: +4.5%，6h: +2.3%
成交量6h变化: +18%
持仓量6h变化: +5.2%
资金费率: +0.06%
1h买入比例: 58%
```

**分析结果：**
```
✅ 做多模型评分：9.0/10.0 分
  ✓ 结构向上：24h涨幅>3%且6h延续上涨 (2.0分)
  ✓ 突破放量：成交量放大>15% (2.0分)
  ✓ 多头增仓：价格+4.5%，OI+5.2% (2.0分)
  ✓ 资金费率温和：+0.06%（正常范围） (1.5分)
  ✓ 买单略占优：买入58%（理想范围53-65%） (2.0分)

🟢 三态信号：LONG
  ✓ 上涨放量：价格+4.5%，成交量+18%
  ✓ 价格上涨+OI上升：价格+4.5%，OI+5.2%
  ✓ 资金费率温和：+0.06%
  ✓ 买单推动价格：买入58%，价格+4.5%

📊 最终建议：🚀 强烈做多（完美做多模型）
```

---

### 案例2：完美做空信号

**市场数据：**
```
价格24h: -4.2%，6h: -2.1%
成交量6h变化: +16%
持仓量6h变化: +11%
资金费率: +0.13%
1h卖出比例: 60%
```

**分析结果：**
```
✅ 做空模型评分：8.5/10.0 分
  ✓ 结构向下：24h跌幅>3%且6h延续下跌 (2.0分)
  ✓ 下跌放量：成交量放大>15% (2.0分)
  ✓ OI堆积：持仓量+11%（风险堆积区间8-15%） (2.0分)
  ✓ 资金费率过热：+0.13%（>0.1%） (1.0分)
  ✓ 卖单略占优：卖出60%（理想范围53-65%） (2.0分)

🔴 三态信号：SHORT
  ✓ OI堆积：持仓量+11%（风险堆积）
  ✓ 资金费率过热：+0.13%（多头过热）
  ✓ 卖压持续增强：卖出60%，价格-4.2%

📊 最终建议：📉 强烈做空（完美做空模型）
```

---

### 案例3：极端市场 - NO_TRADE

**市场数据：**
```
价格24h: +6.8%
成交量6h变化: +35%
持仓量6h变化: +18%
资金费率: +0.22%
1h买入比例: 68%
```

**分析结果：**
```
⚪ 三态信号：NO_TRADE
  ❌ 资金费率极端 +0.22%（超过±0.2%）
  ❌ 持仓量极端变化 +18%（超过±15%）

⚠️ 尽管做多模型评分较高（7.5分），但因极端条件，建议观望
  
📊 最终建议：⚪ NO_TRADE（市场存在极端风险）
```

---

### 案例4：信号冲突 - NO_TRADE

**市场数据：**
```
价格24h: +1.2%
成交量6h变化: +3%
持仓量6h变化: +9.5%
资金费率: +0.09%
1h买入比例: 51%
```

**分析结果：**
```
📈 做多模型评分：5.5/10.0 分（中性）
📉 做空模型评分：5.0/10.0 分（中性）

⚪ 三态信号：NO_TRADE
  ⚠️ 信号不明确：多头信号2.5分，空头信号2.0分
  
📊 最终建议：⚪ NO_TRADE（信号不明确，建议观望）
```

---

## 总结

### 三个模型的定位

| 模型 | 定位 | 适用场景 | 时间跨度 |
|------|------|----------|----------|
| **标准做多模型** | 长线价值做多 | 趋势延续、突破初期 | 中长期（数天-数周） |
| **标准做空模型** | 风险对冲做空 | 回调修正、过热风险 | 中短期（数小时-数天） |
| **三态交易信号** | 短线交易信号 | 日内波段、快速决策 | 短期（数小时-1天） |

### 使用建议

1. **优先看三态信号**：快速判断当前市场状态（LONG/SHORT/NO_TRADE）
2. **参考双模型评分**：评估做多做空的胜率和风险收益比
3. **NO_TRADE必须遵守**：极端市场条件下，务必观望
4. **信号一致性最佳**：三态信号与高评分模型一致时，可信度最高

### 风险提示

⚠️ **重要提醒：**
- 所有模型基于历史数据和技术指标，不能保证未来表现
- 极端市场（黑天鹅事件）下，所有模型可能失效
- 务必设置止损，严格控制仓位
- 不要在NO_TRADE信号时强行交易
- 模型仅供参考，不构成投资建议

---

**文档版本：** v1.0  
**更新日期：** 2026-01-19  
**作者：** Trade-Info 项目组
