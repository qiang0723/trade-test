# L1 Advisory Layer - è¾“å…¥å£å¾„å¥‘çº¦ä¸ç¼ºå£ç­–ç•¥

**ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-23  
**çŠ¶æ€**: P0-07å®æ–½ - é˜²æ­¢æµ‹è¯•/ç”Ÿäº§é•¿æœŸæ¼‚ç§»çš„æ ¸å¿ƒå¥‘çº¦æ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

1. [è¾“å…¥å£å¾„å¥‘çº¦](#1-è¾“å…¥å£å¾„å¥‘çº¦)
2. [ç¼ºå¤±æ•°æ®ç­–ç•¥](#2-ç¼ºå¤±æ•°æ®ç­–ç•¥)
3. [Dualè¾“å‡ºç­–ç•¥](#3-dualè¾“å‡ºç­–ç•¥)
4. [é¢‘æ§ä¸ä¿¡å·é€æ˜](#4-é¢‘æ§ä¸ä¿¡å·é€æ˜)
5. [å­—æ®µçœŸç›¸é—­ç¯](#5-å­—æ®µçœŸç›¸é—­ç¯)
6. [æµ‹è¯•æ•°æ®è§„èŒƒ](#6-æµ‹è¯•æ•°æ®è§„èŒƒ)

---

## 1. è¾“å…¥å£å¾„å¥‘çº¦

### 1.1 metadata.percentage_formatï¼ˆå¿…éœ€ï¼‰

æ‰€æœ‰è¾“å…¥æ•°æ®**å¿…é¡»**åŒ…å« `_metadata` å­—æ®µï¼Œæ˜ç¡®å£°æ˜ç™¾åˆ†æ¯”å­—æ®µçš„æ ¼å¼ï¼š

```python
data = {
    'price_change_1h': 0.03,  # 3%çš„ä»·æ ¼å˜åŒ–
    'oi_change_6h': 0.15,     # 15%çš„OIå˜åŒ–
    '_metadata': {
        'percentage_format': 'decimal',  # å£°æ˜ï¼šå·²æ˜¯å°æ•°æ ¼å¼
        'source': 'market_data_cache',
        'version': '1.0'
    }
}
```

#### æœ‰æ•ˆå€¼

| å€¼ | å«ä¹‰ | ç¤ºä¾‹ | è½¬æ¢è¡Œä¸º |
|---|------|------|---------|
| `'decimal'` | **å°æ•°æ ¼å¼**ï¼ˆæ¨èï¼‰ | 0.05 è¡¨ç¤º 5% | è·³è¿‡è½¬æ¢ï¼Œç›´æ¥ä½¿ç”¨ |
| `'percent_point'` | **ç™¾åˆ†ç‚¹æ ¼å¼**ï¼ˆæ—§è¾“å…¥ï¼‰ | 5.0 è¡¨ç¤º 5% | é™¤ä»¥100è½¬æ¢ä¸ºå°æ•° |

#### ç¼ºå¤±metadataçš„å¤„ç†

```python
# å½“å‰ç­–ç•¥ï¼ˆv3.2ï¼‰
if '_metadata' not in data:
    logger.warning("Missing _metadata.percentage_format, assuming 'percent_point'")
    # å‡è®¾ä¸ºpercent_pointï¼ˆå‘åå…¼å®¹ï¼‰
    
# æœªæ¥ç­–ç•¥ï¼ˆv4.0è®¡åˆ’ï¼‰
if '_metadata' not in data:
    logger.error("Missing _metadata.percentage_format is not allowed")
    raise ValueError("Input contract violation: missing _metadata")
```

### 1.2 å£å¾„ä¸€è‡´æ€§ä¿è¯

**ç³»ç»Ÿå†…éƒ¨ç»Ÿä¸€ä½¿ç”¨å°æ•°æ ¼å¼**ï¼š

```
è¾“å…¥å±‚ï¼špercent_point/decimal â†’ MetricsNormalizer â†’ decimal
é…ç½®å±‚ï¼šå…¨éƒ¨ä½¿ç”¨decimalï¼ˆ0.05=5%ï¼‰
è®¡ç®—å±‚ï¼šå…¨éƒ¨ä½¿ç”¨decimal
è¾“å‡ºå±‚ï¼šå¯é€‰è½¬æ¢ä¸ºç™¾åˆ†æ¯”æ˜¾ç¤ºï¼ˆå‰ç«¯ï¼‰
```

**ç¡¬çº¦æŸ**ï¼š
- âœ… æ‰€æœ‰é…ç½®é˜ˆå€¼å¿…é¡»ä½¿ç”¨å°æ•°æ ¼å¼ï¼ˆå¯åŠ¨æ ¡éªŒç¬¬1é‡guardrailï¼‰
- âœ… è¾“å…¥å¿…é¡»å£°æ˜percentage_formatï¼ˆæµ‹è¯•/ç”Ÿäº§ä¸€è‡´ï¼‰
- âœ… å†…éƒ¨è®¡ç®—ä¸å¾—æ··ç”¨æ ¼å¼

---

## 2. ç¼ºå¤±æ•°æ®ç­–ç•¥

### 2.1 æ ¸å¿ƒåŸåˆ™ï¼šç¦æ­¢Noneâ†’0ä¼ªä¸­æ€§

**âŒ é”™è¯¯åšæ³•ï¼ˆä¼ªä¸­æ€§ï¼‰**:
```python
# è¿™ä¼šæŠŠ"æ•°æ®ç¼ºå¤±"ä¼ªè£…æˆ"0å˜åŒ–"
price_change = data.get('price_change_1h', 0) or 0
oi_change = data.get('oi_change_6h', 0)
```

**âœ… æ­£ç¡®åšæ³•ï¼ˆæ˜¾æ€§åŒ–ï¼‰**:
```python
# ä½¿ç”¨None-safeè¯»å–
price_change = self._num(data, 'price_change_1h')
if price_change is None:
    # æ˜¾æ€§æ ‡è®°æ•°æ®ç¼ºå¤±
    tags.append(ReasonTag.DATA_INCOMPLETE_MTF)
    return Decision.NO_TRADE, tags
```

### 2.2 ç¼ºå¤±å­—æ®µå®šä¹‰

#### Short-termå…³é”®å­—æ®µï¼ˆLTF = Low TimeFrameï¼‰
- `price_change_5m` / `price_change_15m`
- `oi_change_15m`
- `taker_imbalance_5m` / `taker_imbalance_15m`
- `volume_ratio_5m` / `volume_ratio_15m`

**ç¼ºå¤±å¤„ç†**:
```python
short_term = Decision.NO_TRADE
reason_tags = [ReasonTag.DATA_INCOMPLETE_LTF]
executable = False
```

#### Medium-termå…³é”®å­—æ®µï¼ˆMTF = Medium TimeFrameï¼‰
- `price_change_1h` / `price_change_6h`
- `oi_change_1h` / `oi_change_6h`
- `taker_imbalance_1h`
- `volume_1h`

**ç¼ºå¤±å¤„ç†**:
```python
medium_term = Decision.NO_TRADE
reason_tags = [ReasonTag.DATA_INCOMPLETE_MTF]
executable = False
```

### 2.3 æ•°æ®å®Œæ•´æ€§æ ‡ç­¾

æ–°å¢ReasonTagï¼ˆP0-07å®šä¹‰ï¼‰ï¼š

```python
# models/reason_tags.py
class ReasonTag(Enum):
    # ... ç°æœ‰æ ‡ç­¾ ...
    
    # æ•°æ®å®Œæ•´æ€§æ ‡ç­¾ï¼ˆP0-07æ–°å¢ï¼‰
    DATA_INCOMPLETE_LTF = "data_incomplete_ltf"    # çŸ­çº¿æ•°æ®ä¸å®Œæ•´
    DATA_INCOMPLETE_MTF = "data_incomplete_mtf"    # ä¸­çº¿æ•°æ®ä¸å®Œæ•´
    DATA_GAP_5M = "data_gap_5m"                    # 5åˆ†é’ŸKçº¿ç¼ºå£
    DATA_GAP_15M = "data_gap_15m"                  # 15åˆ†é’ŸKçº¿ç¼ºå£

# ExecutabilityLevelæ˜ å°„
REASON_TAG_EXECUTABILITY = {
    # ... ç°æœ‰æ˜ å°„ ...
    
    # æ•°æ®ä¸å®Œæ•´å¼ºåˆ¶BLOCK
    ReasonTag.DATA_INCOMPLETE_LTF: ExecutabilityLevel.BLOCK,
    ReasonTag.DATA_INCOMPLETE_MTF: ExecutabilityLevel.BLOCK,
    ReasonTag.DATA_GAP_5M: ExecutabilityLevel.BLOCK,
    ReasonTag.DATA_GAP_15M: ExecutabilityLevel.BLOCK,
}
```

### 2.4 None-safeå·¥å…·å‡½æ•°

**æ ‡å‡†è¯»å–å‡½æ•°**ï¼ˆå·²å­˜åœ¨äºhelper_utils.pyï¼‰:
```python
@staticmethod
def _num(data: Dict, key: str) -> Optional[float]:
    """None-safeè¯»å–æ•°å€¼ï¼Œä¸æä¾›é»˜è®¤å€¼"""
    val = data.get(key)
    if val is None:
        return None
    try:
        return float(val)
    except (ValueError, TypeError):
        return None
```

**ç¦æ­¢ä½¿ç”¨çš„æ¨¡å¼**:
```python
# âŒ ä¸è¦ç”¨defaultå‚æ•°ä¼ªè£…ç¼ºå¤±
data.get('price_change_1h', 0)
data.get('oi_change_6h', 0) or 0
self._num(data, 'volume_ratio', default=1.0)  # ä¸å­˜åœ¨defaultå‚æ•°
```

---

## 3. Dualè¾“å‡ºç­–ç•¥

### 3.1 ç‹¬ç«‹è¯„ä¼°åŸåˆ™

**ç¡¬çº¦æŸ**: short_termå’Œmedium_termå¿…é¡»ç‹¬ç«‹è¯„ä¼°ï¼Œäº’ä¸çŸ­è·¯ã€‚

```python
def on_new_tick_dual(self, symbol: str, data: Dict) -> DualAdvisoryResult:
    """
    DualåŒå‘¨æœŸè¯„ä¼°ï¼šçŸ­çº¿å’Œä¸­çº¿ç‹¬ç«‹
    
    è§„åˆ™ï¼š
    - shortç¼ºæ•°æ® â†’ short=NO_TRADE + DATA_INCOMPLETE_LTF
    - mediumç¼ºæ•°æ® â†’ medium=NO_TRADE + DATA_INCOMPLETE_MTF
    - ä¸¤è€…äº’ä¸å½±å“
    """
    # âŒ é”™è¯¯ï¼šä¸€å¤„ç¼ºæ•°æ®å…¨éƒ¨è¿”å›NO_TRADE
    # if not validate_all_fields(data):
    #     return NO_TRADE, NO_TRADE
    
    # âœ… æ­£ç¡®ï¼šç‹¬ç«‹è¯„ä¼°
    short_result = self._evaluate_short_term(data)
    medium_result = self._evaluate_medium_term(data)
    
    return DualAdvisoryResult(
        short_term=short_result,
        medium_term=medium_result,
        # alignmentåŸºäºä¸¤ä¸ªç‹¬ç«‹çš„æœ‰æ•ˆç»“æœ
        alignment=self._compute_alignment(short_result, medium_result)
    )
```

### 3.2 ç¼ºå£åœºæ™¯ç¤ºä¾‹

| åœºæ™¯ | short_term | medium_term | è¯´æ˜ |
|------|-----------|-------------|------|
| **æ­£å¸¸** | LONG (HIGH) | LONG (MEDIUM) | åŒå‘åšå¤š |
| **5mç¼ºå£** | NO_TRADE (DATA_GAP_5M) | LONG (MEDIUM) | âœ… mediumæ­£å¸¸è¾“å‡º |
| **1hç¼ºå£** | LONG (HIGH) | NO_TRADE (DATA_INCOMPLETE_MTF) | âœ… shortæ­£å¸¸è¾“å‡º |
| **å…¨ç¼º** | NO_TRADE (DATA_INCOMPLETE_LTF) | NO_TRADE (DATA_INCOMPLETE_MTF) | åŒå‘æ— ä¿¡å· |

### 3.3 coverageæ£€æŸ¥ç‹¬ç«‹æ€§

```python
# âœ… æ­£ç¡®ï¼šåˆ†åˆ«æ£€æŸ¥
def _evaluate_short_term(self, data: Dict):
    if not self._check_ltf_coverage(data):
        return NO_TRADE + DATA_INCOMPLETE_LTF
    # ... æ­£å¸¸è¯„ä¼° ...

def _evaluate_medium_term(self, data: Dict):
    if not self._check_mtf_coverage(data):
        return NO_TRADE + DATA_INCOMPLETE_MTF
    # ... æ­£å¸¸è¯„ä¼° ...
```

---

## 4. é¢‘æ§ä¸ä¿¡å·é€æ˜

### 4.1 ä¿¡å·ä¸è¢«æ”¹å†™åŸåˆ™

**ç¡¬çº¦æŸ**: é¢‘ç‡æ§åˆ¶ä¸å¾—æ”¹å†™signal_decisionï¼Œåªèƒ½é˜»æ–­executableã€‚

```python
# âœ… æ­£ç¡®å®ç°ï¼ˆPR-004å·²å®Œæˆï¼Œç¡®ä¿Dualä¹Ÿéµå®ˆï¼‰
def _apply_decision_control(self, symbol, decision, reason_tags, timestamp):
    signal_decision = decision  # âœ… ä¿å­˜åŸå§‹ä¿¡å·
    
    if é¢‘æ§è§¦å‘:
        reason_tags.append(ReasonTag.MIN_INTERVAL_BLOCK)
        # decisionä¿æŒä¸å˜
        # é€šè¿‡execution_permission=DENYé˜»æ–­
    
    return decision, signal_decision, reason_tags
```

### 4.2 è¾“å‡ºå­—æ®µçº¦å®š

```python
class AdvisoryResult:
    decision: Decision              # æœ€ç»ˆå†³ç­–ï¼ˆå¯èƒ½è¢«é¢‘æ§æ”¹å†™ä¸ºNO_TRADEï¼Œæ—§é€»è¾‘ï¼‰
    signal_decision: Decision       # åŸå§‹ä¿¡å·ï¼ˆé¢‘æ§å‰çš„çœŸå®æ–¹å‘ï¼‰âœ… æ–°å¢
    execution_permission: str       # æ‰§è¡Œè®¸å¯ï¼ˆALLOW/ALLOW_REDUCED/DENYï¼‰
    reason_tags: List[ReasonTag]    # åŒ…å«MIN_INTERVAL_BLOCKç­‰
    executable: bool                # æœ€ç»ˆæ˜¯å¦å¯æ‰§è¡Œ
```

**ç”¨æˆ·å¯è§æ€§**:
```json
{
  "decision": "no_trade",
  "signal_decision": "long",  // âœ… ç”¨æˆ·çŸ¥é“çœŸå®ä¿¡å·æ˜¯LONG
  "execution_permission": "deny",
  "reason_tags": ["min_interval_block"],
  "executable": false,
  "message": "ä¿¡å·ä¸ºLONGï¼Œä½†å› é¢‘ç‡æ§åˆ¶(min_interval_block)è¢«é˜»æ–­"
}
```

---

## 5. å­—æ®µçœŸç›¸é—­ç¯

### 5.1 taker_imbalanceå­—æ®µè¿ç§»

**èƒŒæ™¯**: 
- æ—§å­—æ®µ: `buy_sell_imbalance`
- æ–°å­—æ®µ: `taker_imbalance_1h/5m/15m` ï¼ˆåŸºäºklines takerBuyï¼‰

**å…¼å®¹ç­–ç•¥**ï¼ˆP0-02å®æ–½ï¼‰:

```python
def _inject_compatibility_fields(self, data: Dict) -> Dict:
    """
    å…¼å®¹æ³¨å…¥å±‚ï¼šç»Ÿä¸€å­—æ®µè·¯å¾„
    
    è§„åˆ™ï¼š
    - ä»…åœ¨æ–°å­—æ®µç¼ºå¤±æ—¶ä»æ—§å­—æ®µæ³¨å…¥
    - æ³¨å…¥æ˜¯å•å‘çš„ï¼ˆlegacy â†’ æ–°å­—æ®µï¼‰
    - åç»­é€»è¾‘åªè¯»æ–°å­—æ®µ
    """
    # taker_imbalance_1hå…¼å®¹
    if data.get('taker_imbalance_1h') is None:
        legacy_value = data.get('buy_sell_imbalance')
        if legacy_value is not None:
            data['taker_imbalance_1h'] = legacy_value
            logger.info(
                f"Injected taker_imbalance_1h={legacy_value} "
                f"from buy_sell_imbalance (compatibility)"
            )
    
    return data
```

### 5.2 å­—æ®µè¯»å–å®¡è®¡

**ç¦æ­¢çš„è¯»å–**ï¼ˆéœ€ä»£ç å®¡è®¡æ¸…ç†ï¼‰:
```python
# âŒ ç¦æ­¢ï¼šç›´æ¥è¯»å–legacyå­—æ®µ
imbalance = data.get('buy_sell_imbalance')

# âœ… æ­£ç¡®ï¼šåªè¯»æ–°å­—æ®µ
imbalance = self._num(data, 'taker_imbalance_1h')
```

**å®¡è®¡æ¸…å•**:
- [ ] `_eval_long_direction()` - åªè¯»taker_imbalance_*
- [ ] `_eval_short_direction()` - åªè¯»taker_imbalance_*
- [ ] `_eval_trade_quality()` - åªè¯»taker_imbalance_*
- [ ] `_evaluate_short_term()` - åªè¯»taker_imbalance_5m/15m
- [ ] `_evaluate_medium_term()` - åªè¯»taker_imbalance_1h

### 5.3 å­—æ®µä¼˜å…ˆçº§

**å¤šä¸ªå­—æ®µå¯ç”¨æ—¶çš„ä¼˜å…ˆçº§**:
```python
# ä¼˜å…ˆçº§ï¼šä¸“ç”¨å­—æ®µ > å…¼å®¹æ³¨å…¥ > ç¼ºå¤±
# 1. å°è¯•è¯»å–ä¸“ç”¨å­—æ®µ
imbalance_1h = self._num(data, 'taker_imbalance_1h')

# 2. å¦‚æœç¼ºå¤±ä¸”æœ‰å…¼å®¹å­—æ®µï¼Œæ³¨å…¥
if imbalance_1h is None:
    data = self._inject_compatibility_fields(data)
    imbalance_1h = self._num(data, 'taker_imbalance_1h')

# 3. ä»ç¼ºå¤±ï¼Œæ ‡è®°DATA_INCOMPLETE
if imbalance_1h is None:
    return NO_TRADE, [DATA_INCOMPLETE_MTF]
```

---

## 6. æµ‹è¯•æ•°æ®è§„èŒƒ

### 6.1 metadataå¼ºåˆ¶è¦æ±‚

**æ‰€æœ‰æµ‹è¯•æ•°æ®å¿…é¡»åŒ…å«metadata**:

```python
# âœ… æ­£ç¡®çš„æµ‹è¯•æ•°æ®
def test_trend_long():
    data = {
        'price_change_1h': 0.03,  # å°æ•°æ ¼å¼
        'oi_change_1h': 0.06,
        'taker_imbalance_1h': 0.7,
        '_metadata': {
            'percentage_format': 'decimal'  # âœ… å¿…éœ€
        }
    }
    result = engine.on_new_tick('BTC', data)
    assert result.decision == Decision.LONG

# âŒ é”™è¯¯çš„æµ‹è¯•æ•°æ®ï¼ˆç¼ºå°‘metadataï¼‰
def test_trend_long_bad():
    data = {
        'price_change_1h': 0.03,
        # âŒ ç¼ºå°‘_metadata
    }
    # è¿™ä¸ªæµ‹è¯•åœ¨v4.0ä¼šå¤±è´¥
```

### 6.2 æµ‹è¯•metadataçš„æµ‹è¯•

å¿…é¡»æœ‰æµ‹è¯•è¦†ç›–metadataç¼ºå¤±åœºæ™¯:

```python
def test_missing_metadata_warns():
    """éªŒè¯ç¼ºå¤±metadataæ—¶çš„WARNINGè¡Œä¸ºï¼ˆv3.2ï¼‰"""
    data = {
        'price_change_1h': 3.0,  # percent_pointæ ¼å¼
        # ç¼ºå°‘_metadata
    }
    
    with pytest.warns(UserWarning, match="Missing _metadata"):
        result = engine.on_new_tick('BTC', data)
    
    # åº”è¯¥å‡è®¾ä¸ºpercent_pointå¹¶è½¬æ¢
    assert data['price_change_1h'] == 0.03  # å·²è½¬æ¢

def test_wrong_format_metadata():
    """éªŒè¯metadataä¸å®é™…æ ¼å¼ä¸ç¬¦çš„æ£€æµ‹"""
    data = {
        'price_change_1h': 3.0,  # å®é™…æ˜¯percent_point
        '_metadata': {
            'percentage_format': 'decimal'  # âŒ å£°æ˜é”™è¯¯
        }
    }
    
    # è¿™ä¼šå¯¼è‡´é˜ˆå€¼åˆ¤æ–­é”™è¯¯ï¼ˆ3.0 vs 0.05ï¼‰
    result = engine.on_new_tick('BTC', data)
    # åº”è¯¥ä¸è§¦å‘LONGï¼ˆå› ä¸º3.0è¿œå¤§äºé˜ˆå€¼0.05ï¼‰
    assert result.decision == Decision.NO_TRADE
```

### 6.3 pytesté£æ ¼å¼ºåˆ¶

**ç¦æ­¢çš„æµ‹è¯•é£æ ¼**:
```python
# âŒ ç¦æ­¢ï¼šprint + exit(1)
def test_something():
    if result != expected:
        print("FAIL")
        exit(1)  # ç ´åpytestæ”¶é›†
```

**æ­£ç¡®çš„æµ‹è¯•é£æ ¼**:
```python
# âœ… æ­£ç¡®ï¼špytest assert
def test_something():
    # Given
    data = make_test_data(metadata_format='decimal')
    
    # When
    result = engine.evaluate(data)
    
    # Then
    assert result.decision == Decision.LONG
    assert 'strong_buy_pressure' in result.reason_tags
    assert result.executable is True
```

---

## 7. å†·å¯åŠ¨åœºæ™¯

### 7.1 å†·å¯åŠ¨å®šä¹‰

**å†·å¯åŠ¨**: ç³»ç»Ÿåˆšå¯åŠ¨æˆ–Kçº¿å†å²ä¸è¶³ï¼Œå¯¼è‡´å¤šå‘¨æœŸå­—æ®µç¼ºå¤±ã€‚

**å…¸å‹åœºæ™¯**:
```python
# å¯åŠ¨åç¬¬1åˆ†é’Ÿ
data = {
    'price': 50000,
    'volume_24h': 1000,
    # âŒ ç¼ºå¤±ï¼šprice_change_5m, oi_change_15m, volume_ratio_5mç­‰
    '_metadata': {'percentage_format': 'decimal'}
}
```

### 7.2 å†·å¯åŠ¨ç­–ç•¥

```python
def handle_cold_start(data: Dict) -> AdvisoryResult:
    """
    å†·å¯åŠ¨å¤„ç†ï¼šæ˜¾æ€§æ ‡è®°ï¼Œç¦æ­¢ä¼ªä¸­æ€§
    
    è§„åˆ™ï¼š
    1. æ£€æµ‹å…³é”®å­—æ®µç¼ºå¤±
    2. æ ‡è®°DATA_INCOMPLETE_LTF/MTF
    3. è¿”å›NO_TRADEï¼Œä¸ä¼ªè£…æˆ"æ— å˜åŒ–"
    """
    ltf_complete = all([
        'price_change_5m' in data,
        'taker_imbalance_5m' in data,
        'volume_ratio_5m' in data
    ])
    
    mtf_complete = all([
        'price_change_1h' in data,
        'oi_change_1h' in data,
        'taker_imbalance_1h' in data
    ])
    
    if not ltf_complete:
        return AdvisoryResult(
            decision=Decision.NO_TRADE,
            reason_tags=[ReasonTag.DATA_INCOMPLETE_LTF],
            executable=False,
            message="Cold start: short-term data incomplete"
        )
    
    if not mtf_complete:
        return AdvisoryResult(
            decision=Decision.NO_TRADE,
            reason_tags=[ReasonTag.DATA_INCOMPLETE_MTF],
            executable=False,
            message="Cold start: medium-term data incomplete"
        )
    
    # æ•°æ®å®Œæ•´ï¼Œæ­£å¸¸è¯„ä¼°
    return evaluate_normal(data)
```

### 7.3 å†·å¯åŠ¨æŒç»­æ—¶é—´

**ä¼°ç®—**:
- 5må­—æ®µ: éœ€è¦è‡³å°‘5åˆ†é’Ÿå†å²
- 15må­—æ®µ: éœ€è¦è‡³å°‘15åˆ†é’Ÿå†å²
- 1hå­—æ®µ: éœ€è¦è‡³å°‘60åˆ†é’Ÿå†å²

**å‰ç«¯å±•ç¤º**:
```json
{
  "decision": "no_trade",
  "reason_tags": ["data_incomplete_ltf"],
  "message": "ç³»ç»Ÿå†·å¯åŠ¨ä¸­ï¼Œç­‰å¾…Kçº¿å†å²ç§¯ç´¯ï¼ˆçº¦éœ€5-15åˆ†é’Ÿï¼‰",
  "estimated_ready_time": "2026-01-23T10:15:00Z"
}
```

---

## 8. éªŒæ”¶æ ‡å‡†

### 8.1 å†·å¯åŠ¨/ç¼ºå£ä¸å‡ºç°ä¼ªä¸­æ€§

**éªŒæ”¶æ–¹æ³•**: pytestæ–­è¨€
```python
def test_cold_start_no_pseudo_neutral():
    """éªŒæ”¶ï¼šå†·å¯åŠ¨ä¸å‡ºç°ä¼ªä¸­æ€§"""
    # Given: ç¼ºå¤±æ‰€æœ‰çŸ­çº¿å­—æ®µ
    data = {
        'price': 50000,
        'volume_24h': 1000,
        '_metadata': {'percentage_format': 'decimal'}
        # ç¼ºå°‘æ‰€æœ‰_5m/_15må­—æ®µ
    }
    
    # When
    result = engine.on_new_tick('BTC', data)
    
    # Then: å¿…é¡»æ˜¾æ€§æ ‡è®°ï¼Œä¸èƒ½ä¼ªè£…æˆ"æ— å˜åŒ–"
    assert result.decision == Decision.NO_TRADE
    assert ReasonTag.DATA_INCOMPLETE_LTF in result.reason_tags
    assert result.executable is False
    
    # âŒ ç¦æ­¢çš„è¡Œä¸ºï¼šè¿”å›decisionä½†æ ‡ç­¾é‡Œæ²¡æœ‰ç¼ºå¤±è¯´æ˜
    assert not (
        result.decision != Decision.NO_TRADE and
        ReasonTag.DATA_INCOMPLETE_LTF not in result.reason_tags
    )
```

### 8.2 pytestå¯è·‘é€š

```bash
# å¿…é¡»é€šè¿‡
pytest tests/ -v --tb=short

# é¢„æœŸç»“æœ
# tests/test_p0_*.py::test_* PASSED
# ========================= XX passed in X.XXs =========================
```

### 8.3 å…¼å®¹æ³¨å…¥ç”Ÿæ•ˆ

```python
def test_compatibility_injection():
    """éªŒæ”¶ï¼šæ—§è¾“å…¥buy_sell_imbalanceå¯è§¦å‘æ–°é€»è¾‘"""
    # Given: åªæä¾›æ—§å­—æ®µ
    data = {
        'price_change_1h': 0.03,
        'oi_change_1h': 0.06,
        'buy_sell_imbalance': 0.7,  # æ—§å­—æ®µ
        # ç¼ºå°‘taker_imbalance_1h
        '_metadata': {'percentage_format': 'decimal'}
    }
    
    # When
    result = engine.on_new_tick('BTC', data)
    
    # Then: åº”è¯¥é€šè¿‡æ³¨å…¥è§¦å‘
    assert result.decision == Decision.LONG
    assert 'strong_buy_pressure' in result.reason_tags
    
    # éªŒè¯æ³¨å…¥ç¡®å®å‘ç”Ÿ
    assert 'taker_imbalance_1h' in data
    assert data['taker_imbalance_1h'] == 0.7
```

---

## 9. å‡çº§è·¯å¾„

### 9.1 v3.2 â†’ v4.0è¿ç§»

| è¡Œä¸º | v3.2ï¼ˆå½“å‰ï¼‰ | v4.0ï¼ˆè®¡åˆ’ï¼‰ |
|------|-------------|-------------|
| **ç¼ºå¤±metadata** | WARNING + å‡è®¾percent_point | ERROR + æ‹’ç»å¯åŠ¨ |
| **Noneâ†’0** | éƒ¨åˆ†å­˜åœ¨ï¼ˆå¾…æ¸…ç†ï¼‰ | å®Œå…¨ç¦æ­¢ |
| **legacyå­—æ®µ** | å…¼å®¹æ³¨å…¥ | å¼ƒç”¨ï¼ˆå¿…é¡»æä¾›æ–°å­—æ®µï¼‰ |
| **æµ‹è¯•é£æ ¼** | æ··åˆï¼ˆpytest + print/exitï¼‰ | çº¯pytest |

### 9.2 å…¼å®¹æ€§æ‰¿è¯º

**P0æ”¹è¿›ä¿è¯**:
- âœ… ä¸ç ´åç°æœ‰åŒé—¨æ§›æœºåˆ¶
- âœ… ä¸å¼•å…¥æŒä»“è¯­ä¹‰
- âœ… æ—§è¾“å…¥é€šè¿‡å…¼å®¹æ³¨å…¥ä»å¯å·¥ä½œ
- âœ… æ‰€æœ‰å˜æ›´æœ‰pytestè¦†ç›–

---

## 10. å¿«é€Ÿå‚è€ƒ

### 10.1 ç¦æ­¢æ¸…å•

| ç¦æ­¢è¡Œä¸º | åŸå›  | æ›¿ä»£æ–¹æ¡ˆ |
|---------|------|---------|
| `data.get(key, 0)` | ä¼ªä¸­æ€§ | `_num(data, key)` + Noneæ£€æŸ¥ |
| `or 0` | ä¼ªä¸­æ€§ | æ˜¾æ€§æ ‡è®°DATA_INCOMPLETE |
| `default=1.0` | ä¼ªä¸­æ€§ | Noneæ£€æŸ¥ + NO_TRADE |
| è¯»`buy_sell_imbalance` | å­—æ®µæ¼‚ç§» | è¯»`taker_imbalance_1h` |
| ç¼ºå°‘`_metadata` | å£å¾„ä¸æ˜ | å¼ºåˆ¶æ·»åŠ metadata |
| `print + exit(1)` | ç ´åCI | pytest assert |

### 10.2 å¿…éœ€æ¸…å•

| å¿…éœ€è¡Œä¸º | ä½ç½® | è¯´æ˜ |
|---------|------|------|
| None-safeè¯»å– | æ‰€æœ‰è¯„ä¼°å‡½æ•° | ä½¿ç”¨`_num()`ä¸å¸¦default |
| metadataå£°æ˜ | æ‰€æœ‰è¾“å…¥ | `percentage_format`å¿…éœ€ |
| æ˜¾æ€§æ ‡è®°ç¼ºå¤± | ç¼ºå£åœºæ™¯ | DATA_INCOMPLETE_* |
| Dualç‹¬ç«‹è¯„ä¼° | on_new_tick_dual | äº’ä¸çŸ­è·¯ |
| ä¿ç•™signal_decision | é¢‘æ§é€»è¾‘ | ä¸æ”¹å†™åŸå§‹ä¿¡å· |
| pytestæ–­è¨€ | æ‰€æœ‰æµ‹è¯• | ä¸ç”¨print/exit |

---

## é™„å½•Aï¼šReasonTagå®Œæ•´æ˜ å°„

```python
# P0-07æ–°å¢çš„æ•°æ®å®Œæ•´æ€§æ ‡ç­¾
DATA_INCOMPLETE_LTF: ExecutabilityLevel.BLOCK  # çŸ­çº¿ç¼ºæ•°æ®â†’æ‹’ç»
DATA_INCOMPLETE_MTF: ExecutabilityLevel.BLOCK  # ä¸­çº¿ç¼ºæ•°æ®â†’æ‹’ç»
DATA_GAP_5M: ExecutabilityLevel.BLOCK          # 5mç¼ºå£â†’æ‹’ç»
DATA_GAP_15M: ExecutabilityLevel.BLOCK         # 15mç¼ºå£â†’æ‹’ç»

# ç°æœ‰æ ‡ç­¾ï¼ˆä¿æŒä¸å˜ï¼‰
LIQUIDATION_PHASE: ExecutabilityLevel.BLOCK
CROWDING_RISK: ExecutabilityLevel.BLOCK
EXTREME_VOLUME: ExecutabilityLevel.BLOCK
# ... å…¶ä»–æ ‡ç­¾ ...
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**å®æ–½çŠ¶æ€**: P0-07 âœ… å®Œæˆ  
**ä¸‹ä¸€æ­¥**: P0-01ï¼ˆMedium-term None-safeé‡æ„ï¼‰  
**ç›¸å…³æ–‡æ¡£**: 
- [å¹³å°è¯¦è§£-ç´¢å¼•](å¹³å°è¯¦è§£-ç´¢å¼•.md)
- [03-å†³ç­–æœºåˆ¶è¯¦è§£](03-å†³ç­–æœºåˆ¶è¯¦è§£.md)
- [æ–°æ¶æ„å¼€å‘æŒ‡å—](../æ–°æ¶æ„å¼€å‘æŒ‡å—.md)
