# L1 Advisory Layer - 系统概述与架构

**版本**: 3.2.0  
**最后更新**: 2026-01-23  
**文档类型**: 系统概述与技术架构  

> 本文档是**平台详解3.2**的拆分文档之一，专注于系统定位、三层架构愿景、技术栈和部署架构。

---

## 📋 目录

1. [系统概述](#1-系统概述)
   - 1.1 系统定位
   - 1.2 系统边界
   - 1.3 三层架构愿景
2. [技术架构](#2-技术架构)
   - 2.1 技术栈
   - 2.2 核心模块
   - 2.3 数据流
   - 2.4 新架构模块（v2.0）
3. [部署架构](#3-部署架构)
   - 3.1 部署环境
   - 3.2 Docker部署
   - 3.3 数据持久化

---

## 1. 系统概述

### 1.1 系统定位

**L1 Advisory Layer** 是一个基于多维度市场数据的**交易决策咨询系统**，专注于为加密货币交易提供**安全、可追溯、高质量**的方向性建议。

**核心特点**：
- 🛡️ **Safety First**: 安全优先，多层闸门防护
- 🎯 **单一职责**: 仅输出方向决策（LONG/SHORT/NO_TRADE），不涉及执行
- 📊 **数据驱动**: 基于实时Binance合约市场数据
- 🔍 **可追溯性**: 每个决策都有明确的reason_tags和10步管道追溯
- ⚙️ **可配置**: 所有阈值外部化，支持热更新
- 🌐 **多币种**: 支持TA、AT、HANA、BTR、GPS、RIVER等自定义币种
- 🚀 **生产就绪**: Docker容器化部署，AWS生产环境运行
- 🎚️ **精细控制**: ExecutabilityLevel三级控制、决策频率限制、置信度混合模式

### 1.2 系统边界

**L1做什么**：
- ✅ 数据质量验证（新鲜度、规范化）
- ✅ 分析市场环境（TREND/RANGE/EXTREME）
- ✅ 评估风险准入（清算/拥挤/极端成交量）
- ✅ 评估交易质量（GOOD/UNCERTAIN/POOR）
- ✅ 判断交易方向（LONG/SHORT/NO_TRADE）
- ✅ 决策频率控制（最小间隔、翻转冷却）
- ✅ 计算置信度（ULTRA/HIGH/MEDIUM/LOW + 混合模式）
- ✅ 提供执行许可（executable标志 + 三级控制）
- ✅ 决策管道追溯（10步可视化）

**L1不做什么**：
- ❌ 不输出仓位大小
- ❌ 不输出入场点位
- ❌ 不输出止损止盈
- ❌ 不计算杠杆倍数
- ❌ 不下单执行
- ❌ 不管理持仓

### 1.3 三层架构愿景

```
┌─────────────────────────────────────────┐
│  L1 Advisory Layer (✅ v3.2完成)         │
│  - 方向决策咨询                          │
│  - 安全闸门（风险+质量）                  │
│  - 4层置信度评估 + 混合模式               │
│  - 10步决策管道 + 频率控制               │
│  - 多币种支持 + ExecutabilityLevel       │
│  - 短期机会识别（v3.2新增）              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  L2 Selection Layer (规划中)             │
│  - 自动选币                              │
│  - 候选池管理                            │
│  - 多币种排序                            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  L3 Execution Layer (规划中)             │
│  - 自动交易                              │
│  - 仓位管理                              │
│  - 风控执行                              │
└─────────────────────────────────────────┘
```

---

## 2. 技术架构

### 2.1 技术栈

| 层次 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **后端** | Python | 3.12 | 核心决策引擎 |
| | Flask | 3.0+ | Web服务框架 |
| | APScheduler | - | 定时任务、数据缓存 |
| | Watchdog | - | 配置热更新 |
| **数据库** | SQLite | - | 决策结果持久化 |
| **前端** | HTML5 + CSS3 | - | Web界面 |
| | JavaScript (Vanilla) | ES6+ | 动态交互 |
| **数据源** | Binance API | - | 合约市场数据 |
| **容器化** | Docker | - | 服务容器化 |
| | Docker Compose | - | 服务编排 |
| **部署** | AWS EC2 | - | 生产环境 |

### 2.2 核心模块（原始版本）

```
trade-info/
├── market_state_machine_l1.py    # 核心决策引擎（3486行）
│   ├── L1AdvisoryEngine          # 主引擎类
│   ├── DecisionMemory            # 决策记忆（PR-C）
│   ├── _validate_data()          # Step 1
│   ├── _detect_market_regime()   # Step 2
│   ├── _eval_risk_exposure_allowed()  # Step 3
│   ├── _eval_trade_quality()     # Step 4
│   ├── _eval_long/short_direction()   # Step 5
│   ├── _decide_priority()        # Step 6
│   ├── _apply_decision_control() # Step 7（PR-C）
│   ├── _compute_execution_permission() # Step 8（方案D）
│   ├── _compute_confidence()     # Step 9（PR-D）
│   └── _build_advisory_result()  # Step 10
│
├── models/
│   ├── __init__.py
│   ├── enums.py                  # 枚举定义
│   ├── advisory_result.py        # 决策结果数据类
│   └── reason_tags.py            # 原因标签（PR-B扩展）
│       ├── ExecutabilityLevel    # 三级控制
│       ├── ReasonTag             # 标签枚举
│       ├── REASON_TAG_EXECUTABILITY  # 映射规则
│       ├── has_blocking_tags()   # 辅助函数
│       └── has_degrading_tags()  # 辅助函数
│
├── btc_web_app_l1.py             # Flask Web服务（1116行）
├── database_l1.py                # 数据库操作（895行）
├── data_cache.py                 # 数据缓存
├── binance_data_fetcher.py       # Binance API封装
├── metrics_normalizer.py         # 指标规范化
├── logger_config.py              # 日志配置
│
├── config/
│   ├── l1_thresholds.yaml        # 配置文件（PR-D扩展）
│   └── monitored_symbols.yaml    # 监控币种配置
│
├── static/
│   ├── css/style_l1.css          # 样式
│   ├── js/app_l1.js              # 前端逻辑（原始）
│   └── js/app_l1_unified.js      # 统一前端（1140行）
│
├── templates/
│   ├── index_l1.html             # Web页面
│   └── index_l1_unified.html     # 统一页面
│
└── tests/
    ├── test_pr_b_trade_quality.py       # PR-B测试
    ├── test_pr_c_decision_control.py    # PR-C测试
    └── test_pr_d_confidence_hybrid.py   # PR-D测试
```

### 2.3 新架构模块（v2.0 模块化）

**重要说明**: 2026-01-23完成架构模块化，原始文件保留用于兼容。

```
trade-info/
├── l1_engine/                    # ✅ 核心引擎层（11个模块）
│   ├── __init__.py               # 模块导出
│   ├── data_validator.py         # 数据验证（~200行）
│   ├── regime_detector.py        # 市场环境（~100行）
│   ├── risk_gates.py             # 风险准入（~250行）
│   ├── signal_generator.py       # 信号生成（~200行）
│   ├── confidence_calculator.py  # 置信度（~250行）
│   ├── frequency_controller.py   # 频率控制（~100行）
│   ├── config_validator.py       # 配置验证（~250行）
│   ├── helper_utils.py           # 工具函数（~150行）
│   ├── memory.py                 # 决策记忆
│   └── config_manager.py         # 配置管理
│
├── api/                          # ✅ API路由层（6个模块）
│   ├── __init__.py
│   ├── l1_advisory_routes.py     # L1决策API（~150行）
│   ├── dual_advisory_routes.py   # 双周期API（~100行）
│   ├── history_routes.py         # 历史查询API（~200行）
│   ├── config_routes.py          # 配置管理API（~150行）
│   └── market_routes.py          # 市场信息API（~50行）
│
├── services/                     # ✅ 业务服务层（3个模块）
│   ├── __init__.py
│   ├── scheduler_service.py      # 定时任务（~200行）
│   └── config_watcher_service.py # 配置监控（~100行）
│
├── database/                     # ✅ 数据访问层（6个模块）
│   ├── __init__.py
│   ├── connection.py             # 连接管理（~100行）
│   ├── advisory_repository.py    # 单周期数据（~250行）
│   ├── dual_advisory_repository.py  # 双周期数据（~180行）
│   ├── pipeline_repository.py    # 管道数据（~150行）
│   └── migrations.py             # 数据库迁移（~200行）
│
├── static/js/modules/            # ✅ 前端功能模块（4个）
│   ├── api_client.js             # API调用（~150行）
│   ├── dual_decision.js          # 决策渲染（~300行）
│   ├── signal_notification.js    # 信号通知（~250行）
│   └── history_manager.js        # 历史管理（~200行）
│
├── static/js/utils/              # ✅ 前端工具库（2个）
│   ├── formatters.js             # 格式化（~100行）
│   └── constants.js              # 常量定义（~50行）
│
├── btc_web_app_l1_modular.py     # ✅ 模块化Flask入口
└── static/js/app_l1_unified_modular.js  # ✅ 模块化前端入口
```

**架构优化成果**:
- ✅ 巨型文件消除: 4个 → 0个 (100%)
- ✅ 最大文件精简: 3,486行 → 300行 (91.4%↓)
- ✅ 新增模块: 32个精简模块
- ✅ 向后兼容: 100%保证

### 2.4 数据流

```
┌─────────────┐
│ Binance API │
└──────┬──────┘
       │ 原始市场数据
       ↓
┌─────────────┐
│ DataCache   │ ← 定时刷新（60s）
└──────┬──────┘
       │ 规范化数据
       ↓
┌──────────────────┐
│ L1AdvisoryEngine │ ← 10步决策管道
└──────┬───────────┘
       │ AdvisoryResult
       ↓
┌──────────────┐
│ L1Database   │ ← 持久化（24h热存储）
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ Flask API    │ ← /api/l1/advisory/{symbol}
└──────┬───────┘
       │ JSON
       ↓
┌──────────────┐
│ Web Frontend │ ← 实时展示
└──────────────┘
```

---

## 3. 部署架构

### 3.1 部署环境

| 环境 | 地址 | 状态 | 用途 |
|------|------|------|------|
| **本地开发** | localhost:5001 | 按需启动 | 开发调试、测试 |
| **AWS生产** | 43.212.176.169:8001 | 持续运行 | 生产服务 |

### 3.2 Docker部署

#### 本地部署

```bash
# 使用模块化版本（推荐）
python btc_web_app_l1_modular.py

# 或使用Docker
./docker-l1-run.sh

# 停止服务
./docker-l1-stop.sh

# 查看日志
docker logs -f l1-advisory-layer

# 重启服务
docker compose -f docker-compose-l1.yml restart
```

#### AWS部署

```bash
# 同步代码
rsync -avz --exclude 'data/db/*.db' \
  -e "ssh -i ../john-test.pem" \
  ./ ubuntu@43.212.176.169:~/trade-info-l1/

# SSH登录
ssh -i ../john-test.pem ubuntu@43.212.176.169

# 部署服务
cd ~/trade-info-l1
docker compose -f docker-compose-l1.yml down
docker compose -f docker-compose-l1.yml build
docker compose -f docker-compose-l1.yml up -d

# 查看状态
docker ps
docker logs -f l1-advisory-layer
```

### 3.3 数据持久化

```
./data/db/
├── l1_advisory_results.db    # 决策结果数据库
└── l1_advisory_results.db-wal  # WAL日志

./config/
├── l1_thresholds.yaml        # 配置文件（热更新）
└── monitored_symbols.yaml    # 监控币种配置
```

---

## 📌 相关文档

- **[02-版本演进与功能.md](02-版本演进与功能.md)** - 版本历史、核心功能列表
- **[03-决策机制详解.md](03-决策机制详解.md)** - PR-A/B/C/D详细说明
- **[04-决策管道.md](04-决策管道.md)** - 10步决策流程
- **[05-配置管理.md](05-配置管理.md)** - 完整配置文件说明
- **[06-界面与API.md](06-界面与API.md)** - Web界面和API接口
- **[07-测试与使用.md](07-测试与使用.md)** - 测试覆盖和使用指南
- **[08-附录.md](08-附录.md)** - 枚举定义、ReasonTag列表

---

**Trade-Info L1 Advisory Layer v3.2 - 更智能、更安全、更可控的交易决策咨询系统！** 🚀

**架构版本**: v2.0 Modular（2026-01-23）  
**文档版本**: 3.2.0  
**最后更新**: 2026-01-23  
