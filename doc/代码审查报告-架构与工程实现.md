# ä»£ç å®¡æŸ¥æŠ¥å‘Šï¼šæ¶æ„ã€é€»è¾‘ä¸å·¥ç¨‹å®ç°åˆ†æ

ç”Ÿæˆæ—¶é—´ï¼š2026-01-23  
ä»£ç ç‰ˆæœ¬ï¼šHEAD 390cbeeï¼ˆå•å‘¨æœŸæ¸…ç†å®Œæˆåï¼‰  
å®¡æŸ¥èŒƒå›´ï¼šL1å†³ç­–å¼•æ“å…¨æ ˆ

---

## ğŸ¯ å®¡æŸ¥æ€»ç»“

### æ•´ä½“è¯„ä»·

âœ… **æ¶æ„ä¼˜åŠ¿**ï¼š
- æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆFeatureBuilderã€DecisionCoreã€DecisionGateï¼‰
- çº¯å‡½æ•°è®¾è®¡æé«˜å¯æµ‹è¯•æ€§
- å¼ºç±»å‹é…ç½®æå‡å®‰å…¨æ€§
- None-safeè®¾è®¡é¿å…å´©æºƒ

âš ï¸  **ä¸»è¦é—®é¢˜**ï¼š
1. **æ¶æ„ä¸ä¸€è‡´**ï¼šæ–°æ—§æ¶æ„æ··ç”¨ï¼Œè½¬æ¢å±‚å¤æ‚
2. **é€»è¾‘æ¼æ´**ï¼šåŒå‘¨æœŸå†³ç­–ä¸ç‹¬ç«‹ï¼ŒçŸ­æœŸ/ä¸­æœŸä½¿ç”¨ç›¸åŒé€»è¾‘
3. **å·¥ç¨‹å€ºåŠ¡**ï¼šTODOè¿‡å¤šï¼Œç¡¬ç¼–ç é˜ˆå€¼ï¼Œé”™è¯¯å¤„ç†ä¸å®Œå–„
4. **æ€§èƒ½éšæ‚£**ï¼šé¢‘ç¹å¼‚å¸¸æ•è·ï¼Œå¤šæ¬¡data_cacheæŸ¥è¯¢

---

## ğŸ“‹ é—®é¢˜æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### P0çº§é—®é¢˜ï¼ˆå¿…é¡»ç«‹å³è§£å†³ï¼‰

#### ğŸ”´ 1. åŒå‘¨æœŸå†³ç­–ä¸çœŸæ­£ç‹¬ç«‹

**é—®é¢˜**ï¼š`DecisionCore.evaluate_dual`è°ƒç”¨ä¸¤æ¬¡ç›¸åŒçš„`evaluate_single`ï¼ŒçŸ­æœŸå’Œä¸­æœŸä½¿ç”¨å®Œå…¨ç›¸åŒçš„é€»è¾‘ã€‚

**ä»£ç ä½ç½®**ï¼š
```python
# l1_engine/decision_core.py:163-164
short_draft = DecisionCore.evaluate_single(features, thresholds, symbol)
medium_draft = DecisionCore.evaluate_single(features, thresholds, symbol)
```

**å½±å“**ï¼š
- åŒå‘¨æœŸå†³ç­–å¤±å»æ„ä¹‰ï¼ˆç»“æœç›¸åŒï¼‰
- æ— æ³•å®ç°"çŸ­æœŸæ¿€è¿›ï¼Œä¸­æœŸä¿å®ˆ"çš„ç­–ç•¥å·®å¼‚

**ä¿®å¤å»ºè®®**ï¼š
```python
# æ‰©å±•evaluate_singleï¼Œæ·»åŠ timeframeå‚æ•°
@staticmethod
def evaluate_single(
    features: FeatureSnapshot,
    thresholds: Thresholds,
    timeframe: Timeframe,  # æ–°å¢
    symbol: str = "UNKNOWN"
) -> TimeframeDecisionDraft:
    # æ ¹æ®timeframeé€‰æ‹©ä¸åŒçš„é˜ˆå€¼é…ç½®
    if timeframe == Timeframe.SHORT_TERM:
        # ä½¿ç”¨çŸ­æœŸé˜ˆå€¼ï¼ˆæ›´å®½æ¾ï¼Œæ•è·çŸ­æœŸæœºä¼šï¼‰
        direction_thresholds = thresholds.direction.short_term
    else:
        # ä½¿ç”¨ä¸­æœŸé˜ˆå€¼ï¼ˆæ›´ä¿å®ˆï¼Œç¡®è®¤è¶‹åŠ¿ï¼‰
        direction_thresholds = thresholds.direction.medium_term
```

---

#### ğŸ”´ 2. FeatureBuilderæœªéªŒè¯å¿…éœ€å­—æ®µ

**é—®é¢˜**ï¼š`FeatureBuilder.build`å¯èƒ½è¿”å›`price=None`çš„ç‰¹å¾ï¼ŒDecisionCoreæ— æ³•æ­£å¸¸å·¥ä½œã€‚

**ä»£ç ä½ç½®**ï¼š
```python
# l1_engine/feature_builder.py:84
features = self._extract_features(normalized_data)
# æœªéªŒè¯features.price.current_priceæ˜¯å¦ä¸ºNone
```

**å½±å“**ï¼š
- DecisionCoreéœ€è¦å¤§é‡Noneæ£€æŸ¥
- å¯èƒ½äº§ç”Ÿæ— æ„ä¹‰çš„å†³ç­–æˆ–å´©æºƒ

**ä¿®å¤å»ºè®®**ï¼š
```python
def build(self, symbol: str, raw_data: Dict, data_cache=None) -> FeatureSnapshot:
    # ... ç°æœ‰é€»è¾‘ ...
    features = self._extract_features(normalized_data)
    
    # âœ… éªŒè¯å¿…éœ€å­—æ®µ
    if features.price.current_price is None:
        logger.error(f"[{symbol}] Missing required field: current_price")
        return create_empty_snapshot(symbol, ReasonTag.INVALID_DATA)
    
    if features.volume.volume_24h is None:
        logger.error(f"[{symbol}] Missing required field: volume_24h")
        return create_empty_snapshot(symbol, ReasonTag.INVALID_DATA)
    
    return FeatureSnapshot(...)
```

---

#### ğŸ”´ 3. DecisionCoreæ ¸å¿ƒé€»è¾‘ç¼ºå°‘å•æµ‹

**é—®é¢˜**ï¼šDecisionCoreè®¾è®¡ä¸ºçº¯å‡½æ•°ï¼ˆå¯æµ‹è¯•ï¼‰ï¼Œä½†æ²¡æœ‰é…å¥—å•æµ‹ï¼Œå¤æ‚é€»è¾‘æœªéªŒè¯ã€‚

**å½±å“**ï¼šè´¨é‡é£é™©é«˜ï¼Œé‡æ„å›°éš¾ï¼ŒBUGéšæ‚£å¤š

**ä¿®å¤å»ºè®®**ï¼š
åˆ›å»º`tests/test_decision_core.py`ï¼Œè¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š
- å¸‚åœºç¯å¢ƒè¯†åˆ«ï¼ˆEXTREME/TREND/RANGEï¼‰
- é£é™©å‡†å…¥è¯„ä¼°ï¼ˆæ¸…ç®—/æ‹¥æŒ¤/æç«¯æˆäº¤é‡ï¼‰
- äº¤æ˜“è´¨é‡è¯„ä¼°ï¼ˆå¸çº³/å™ªéŸ³/è½®åŠ¨/å¼±ä¿¡å·ï¼‰
- æ–¹å‘è¯„ä¼°ï¼ˆLONG/SHORTæ¡ä»¶ï¼‰
- é¢‘ç‡æ§åˆ¶é€»è¾‘ï¼ˆå†·å´æœŸ/æœ€å°é—´éš”/æ–¹å‘ç¿»è½¬ï¼‰

---

### P1çº§é—®é¢˜ï¼ˆé‡è¦ï¼‰

#### âš ï¸  4. æ–¹å‘è¯„ä¼°é˜ˆå€¼ç¡¬ç¼–ç 

**é—®é¢˜**ï¼š
```python
# l1_engine/decision_core.py:486-489
long_imbalance_trend = 0.6  # TODO: thresholds.direction.long_imbalance_trend
long_oi_change_trend = 0.3  # TODO: thresholds.direction.long_oi_change_trend
```

**å½±å“**ï¼šæ— æ³•å¿«é€Ÿè°ƒå‚ï¼Œè¿å"é…ç½®é©±åŠ¨"åŸåˆ™

**ä¿®å¤æ­¥éª¤**ï¼š
1. æ‰©å±•`models/thresholds.py`æ·»åŠ `DirectionThresholds`
2. æ›´æ–°`config/l1_thresholds.yaml`æ·»åŠ é…ç½®
3. ç§»é™¤ç¡¬ç¼–ç ï¼Œä»`thresholds.direction`è¯»å–

---

#### âš ï¸  5. èµ„é‡‘è´¹ç‡é™çº§é€»è¾‘æœªå®ç°

**é—®é¢˜**ï¼š`_apply_funding_rate_downgrade`æ ‡è®°ä¸ºTODOï¼Œä¸æ‰§è¡Œä»»ä½•é™çº§ã€‚

**å½±å“**ï¼šé«˜è´¹ç‡ç¯å¢ƒä¸‹é£é™©æš´éœ²

**ä¿®å¤å»ºè®®**ï¼š
```python
@staticmethod
def _apply_funding_rate_downgrade(
    decision: Decision,
    features: FeatureSnapshot,
    thresholds: Thresholds
) -> Tuple[Decision, List[ReasonTag]]:
    tags = []
    funding_rate = features.features.funding.funding_rate
    
    if funding_rate is None:
        return decision, tags
    
    high_threshold = thresholds.funding_downgrade.high_threshold
    
    # LONGæ—¶è´¹ç‡è¿‡é«˜ï¼Œé™çº§ä¸ºNO_TRADE
    if decision == Decision.LONG and funding_rate > high_threshold:
        tags.append(ReasonTag.HIGH_FUNDING_RATE)
        return Decision.NO_TRADE, tags
    
    # SHORTæ—¶è´¹ç‡è¿‡ä½ï¼ˆè´Ÿå€¼è¿‡å¤§ï¼‰ï¼Œé™çº§ä¸ºNO_TRADE
    if decision == Decision.SHORT and funding_rate < -high_threshold:
        tags.append(ReasonTag.HIGH_FUNDING_RATE)
        return Decision.NO_TRADE, tags
    
    return decision, tags
```

---

#### âš ï¸  6. é¢‘æ§é˜»æ–­åçŠ¶æ€æœªæ›´æ–°ï¼Œå¯èƒ½æ°¸ä¹…é˜»æ–­

**é—®é¢˜**ï¼š
```python
# l1_engine/decision_gate.py:104-106
if executable and draft.decision in [Decision.LONG, Decision.SHORT]:
    self.state_store.save_decision_state(symbol, now, draft.decision)
    # âŒ å¦‚æœä¸executableï¼ŒçŠ¶æ€ä¸æ›´æ–°ï¼Œå¯èƒ½æ°¸ä¹…å†·å´
```

**å½±å“**ï¼šå¯èƒ½é™·å…¥"æ°¸ä¹…å†·å´"

**ä¿®å¤å»ºè®®**ï¼š
```python
# æ–¹æ¡ˆ1ï¼šè¢«é˜»æ–­æ—¶ä¹Ÿæ›´æ–°æ£€æŸ¥æ—¶é—´
if freq_control.is_blocked:
    self.state_store.save_last_check_time(symbol, now)

# æ–¹æ¡ˆ2ï¼šå†·å´æœŸè¶…æ—¶è‡ªåŠ¨æ¸…é™¤
if time_since_last > cooling_period * 2:
    self.state_store.clear(symbol)
    logger.warning(f"[{symbol}] Auto-clear stale state")
```

---

#### âš ï¸  7. å¼‚å¸¸å¤„ç†è¿‡äºç²—æš´

**é—®é¢˜**ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½è¿”å›NO_TRADEï¼Œæ— æ³•åŒºåˆ†"æ•°æ®ç¼ºå¤±"vs"ä»£ç BUG"

**ä¿®å¤å»ºè®®**ï¼š
```python
try:
    feature_snapshot = self.feature_builder.build(symbol, data, data_cache=data_cache)
except DataInsufficientError as e:  # âœ… é¢„æœŸå¼‚å¸¸
    logger.warning(f"[{symbol}] Insufficient data: {e}")
    return self._build_dual_no_trade_result(...)
except Exception as e:  # âŒ éé¢„æœŸå¼‚å¸¸
    logger.error(f"[{symbol}] Unexpected error: {e}", exc_info=True)
    raise  # é‡æ–°æŠ›å‡ºï¼Œè§¦å‘ç›‘æ§å‘Šè­¦
```

---

### P2çº§é—®é¢˜ï¼ˆä¼˜åŒ–ï¼‰

#### âš ï¸  8. æ–°æ—§æ¶æ„æ··ç”¨å¯¼è‡´å¤æ‚æ€§çˆ†ç‚¸

**é—®é¢˜**ï¼š`_convert_final_to_result`è½¬æ¢å±‚é•¿è¾¾150è¡Œ

**å»ºè®®**ï¼š
- çŸ­æœŸï¼šä¿æŒç°çŠ¶ï¼Œæ·»åŠ å•æµ‹
- ä¸­æœŸï¼šç»Ÿä¸€ä¸ºDecisionCoreçš„DTOï¼Œåˆ é™¤è½¬æ¢å±‚

---

#### âš ï¸  9. ç½®ä¿¡åº¦è®¡ç®—è¿‡äºç®€åŒ–

**é—®é¢˜**ï¼š
```python
# l1_engine/decision_core.py:754-768
if quality == TradeQuality.GOOD and regime == MarketRegime.TREND:
    return Confidence.HIGH  # è¿‡äºç®€å•
```

**å»ºè®®**ï¼šå®ç°åŸºäºç§¯åˆ†çš„PR-Dæ··åˆæ¨¡å¼

---

#### âš ï¸  10. TODOæ³¨é‡Šè¿‡å¤šï¼ˆ40+å¤„ï¼‰

**ç»Ÿè®¡**ï¼š
- `l1_engine/decision_core.py`: 18ä¸ªTODO
- `market_state_machine_l1.py`: 12ä¸ªTODO
- `l1_engine/feature_builder.py`: 8ä¸ªTODO

**å»ºè®®**ï¼š
1. åˆ†çº§TODOï¼šP0ï¼ˆå¿…é¡»ï¼‰ã€P1ï¼ˆé‡è¦ï¼‰ã€P2ï¼ˆä¼˜åŒ–ï¼‰
2. è½¬æ¢ä¸ºIssuesè¿½è¸ª
3. å®šæœŸreviewæ¸…ç†

---

## ğŸ”§ å…¶ä»–å‘ç°

### æ€§èƒ½é—®é¢˜

1. **å¤šæ¬¡æŸ¥è¯¢data_cache**ï¼š`_on_new_tick_dual_new_arch`è°ƒç”¨`get_cache()`ï¼ŒFeatureBuilderå†…éƒ¨å¯èƒ½å†æ¬¡æŸ¥è¯¢
2. **DualTimeframeStateStoreå†…å­˜å ç”¨**ï¼šæ¯ä¸ªsymbolä¿å­˜4ä¸ªdictï¼Œæ— è¿‡æœŸæ¸…ç†

### æ•°æ®ä¸€è‡´æ€§é—®é¢˜

1. **FeatureSnapshotä¸åŸå§‹dataä¸ä¸€è‡´**ï¼šè§„èŒƒåŒ–åå¯èƒ½æœ‰ä¸¤ç§è¡¨ç¤ºï¼ˆ0.05 vs 5ï¼‰
2. **æ—¶é—´æˆ³ä¸ç»Ÿä¸€**ï¼š`DecisionGate.apply`ä½¿ç”¨`datetime.now()`ï¼Œå›æµ‹æ— æ³•æ³¨å…¥å†å²æ—¶é—´

### æ—¥å¿—é—®é¢˜

1. **æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“**ï¼šå…³é”®ä¿¡æ¯ç”¨`debug`çº§åˆ«ï¼Œç”Ÿäº§ç¯å¢ƒå¯èƒ½ä¸¢å¤±
2. **æ—¥å¿—è¿‡å¤š**ï¼šæ¯æ¬¡tickæ‰“å°å¤§é‡INFOæ—¥å¿—

---

## ğŸ’¡ åç»­è¡ŒåŠ¨å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. âœ… **è¡¥å……å•æµ‹**ï¼šDecisionCore + DecisionGateæ ¸å¿ƒé€»è¾‘
2. âœ… **å®ç°èµ„é‡‘è´¹ç‡é™çº§**ï¼šæ·»åŠ thresholdsé…ç½®å¹¶å®ç°é€»è¾‘
3. âœ… **ä¿®å¤åŒå‘¨æœŸç‹¬ç«‹æ€§**ï¼šæ·»åŠ timeframeå‚æ•°åŒºåˆ†çŸ­æœŸ/ä¸­æœŸ

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

4. âœ… **æ–¹å‘é˜ˆå€¼é…ç½®åŒ–**ï¼šæ‰©å±•thresholds.pyï¼Œç§»é™¤ç¡¬ç¼–ç 
5. âœ… **ä¼˜åŒ–å¼‚å¸¸å¤„ç†**ï¼šåŒºåˆ†é¢„æœŸ/éé¢„æœŸå¼‚å¸¸
6. âœ… **å®Œå–„æ—¥å¿—ç­–ç•¥**ï¼šé‡æ–°è¯„ä¼°æ—¥å¿—çº§åˆ«

### é•¿æœŸï¼ˆ2-3ä¸ªæœˆï¼‰

7. âœ… **ç»Ÿä¸€æ¶æ„**ï¼šåˆ é™¤è½¬æ¢å±‚ï¼Œå…¨é¢ä½¿ç”¨DecisionCore DTO
8. âœ… **å®ç°PR-Dç½®ä¿¡åº¦**ï¼šåŸºäºç§¯åˆ†çš„æ··åˆæ¨¡å¼
9. âœ… **æ·»åŠ æ€§èƒ½ç›‘æ§**ï¼šè¿½è¸ªå†³ç­–å»¶è¿Ÿã€å†…å­˜å ç”¨

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- PR-ARCH-01: FeatureBuilderå•å…¥å£
- PR-ARCH-02: DecisionCore + DecisionGate
- PR-ARCH-03: å¼ºç±»å‹é…ç½®
- PATCH-P0-01: å­—æ®µåˆ†çº§æ£€æŸ¥
- PATCH-P0-02: None-safeå…¨é“¾è·¯

---

**å®¡æŸ¥äººå‘˜**ï¼šAI Code Reviewer  
**å®¡æŸ¥æ–¹å¼**ï¼šé™æ€ä»£ç åˆ†æ + æ¶æ„å®¡æŸ¥  
**å®¡æŸ¥æ—¶é•¿**ï¼šå…¨æ ˆæ·±åº¦å®¡æŸ¥
