# 邮件报警配置说明

## 功能说明

系统已集成价格监控和邮件报警功能：
- **监控周期**：每10秒检查一次价格变化
- **报警条件**：1分钟内涨跌幅超过 ±5%
- **报警邮箱**：johntmp2026@outlook.com
- **冷却时间**：同一币种/市场类型5分钟内只报警一次

## 邮件配置步骤

### 1. 获取Outlook应用密码

由于安全原因，Outlook不能直接使用账号密码发送邮件，需要生成应用密码：

1. 访问 https://account.microsoft.com/security
2. 登录您的 johntmp2026@outlook.com 账户
3. 找到"应用密码"选项
4. 点击"创建新的应用密码"
5. 复制生成的16位应用密码（例如：xxxx xxxx xxxx xxxx）

### 2. 配置应用密码

打开文件 `btc_web_app_multi.py`，找到第437行左右的 `EmailAlert` 类：

```python
class EmailAlert:
    """邮件报警类"""
    def __init__(self, smtp_server='smtp-mail.outlook.com', smtp_port=587):
        self.smtp_server = smtp_server
        self.smtp_port = smtp_port
        self.sender_email = 'johntmp2026@outlook.com'
        self.sender_password = ''  # ← 在这里填入应用密码
        self.receiver_email = 'johntmp2026@outlook.com'
```

将 `self.sender_password = ''` 改为：

```python
self.sender_password = 'your_app_password_here'  # 替换为您的16位应用密码
```

### 3. 重新构建并启动

```bash
# 停止当前容器
docker stop trade-info-app
docker rm trade-info-app

# 重新构建镜像
docker build -t trade-info:latest .

# 启动容器
docker run -d --name trade-info-app -p 5001:5001 \
  -v "$(pwd)/btc_market_data:/app/btc_market_data" \
  -e TZ=Asia/Shanghai \
  --restart unless-stopped \
  trade-info:latest
```

或使用便捷脚本：
```bash
./docker-stop.sh
./docker-build.sh
./docker-run.sh
```

## 测试邮件功能

配置完成后，您可以通过以下方式测试：

1. 等待监控到价格异常波动（1分钟内涨跌幅>5%）
2. 查看容器日志确认报警触发：
   ```bash
   docker logs -f trade-info-app
   ```
3. 检查邮箱是否收到报警邮件

## 报警邮件内容示例

邮件将包含：
- 📧 **主题**：⚠️ [币种] [现货/合约]价格异常波动 📈/📉
- 📊 **内容**：
  - 币种名称
  - 市场类型（现货/合约）
  - 1分钟前价格
  - 当前价格
  - 涨跌幅百分比
  - 报警时间

## 注意事项

1. **未配置密码时**：系统会在控制台显示报警信息，但不会发送邮件
2. **冷却机制**：同一币种/市场5分钟内只会发送一次报警邮件
3. **网络要求**：需要容器能够访问 smtp-mail.outlook.com (端口587)
4. **安全建议**：
   - 不要将应用密码提交到版本控制系统
   - 定期更换应用密码
   - 仅用于邮件发送，不要用于其他服务

## 修改报警参数

如需调整报警参数，可修改 `btc_web_app_multi.py` 中的以下配置：

```python
# 第681行：创建价格监控实例
price_monitor = PriceMonitor(market_api, email_alert, check_interval=10)
#                                                      ↑ 检查间隔（秒）

# 第599行：报警阈值
if abs(change_percent) >= 5.0:  # ← 修改这个值（百分比）
    ...

# 第601行：冷却时间
if current_time - self.alert_cooldown.get(key, 0) > 300:  # ← 秒数（300=5分钟）
    ...
```

## 故障排查

### 邮件发送失败

1. 检查应用密码是否正确
2. 确认网络连接正常
3. 查看容器日志：`docker logs trade-info-app`
4. 验证Outlook账户状态正常

### 未收到报警

1. 检查是否满足报警条件（1分钟内涨跌幅>5%）
2. 确认是否在冷却期内（5分钟）
3. 检查垃圾邮件文件夹
4. 查看控制台日志确认监控是否正常工作

## 支持

如有问题，请查看：
- 容器日志：`docker logs -f trade-info-app`
- 应用日志输出（控制台）
- Binance API状态
